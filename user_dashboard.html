<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Dashboard</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

  <!-- Firebase App (required) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }

    body {
      display: flex;
      height: 100vh;
      background-color: #f2f2f2;
      overflow: hidden;
    }

    .sidebar {
      position: fixed;
      height: 100vh;
      width: 250px;
      background-color: #1c1c64;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 20px 0;
    }

    .sidebar h3 {
      text-align: center;
      margin-bottom: 20px;
      padding: 0 10px;
      font-size: 25px;
    }

    .menu {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding: 0 10px;
      gap: 10px;
    }
    .menu a.active {
  background-color: #da471f !important;
}

    .menu a, .dropdown-btn {
      color: white;
      text-decoration: none;
      padding: 15px;
      cursor: pointer;
      font-size: 18px;
      border-radius: 10px;
      background-color: #1c1c64;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
      text-align: center;
      transition: background-color 0.3s ease;
    }

    .menu a:hover, .dropdown-btn:hover {
      background-color: #da471f;
    }

    .dropdown-container {
      display: none;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }

    .dropdown-container a {
      font-size: 16px;
      padding: 12px;
      background-color: #1c1c64;
      color: white;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
    }

    .dropdown-container a:hover {
      background-color: #da471f;
    }

    .logout-btn {
      margin-top: auto;
      padding: 12px;
      background-color: red;
      color: white;
      border: none;
      cursor: pointer;
      margin: 20px;
      border-radius: 10px;
      font-size: 16px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
    }

    .logout-btn:hover {
      background-color: #e04a22;
    }

    .main-content {
      margin-left: 250px; /* Same as sidebar width */
      width: calc(100% - 250px);
      flex-grow: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .updates-section {
      background-color: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .updates-section h3 {
      margin-bottom: 10px;
      color: #1c1c64;
    }

    .updates-content {
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .top-bar h2 {
      font-weight: bold;
      font-size: 24px;
    }

    .icons {
      display: flex;
      align-items: center;
      gap: 20px;
      position: relative;
    }

    .search-container {
      display: flex;
      align-items: center;
      background-color: white;
      border-radius: 30px;
      padding: 8px 15px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      width: 300px;
    }

    .search-container input {
      border: none;
      outline: none;
      flex-grow: 1;
      padding: 8px;
      font-size: 14px;
    }

    .search-container i {
      color: #6f6f6f;
      margin-right: 8px;
    }

    .icon-btn {
      font-size: 20px;
      color: #333;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .icon-btn:hover {
      color: #da471f;
    }

    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .stat-box {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      flex: 1 1 200px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .project-assignment {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .table-wrapper {
      overflow-x: auto;
  -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
  width: 100%;
    }

    table {
      min-width: 1000px;
      width: 100%;
      border-collapse: collapse;
      white-space: nowrap;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
  position: sticky;
  top: 0;
  background-color: white;
  z-index: 10;
}

    /* Notification Popup Styles */
    .notification-popup {
      position: absolute;
      top: 50px;
      right: 0;
      width: 350px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: none;
      flex-direction: column;
      max-height: 500px;
    }

    .notification-popup.active {
      display: flex;
    }

    .notification-header {
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notification-header h3 {
      font-size: 18px;
      color: #333;
    }

    .notification-filter-buttons {
      display: flex;
      border-bottom: 1px solid #eee;
    }

    .notification-filter-btn {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      font-weight: bold;
      color: #666;
      transition: all 0.3s ease;
      position: relative;
    }

    .notification-filter-btn.active {
      color: #1c1c64;
    }

    .notification-filter-btn.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 100%;
      height: 3px;
      background-color: #1c1c64;
    }

    .notification-content {
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }

    .notification-item {
      padding: 15px;
      padding-left: 30px;
      border-bottom: 1px solid #eee;
      transition: background-color 0.3s ease;
      position: relative;
      background-color: white;
    }

    .notification-item.unread {
      background-color: #f5f5f5;
    }

    .notification-item:hover {
      background-color: #f9f9f9;
    }

    .notification-item.unread::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 10px;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      background-color: #da471f;
      border-radius: 50%;
    }

    .notification-title {
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
      padding-right: 15px;
    }

    .notification-message {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
      padding-right: 15px;
    }

    .notification-time {
      font-size: 12px;
      color: #999;
      text-align: right;
    }

    .notification-empty {
      padding: 20px;
      text-align: center;
      color: #999;
      font-style: italic;
    }

    .notification-indicator {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 18px;
      height: 18px;
      background-color: #da471f;
      color: white;
      border-radius: 50%;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .bell-icon-container {
      position: relative;
    }
    
    .notification-actions {
      display: flex;
      justify-content: space-between;
      padding: 10px 15px;
      border-top: 1px solid #eee;
    }
    
    .notification-action-btn {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 13px;
      transition: color 0.3s ease;
    }
    
    .notification-action-btn:hover {
      color: #da471f;
    }

    /* Contract ID link styles */
    .contract-id-link {
      color: #1c1c64;
      text-decoration: none;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .contract-id-link:hover {
      color: #da471f;
      text-decoration: underline;
    }

  /* Add this to your existing CSS */
@keyframes highlight-blink {
  0% { background-color: #606088; }
  50% { background-color: rgba(96, 96, 136, 0.5); }
  100% { background-color: #606088; }
}

.highlight-blink {
  animation: highlight-blink 1s ease 3;
}
.project-tabs {
  display: flex;
  margin-bottom: 15px;
  border-bottom: 1px solid #ddd;
}

.project-tab {
  padding: 10px 20px;
  background: none;
  border: none;
  border-bottom: 3px solid transparent;
  cursor: pointer;
  font-weight: bold;
  color: #666;
  transition: all 0.3s ease;
}

.project-tab.active {
  color: #1c1c64;
  border-bottom-color: #1c1c64;
}

.project-tab:hover:not(.active) {
  color: #da471f;
  border-bottom-color: #da471f;
}
  </style>
</head>
<body>
  <div class="sidebar">
    <div>
      <h3>QUALITY<br>ASSURANCE<br>SECTION</h3>
      <div class="menu">
        <a href="user_dashboard.html">Dashboard</a>
        <a href="my_projects.html">My Projects</a>
        <a href="shared_project.html">Shared Projects</a>
        <a href="files_user.html">Files</a>
      </div>
    </div>
    <button class="logout-btn" id="logout-btn">LOG OUT</button>
  </div>

  <div class="main-content">
    <div class="top-bar">
      <h2 id="welcome-text">Welcome!</h2>
      <div class="icons">
        <div class="search-container">
          <i class="fas fa-search"></i>
          <input type="text" id="searchInput" placeholder="Search projects...">
        </div>
        <i class="fas fa-filter icon-btn" title="Filter"></i>
        <div class="bell-icon-container">
          <i class="fas fa-bell icon-btn" title="Notifications" id="notification-btn"></i>
          <div class="notification-indicator" id="notification-indicator" style="display: none;">0</div>
        </div>
        
        <!-- Notification Popup -->
        <div class="notification-popup" id="notification-popup">
          <div class="notification-header">
            <h3>Notifications</h3>
            <i class="fas fa-times" id="close-notification"></i>
          </div>
          <div class="notification-filter-buttons">
            <div class="notification-filter-btn active" data-filter="all">All</div>
            <div class="notification-filter-btn" data-filter="unread">Unread</div>
          </div>
          <div class="notification-content" id="notification-content">
            <div class="notification-empty">No notifications</div>
          </div>
          <div class="notification-actions">
            <button class="notification-action-btn" id="mark-all-read">Mark All as Read</button>
          </div>
        </div>
      </div>
    </div>

    <div class="stats">
      <div class="stat-box">
        <div>TOTAL PROJECT</div>
        <div id="total-projects" style="color: blue; font-size: 24px;">0</div>
      </div>
      <div class="stat-box">
        <div>IN PROGRESS</div>
        <div id="in-progress" style="color: orange; font-size: 24px;">0</div>
      </div>
      <div class="stat-box">
        <div>ACCOMPLISHED</div>
        <div id="accomplished" style="color: green; font-size: 24px;">0</div>
      </div>
    </div>

    <div class="project-assignment">
      <div class="project-tabs">
        <button class="project-tab active" data-tab="assigned">My Assigned Projects</button>
        <button class="project-tab" data-tab="shared">Shared With Me</button>
      </div>
      <div class="table-wrapper">
        <table id="assigned-projects-table">
          <thead>
            <tr>
              <th>Contract ID</th>
              <th>Contract Name</th>
              <th>Contractor</th>
              <th>Cost</th>
              <th>Status</th>
              <th>Remarks</th>
            </tr>
          </thead>
          <tbody id="assigned-projects-body">
            <tr>
              <td colspan="6" style="text-align: center; color: #888;">Loading assigned projects...</td>
            </tr>
          </tbody>
        </table>
        
        <table id="shared-projects-table" style="display: none;">
          <thead>
            <tr>
              <th>Contract ID</th>
              <th>Contract Name</th>
              <th>Shared By</th>
              <th>Shared At</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="shared-projects-body">
            <tr>
              <td colspan="5" style="text-align: center; color: #888;">Loading shared projects...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Audio element for notification sound -->
  <audio id="notification-sound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" type="audio/mpeg">
  </audio>

  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDuxUQaXiWorKsz1wlpCmho2u9OQq2bAnE",
      authDomain: "qas-section.firebaseapp.com",
      databaseURL: "https://qas-section-default-rtdb.firebaseio.com/",
      projectId: "qas-section",
      storageBucket: "qas-section.firebasestorage.app",
      messagingSenderId: "76857155340",
      appId: "1:76857155340:web:8b497e036eb55c33607329"
    };
  
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
  
    document.querySelector('.logout-btn').addEventListener('click', function () {
      auth.signOut().then(() => {
        window.location.href = "index.html";
      }).catch((error) => {
        console.error("Error signing out:", error);
      });
    });
  
    // Function to update the project table and statistics
    function updateProjects(projects) {
      const projectTableBody = document.getElementById('assigned-projects-body');
      
      projectTableBody.innerHTML = "";
      
      if (projects && Object.keys(projects).length > 0) {
        Object.entries(projects).forEach(([key, contract]) => {
          const row = document.createElement("tr");
          row.innerHTML = `
           <td><a href="my_projects.html?highlight=${contract.contractId || ''}" class="contract-id-link">${contract.contractId || ''}</a></td>
            <td>${contract.contractName || ''}</td>
            <td>${contract.contractor || ''}</td>
            <td>${contract.contractAmount || ''}</td>
            <td>${contract.projectStatus || ''}</td>
            <td>${contract.remarks || ''}</td>
          `;
          projectTableBody.appendChild(row);
        });
      } else {
        projectTableBody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; color: #888;">No projects assigned</td>
          </tr>
        `;
      }
    }

    // NEW: Function to update shared projects table
    function updateSharedProjects(sharedProjects) {
  const sharedProjectsBody = document.getElementById('shared-projects-body');
  
  sharedProjectsBody.innerHTML = "";
  
  if (sharedProjects && Object.keys(sharedProjects).length > 0) {
    Object.entries(sharedProjects).forEach(([key, project]) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><a href="shared_project.html?highlight=${encodeURIComponent(project.contractId || '')}" class="contract-id-link">${project.contractId || ''}</a></td>
        <td>${project.contractName || ''}</td>
        <td>${project.sharedBy || ''}</td>
        <td>${formatTimeDifference(new Date(project.sharedAt))}</td>
        <td>
          <i class="fas fa-eye action-icon" title="View" onclick="window.location.href='shared_project.html?highlight=${encodeURIComponent(project.contractId || '')}'"></i>
        </td>
      `;
      sharedProjectsBody.appendChild(row);
    });
  } else {
    sharedProjectsBody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align: center; color: #888;">No shared projects</td>
      </tr>
    `;
  }
}
    // NEW: Function to update all statistics
    function updateAllStatistics(assignedProjects, sharedProjects) {
      const totalAssigned = assignedProjects ? Object.keys(assignedProjects).length : 0;
      const totalShared = sharedProjects ? Object.keys(sharedProjects).length : 0;
      
      document.getElementById('total-projects').textContent = totalAssigned + totalShared;
      
      // Calculate in-progress and accomplished from assigned projects only
      let inProgressCount = 0;
      let accomplishedCount = 0;
      
      if (assignedProjects) {
        Object.values(assignedProjects).forEach(project => {
          if (project.projectStatus === "In Progress") {
            inProgressCount++;
          } else if (project.projectStatus === "Accomplished") {
            accomplishedCount++;
          }
        });
      }
      
      document.getElementById('in-progress').textContent = inProgressCount;
      document.getElementById('accomplished').textContent = accomplishedCount;
    }
    
    // Function to filter projects based on search input
    function filterProjects(searchTerm) {
      const projects = JSON.parse(localStorage.getItem('currentProjects')) || {};
      const projectTableBody = document.getElementById('assigned-projects-body');
      
      if (!searchTerm) {
        updateProjects(projects);
        return;
      }
      
      const filteredProjects = {};
      const lowerSearchTerm = searchTerm.toLowerCase();
      
      Object.entries(projects).forEach(([key, contract]) => {
        const contractId = (contract.contractId || '').toLowerCase();
        const contractName = (contract.contractName || '').toLowerCase();
        const contractor = (contract.contractor || '').toLowerCase();
        
        if (contractId.includes(lowerSearchTerm) || 
            contractName.includes(lowerSearchTerm) || 
            contractor.includes(lowerSearchTerm)) {
          filteredProjects[key] = contract;
        }
      });
      
      projectTableBody.innerHTML = "";
      
      if (Object.keys(filteredProjects).length > 0) {
        Object.entries(filteredProjects).forEach(([key, contract]) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td><a href="my_projects.html?highlight=${contract.contractId || ''}" class="contract-id-link">${contract.contractId || ''}</a></td>
            <td>${contract.contractName || ''}</td>
            <td>${contract.contractor || ''}</td>
            <td>${contract.contractAmount || ''}</td>
            <td>${contract.status || ''}</td>
            <td>${contract.remarks || ''}</td>
          `;
          projectTableBody.appendChild(row);
        });
      } else {
        projectTableBody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; color: #888;">No matching projects found</td>
          </tr>
        `;
      }
    }
  
    // Function to format time difference
    function formatTimeDifference(timestamp) {
      if (!timestamp) return "Just now";
      
      let notificationTime;
      if (typeof timestamp === 'object' && timestamp.hasOwnProperty('seconds')) {
        notificationTime = new Date(timestamp.seconds * 1000);
      } else if (typeof timestamp === 'number') {
        notificationTime = new Date(timestamp);
      } else if (timestamp instanceof Date) {
        notificationTime = timestamp;
      } else {
        return "Just now";
      }
      
      const now = new Date();
      const diffInSeconds = Math.floor((now - notificationTime) / 1000);
      
      if (diffInSeconds < 60) {
        return `${diffInSeconds} second${diffInSeconds !== 1 ? 's' : ''} ago`;
      }
      
      const diffInMinutes = Math.floor(diffInSeconds / 60);
      if (diffInMinutes < 60) {
        return `${diffInMinutes} minute${diffInMinutes !== 1 ? 's' : ''} ago`;
      }
      
      const diffInHours = Math.floor(diffInMinutes / 60);
      if (diffInHours < 24) {
        return `${diffInHours} hour${diffInHours !== 1 ? 's' : ''} ago`;
      }
      
      const diffInDays = Math.floor(diffInHours / 24);
      return `${diffInDays} day${diffInDays !== 1 ? 's' : ''} ago`;
    }
    
    // Function to sort notifications by timestamp
    function sortNotificationsByTime(notifications) {
      return notifications.sort((a, b) => {
        const timeA = a.timestamp?.seconds ? a.timestamp.seconds * 1000 : a.timestamp || 0;
        const timeB = b.timestamp?.seconds ? b.timestamp.seconds * 1000 : b.timestamp || 0;
        return timeB - timeA;
      });
    }
    
    // Function to play notification sound
    function playNotificationSound() {
      const notificationSound = document.getElementById('notification-sound');
      notificationSound.currentTime = 0;
      notificationSound.play().catch(e => console.log("Audio play failed:", e));
    }
    
    // Function to detect contract changes
    function detectContractChanges(oldContract, newContract) {
      const changes = [];
      
      if (oldContract.contractId !== newContract.contractId) {
        changes.push(`Contract ID changed from "${oldContract.contractId}" to "${newContract.contractId}"`);
      }
      
      if (oldContract.contractName !== newContract.contractName) {
        changes.push(`Contract Name changed from "${oldContract.contractName}" to "${newContract.contractName}"`);
      }
      
      if (oldContract.contractor !== newContract.contractor) {
        changes.push(`Contractor changed from "${oldContract.contractor}" to "${newContract.contractor}"`);
      }
      
      if (oldContract.contractAmount !== newContract.contractAmount) {
        changes.push(`Contract amount changed from "${oldContract.contractAmount}" to "${newContract.contractAmount}"`);
      }
      
      if (oldContract.status !== newContract.status) {
        changes.push(`Status changed from "${oldContract.status}" to "${newContract.status}"`);
      }
      
      return changes.length > 0 ? changes.join(', ') : null;
    }
    
    // Function to update notifications
    function updateNotifications(contracts) {
      const notificationContent = document.getElementById('notification-content');
      notificationContent.innerHTML = '<div class="notification-empty">No notifications</div>';
      
      let unreadCount = 0;
      let allNotifications = [];
      let hasNewNotifications = false;
      
      if (contracts && Object.keys(contracts).length > 0) {
        Object.entries(contracts).forEach(([key, contract]) => {
          if (contract.assignmentTimestamp) {
            const assignmentId = `assignment-${key}-${contract.assignmentTimestamp.seconds || contract.assignmentTimestamp}`;
            const isRead = localStorage.getItem(`read-notification-${assignmentId}`) === 'true';
            if (!isRead) {
              unreadCount++;
              const notificationTime = contract.assignmentTimestamp?.seconds ? contract.assignmentTimestamp.seconds * 1000 : contract.assignmentTimestamp;
              if (notificationTime > lastNotificationCheck) {
                hasNewNotifications = true;
              }
            }
            
            allNotifications.push({
              type: 'assignment',
              id: assignmentId,
              title: `New Project Assignment`,
              message: `You have been assigned to a new project. Contract ID: ${contract.contractId || 'N/A'}`,
              timestamp: contract.assignmentTimestamp,
              contractId: contract.contractId,
              read: isRead,
              contractKey: key
            });
          }
          
          if (contract.updateTimestamp && contract.lastUpdateChanges) {
            const updateId = `update-${key}-${contract.updateTimestamp.seconds || contract.updateTimestamp}`;
            const isRead = localStorage.getItem(`read-notification-${updateId}`) === 'true';
            if (!isRead) {
              unreadCount++;
              const notificationTime = contract.updateTimestamp?.seconds ? contract.updateTimestamp.seconds * 1000 : contract.updateTimestamp;
              if (notificationTime > lastNotificationCheck) {
                hasNewNotifications = true;
              }
            }
            
            allNotifications.push({
              type: 'update',
              id: updateId,
              title: `Update on Contract ${contract.contractId || 'N/A'}`,
              message: contract.lastUpdateChanges,
              timestamp: contract.updateTimestamp,
              contractId: contract.contractId,
              read: isRead,
              contractKey: key
            });
          }
          
          if (contract.remarks && contract.remarks.trim() !== '' && contract.remarkTimestamp) {
            const remarkId = `remark-${key}-${contract.remarkTimestamp.seconds || contract.remarkTimestamp}`;
            const isRead = localStorage.getItem(`read-notification-${remarkId}`) === 'true';
            if (!isRead) {
              unreadCount++;
              const notificationTime = contract.remarkTimestamp?.seconds ? contract.remarkTimestamp.seconds * 1000 : contract.remarkTimestamp;
              if (notificationTime > lastNotificationCheck) {
                hasNewNotifications = true;
              }
            }
            
            allNotifications.push({
              type: 'remark',
              id: remarkId,
              title: `New Remark on ${contract.contractId || 'Project'}`,
              message: contract.remarks,
              timestamp: contract.remarkTimestamp,
              contractId: contract.contractId,
              read: isRead,
              contractKey: key
            });
          }
          
          if (contract.status && contract.statusTimestamp) {
            const statusId = `status-${key}-${contract.statusTimestamp.seconds || contract.statusTimestamp}`;
            const isRead = localStorage.getItem(`read-notification-${statusId}`) === 'true';
            if (!isRead) {
              unreadCount++;
              const notificationTime = contract.statusTimestamp?.seconds ? contract.statusTimestamp.seconds * 1000 : contract.statusTimestamp;
              if (notificationTime > lastNotificationCheck) {
                hasNewNotifications = true;
              }
            }
            
            allNotifications.push({
              type: 'status',
              id: statusId,
              title: `Contract Status Update`,
              message: `${contract.contractId || 'Project'} status changed to ${contract.status}`,
              timestamp: contract.statusTimestamp,
              contractId: contract.contractId,
              read: isRead,
              contractKey: key
            });
          }
        });
      }
      
      if (hasNewNotifications) {
        playNotificationSound();
      }
      
      allNotifications = sortNotificationsByTime(allNotifications);
      localStorage.setItem('notifications', JSON.stringify(allNotifications));
      
      if (allNotifications.length > 0) {
        notificationContent.innerHTML = '';
        allNotifications.forEach(notification => {
          const notificationItem = document.createElement('div');
          notificationItem.className = `notification-item ${notification.read ? '' : 'unread'}`;
          notificationItem.dataset.id = notification.id;
          notificationItem.dataset.type = notification.type;
          
          notificationItem.innerHTML = `
            <div class="notification-title">${notification.title}</div>
            <div class="notification-message">${notification.message}</div>
            <div class="notification-time">${formatTimeDifference(notification.timestamp)}</div>
          `;
          
          notificationItem.addEventListener('click', function() {
            if (!notification.read) {
              markNotificationAsRead(notification);
              this.classList.remove('unread');
              this.style.backgroundColor = 'white';
            }
          });
          
          notificationContent.appendChild(notificationItem);
        });
      }
      
      updateNotificationIndicator(unreadCount);
      applyNotificationFilter('all');
      lastNotificationCheck = Date.now();
    }
    
    // Function to update notification indicator
    function updateNotificationIndicator(count) {
      const indicator = document.getElementById('notification-indicator');
      if (count > 0) {
        indicator.textContent = count;
        indicator.style.display = 'flex';
      } else {
        indicator.style.display = 'none';
      }
    }
    
    // Function to mark notification as read
    function markNotificationAsRead(notification) {
      notification.read = true;
      localStorage.setItem(`read-notification-${notification.id}`, 'true');
      
      const indicator = document.getElementById('notification-indicator');
      if (indicator.textContent > 0) {
        const newCount = parseInt(indicator.textContent) - 1;
        updateNotificationIndicator(newCount);
      }
      
      const storedNotifications = JSON.parse(localStorage.getItem('notifications')) || [];
      const updatedNotifications = storedNotifications.map(n => {
        if (n.id === notification.id) {
          return {...n, read: true};
        }
        return n;
      });
      localStorage.setItem('notifications', JSON.stringify(updatedNotifications));
    }
    
    // Function to mark all notifications as read
    function markAllNotificationsAsRead() {
      const storedNotifications = JSON.parse(localStorage.getItem('notifications')) || [];
      
      storedNotifications.forEach(notification => {
        localStorage.setItem(`read-notification-${notification.id}`, 'true');
      });
      
      document.querySelectorAll('.notification-item.unread').forEach(item => {
        item.classList.remove('unread');
        item.style.backgroundColor = 'white';
      });
      
      updateNotificationIndicator(0);
    }
    
    // Function to apply notification filter
    function applyNotificationFilter(filterType) {
      const notificationItems = document.querySelectorAll('.notification-item');
      const emptyMessage = document.querySelector('.notification-empty');
      let hasVisibleItems = false;
      
      notificationItems.forEach(item => {
        const isUnread = item.classList.contains('unread');
        
        if (filterType === 'all') {
          item.style.display = 'block';
          hasVisibleItems = true;
        } else if (filterType === 'unread') {
          if (isUnread) {
            item.style.display = 'block';
            hasVisibleItems = true;
          } else {
            item.style.display = 'none';
          }
        }
      });
      
      if (emptyMessage) {
        if (hasVisibleItems || notificationItems.length === 0) {
          emptyMessage.style.display = 'none';
        } else {
          emptyMessage.style.display = 'block';
          emptyMessage.textContent = filterType === 'unread' ? 'No unread notifications' : 'No notifications';
        }
      }
    }

    // NEW: Function to setup project tabs
    function setupProjectTabs() {
      const tabs = document.querySelectorAll('.project-tab');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          // Remove active class from all tabs
          tabs.forEach(t => t.classList.remove('active'));
          
          // Add active class to clicked tab
          this.classList.add('active');
          
          // Show the corresponding table
          const tabType = this.getAttribute('data-tab');
          document.getElementById('assigned-projects-table').style.display = 
            tabType === 'assigned' ? 'table' : 'none';
          document.getElementById('shared-projects-table').style.display = 
            tabType === 'shared' ? 'table' : 'none';
        });
      });
    }

    function highlightCurrentPage() {
      const currentPage = window.location.pathname.split('/').pop() || 'user_dashboard.html';
      const menuLinks = document.querySelectorAll('.menu a');
      
      menuLinks.forEach(link => {
        const linkPage = link.getAttribute('href');
        if (linkPage === currentPage) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
    }
  
    // Notification functionality
    document.addEventListener('DOMContentLoaded', function() {
      highlightCurrentPage();
      setupProjectTabs(); // Initialize tabs
      
      const notificationBtn = document.getElementById('notification-btn');
      const notificationPopup = document.getElementById('notification-popup');
      const closeNotification = document.getElementById('close-notification');
      const filterButtons = document.querySelectorAll('.notification-filter-btn');
      const markAllReadBtn = document.getElementById('mark-all-read');
      
      notificationBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        notificationPopup.classList.toggle('active');
      });
      
      closeNotification.addEventListener('click', function(e) {
        e.stopPropagation();
        notificationPopup.classList.remove('active');
      });
      
      document.addEventListener('click', function(e) {
        if (!notificationPopup.contains(e.target) && e.target !== notificationBtn) {
          notificationPopup.classList.remove('active');
        }
      });
      
      filterButtons.forEach(button => {
        button.addEventListener('click', function() {
          const filterType = this.getAttribute('data-filter');
          
          filterButtons.forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          
          applyNotificationFilter(filterType);
        });
      });
      
      markAllReadBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        markAllNotificationsAsRead();
      });
      
      const searchInput = document.getElementById('searchInput');
      let searchTimeout;
      
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          filterProjects(this.value.trim());
        }, 300);
      });
      
      document.querySelector('.search-container i').addEventListener('click', function() {
        if (searchInput.value.trim()) {
          searchInput.value = '';
          filterProjects('');
        }
      });
    });
  
    let lastNotificationCheck = localStorage.getItem('lastNotificationCheck') || 0;
    let currentUserName = '';
    let previousContracts = {};
    
    auth.onAuthStateChanged((user) => {
      const welcomeText = document.getElementById('welcome-text');
      
      if (user) {
        const uid = user.uid;
        
        database.ref('users').orderByChild('uid').equalTo(uid).once('value')
          .then((snapshot) => {
            if (snapshot.exists()) {
              const userData = Object.values(snapshot.val())[0];
              welcomeText.innerText = `Welcome ${userData.firstName}!`;
              
              currentUserName = userData.firstName + " " + userData.lastName;
              
              // Load assigned projects (QA in-charge)
              database.ref('contracts').orderByChild('personnel/qaInCharge/name').equalTo(currentUserName)
                .on('value', (assignedSnapshot) => {
                  const assignedProjects = assignedSnapshot.val();
                  previousContracts = assignedProjects ? {...assignedProjects} : {};
                  
                  // Load shared projects (from userContracts)
                  database.ref(`userContracts/${uid}`).on('value', (sharedSnapshot) => {
                    const sharedProjects = sharedSnapshot.val();
                    
                    updateAllStatistics(assignedProjects, sharedProjects);
                    updateProjects(assignedProjects);
                    updateSharedProjects(sharedProjects);
                    updateNotifications(assignedProjects);
                    
                    // Store current projects for search functionality
                    localStorage.setItem('currentProjects', JSON.stringify(assignedProjects || {}));
                  });
                });
              
              database.ref('contracts').orderByChild('personnel/qaInCharge/name').equalTo(currentUserName)
                .on('child_added', (snapshot) => {
                  const newContract = snapshot.val();
                  if (newContract && !newContract.assignmentTimestamp) {
                    database.ref(`contracts/${snapshot.key}`).update({
                      assignmentTimestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                  }
                });
              
              database.ref('contracts').orderByChild('personnel/qaInCharge/name').equalTo(currentUserName)
                .on('child_changed', (snapshot) => {
                  const changedContract = snapshot.val();
                  const changedFields = [];
                  
                  snapshot.forEach((childSnapshot) => {
                    changedFields.push(childSnapshot.key);
                  });
                  
                  if (changedFields.includes('status') && !changedFields.includes('statusTimestamp')) {
                    database.ref(`contracts/${snapshot.key}`).update({
                      statusTimestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                  }
                  
                  if (changedFields.includes('remarks') && !changedFields.includes('remarkTimestamp')) {
                    database.ref(`contracts/${snapshot.key}`).update({
                      remarkTimestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                  }
                });
            } else {
              console.warn("User not found");
              welcomeText.innerText = 'Welcome User!';
            }
          })
          .catch((error) => {
            console.error("Error fetching user data:", error);
            welcomeText.innerText = 'Welcome!';
          });
      } else {
        welcomeText.innerText = 'Welcome Guest!';
      }
    });
</script>
</body>
</html>