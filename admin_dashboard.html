<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', Arial, sans-serif;
        }
        body {
            display: flex;
            min-height: 100vh;
            background-color: #f8fafc;
        }
        .sidebar {
            width: 250px;
            background-color: #1c1c64;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            position: fixed;
            height: 100%;
            top: 0;
            bottom: 0;
            justify-content: space-between;
        }
        .sidebar h3 {
            text-align: center;
            margin-bottom: 20px;
            padding: 0 10px;
            font-size: 25px;
        }
        .menu {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            padding: 0 10px;
            gap: 10px;
        }
        .menu a, .dropdown-btn {
            color: white;
            text-decoration: none;
            padding: 15px;
            cursor: pointer;
            font-size: 18px;
            border-radius: 10px;
            background-color: #1c1c64;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            text-align: center;
            transition: background-color 0.3s ease;
        }
        .menu a:hover, .dropdown-btn:hover {
            background-color: #da471f;
        }
        .dropdown-container {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        .dropdown-container a {
            font-size: 16px;
            padding: 12px;
            background-color: #1c1c64;
            color: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }
        .dropdown-container a:hover {
            background-color: #da471f;
        }
        .logout-container {
            padding: 0 20px 20px;
        }
        .logout-btn {
            width: 85%;
            padding: 12px;
            background-color: #ff5c33;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 10px;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            margin-left: 17px;
            margin-bottom: 15px;
        }
        .logout-btn:hover {
            background-color: #e04a22;
        }
        .main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-x: auto;
            margin-left: 250px;
        }
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .dashboard-title {
            font-weight: 600;
            font-size: 24px;
            color: #1e293b;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-box {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            flex: 1;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            height: 80px;
        }
        .stat-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .stat-box div:first-child {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 10px;
            font-weight: 500;
        }
        .stat-box div:nth-child(2) {
            font-size: 24px;
            font-weight: 600;
        }
        .project-assignment-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }
        .project-assignment-header {
            padding: 18px 25px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8fafc;
            flex-wrap: wrap;
            gap: 15px;
        }
        .project-assignment-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }
        .search-container {
            position: relative;
            min-width: 250px;
            flex: 1;
            max-width: 400px;
        }
        .search-input {
            width: 100%;
            padding: 8px 15px 8px 35px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }
        .project-assignment-content {
            overflow-x: auto;
            max-height: 410px;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 1200px;
        }
        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th {
            padding: 12px 15px;
            text-align: left;
            background-color: #f1f5f9;
            color: #475569;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
        }
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
            color: #334155;
            font-size: 13px;
        }
        tbody tr {
            transition: background-color 0.2s ease;
        }
        tbody tr:hover {
            background-color: #f8fafc;
        }
        .status-cell {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }
        .status-in-progress {
            background-color: #fef3c7;
            color: #92400e;
        }
        .status-accomplished {
            background-color: #d1fae5;
            color: #065f46;
        }
        .remarks-cell {
            max-width: 300px;
            min-width: 200px;
            position: relative;
        }
        .remarks-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 60px;
            overflow: hidden;
            transition: max-height 0.3s ease;
            line-height: 1.4;
            display: block;
        }
        .remarks-cell:hover .remarks-content {
            max-height: 500px;
            overflow-y: auto;
            background-color: white;
            z-index: 10;
            position: relative;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 8px;
            border-radius: 4px;
            margin: -8px;
        }
        .edit-remarks-btn {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 12px;
            font-weight: 500;
            transition: background-color 0.2s ease;
            white-space: nowrap;
        }
        .edit-remarks-btn:hover {
            background-color: #2563eb;
        }
        .remarks-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 13px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
            resize: vertical;
            min-height: 60px;
            white-space: pre-wrap;
        }
        .remarks-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .save-remarks-btn {
            background-color: #10b981;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 8px;
            font-size: 12px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        .save-remarks-btn:hover {
            background-color: #059669;
        }
        .cancel-remarks-btn {
            background-color: #ef4444;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 8px;
            font-size: 12px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        .cancel-remarks-btn:hover {
            background-color: #dc2626;
        }
        .timestamp {
            font-size: 11px;
            color: #94a3b8;
            display: block;
            margin-top: 3px;
        }
        .empty-state {
            padding: 40px 20px;
            text-align: center;
            color: #64748b;
        }
        .loading-state {
            padding: 40px 20px;
            text-align: center;
            color: #64748b;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        /* Notification styles */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .notification-icon {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #1c1c64;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff5c33;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .notification-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            overflow: hidden;
            display: none;
            z-index: 1000;
        }
        
        .notification-panel.active {
            display: block;
        }
        
        .notification-header {
            padding: 15px;
            background-color: #1c1c64;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notification-header h3 {
            margin: 0;
            font-size: 16px;
        }
        
        .clear-notifications {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        
        .notification-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-item {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .notification-item:hover {
            background-color: #f8fafc;
        }
        
        .notification-message {
            margin-bottom: 5px;
            line-height: 1.4;
        }
        
        .notification-time {
            font-size: 12px;
            color: #64748b;
        }
        
        .no-notifications {
            padding: 20px;
            text-align: center;
            color: #64748b;
            font-size: 14px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .stats {
                flex-direction: column;
            }
        }
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                padding: 20px 15px;
            }
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 100;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .project-assignment-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .search-container {
                width: 100%;
                max-width: none;
            }
            .notification-panel {
                width: 300px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div>
            <h3>QUALITY<br>ASSURANCE<br>SECTION</h3>
            <div class="menu">
                <a href="admin_dashboard.html" class="active">Dashboard</a>
                <a href="user_list.html">Users</a>
                <a href="info.html">Contract Information</a>
                <a href="files.html">Files</a>
                <a href="FDT.html">FDT Scheduler</a>
                <a href="others.html">Others</a>
            </div>
        </div>
        <button class="logout-btn">LOG OUT</button>
    </div>
    
    <!-- Notification Icon -->
    <div class="notification-icon" id="notificationIcon">
        <i class="fas fa-bell"></i>
        <div class="notification-badge" id="notificationBadge" style="display: none;">0</div>
    </div>
    
    <!-- Notification Panel -->
    <div class="notification-panel" id="notificationPanel">
        <div class="notification-header">
            <h3>Notifications</h3>
            <button class="clear-notifications" id="clearNotifications">Clear All</button>
        </div>
        <div class="notification-list" id="notificationList">
            <div class="no-notifications">No new notifications</div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Project Assignment</h1>
        </div>
        <div class="stats">
            <div class="stat-box">
                <div>Total Projects</div>
                <div style="color: #3b82f6;">0</div>
            </div>
            <div class="stat-box">
                <div>In Progress</div>
                <div style="color: #f59e0b;">0</div>
            </div>
            <div class="stat-box">
                <div>Accomplished</div>
                <div style="color: #10b981;">0</div>
            </div>
        </div>
        <div class="project-assignment-container">
            <div class="project-assignment-header">
                <h3>Project Assignments</h3>
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Search projects..." id="searchInput">
                </div>
            </div>
            <div class="project-assignment-content">
                <table>
                    <thead>
                        <tr>
                            <th>In-Charge</th>
                            <th>Contract ID</th>
                            <th>Status</th>
                            <th>Contractor's ME</th>
                            <th>Project Engineer</th>
                            <th>Materials Engineer</th>
                            <th>Project Inspector</th>
                            <th>Resident Engineer</th>
                            <th>Provisional ME</th>
                            <th>Provisional Inspector</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody id="projectsTableBody">
                        <tr>
                            <td colspan="11" class="loading-state">Loading project assignments...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDuxUQaXiWorKsz1wlpCmho2u9OQq2bAnE",
            authDomain: "qas-section.firebaseapp.com",
            databaseURL: "https://qas-section-default-rtdb.firebaseio.com",
            projectId: "qas-section",
            storageBucket: "qas-section.appspot.com",
            messagingSenderId: "76857155340",
            appId: "1:76857155340:web:8b497e036eb55c33607329"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const contractsRef = database.ref('contracts');
        const usersRef = database.ref('users');
        const notificationsRef = database.ref('notifications');

        // Global variables
        let allContracts = {};
        let currentUser = null;
        let notifications = [];
        let notificationIds = new Set();

        // Load contracts from Firebase
        function loadProjects() {
            contractsRef.on('value', (contractsSnapshot) => {
                allContracts = contractsSnapshot.val() || {};
                renderProjects(allContracts);
                updateProjectStats(allContracts);
            });
        }

        // Initialize notification system
        function initNotificationSystem() {
            // Toggle notification panel
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationPanel = document.getElementById('notificationPanel');
            
            notificationIcon.addEventListener('click', () => {
                notificationPanel.classList.toggle('active');
                if (notificationPanel.classList.contains('active')) {
                    markNotificationsAsRead();
                }
            });
            
            // Clear notifications button
            document.getElementById('clearNotifications').addEventListener('click', clearAllNotifications);
            
            // Load existing notifications
            loadExistingNotifications();
            
            // Listen for new notifications
            notificationsRef.orderByChild('timestamp').on('child_added', (snapshot) => {
                const notification = snapshot.val();
                if (!notificationIds.has(notification.id)) {
                    notificationIds.add(notification.id);
                    notifications.unshift(notification);
                    updateNotificationUI();
                }
            });
            
            // Close panel when clicking outside
            document.addEventListener('click', (e) => {
                if (!notificationIcon.contains(e.target) && !notificationPanel.contains(e.target)) {
                    notificationPanel.classList.remove('active');
                }
            });
        }
        
        // Load existing notifications without duplicates
        function loadExistingNotifications() {
            notificationsRef.orderByChild('timestamp').once('value', (snapshot) => {
                const notificationsData = snapshot.val() || {};
                notifications = [];
                notificationIds.clear();
                
                // Convert to array and sort by timestamp (newest first)
                Object.values(notificationsData).forEach(notification => {
                    notificationIds.add(notification.id);
                    notifications.unshift(notification);
                });
                
                // Sort notifications by timestamp (newest first)
                notifications.sort((a, b) => b.timestamp - a.timestamp);
                updateNotificationUI();
            });
        }
        
        // Update notification UI
        function updateNotificationUI() {
            const notificationList = document.getElementById('notificationList');
            const notificationBadge = document.getElementById('notificationBadge');
            
            // Filter unread notifications
            const unreadNotifications = notifications.filter(n => !n.read);
            
            // Update badge
            notificationBadge.textContent = unreadNotifications.length;
            notificationBadge.style.display = unreadNotifications.length > 0 ? 'flex' : 'none';
            
            // Update notification list
            notificationList.innerHTML = notifications.length === 0 
                ? '<div class="no-notifications">No new notifications</div>'
                : notifications.map(notification => `
                    <div class="notification-item" style="${!notification.read ? 'background-color: #f0f7ff' : ''}">
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-time">${formatNotificationTime(notification.timestamp)}</div>
                    </div>
                `).join('');
        }
        
        // Format notification time
        function formatNotificationTime(timestamp) {
            const now = new Date();
            const notificationDate = new Date(timestamp);
            const diffInSeconds = Math.floor((now - notificationDate) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
            }
            if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
            }
            return notificationDate.toLocaleString();
        }
        
        // Mark notifications as read
        function markNotificationsAsRead() {
            const updates = {};
            notifications.forEach((notification, index) => {
                if (!notification.read) {
                    updates[`notifications/${notification.id}/read`] = true;
                    notifications[index].read = true;
                }
            });
            
            if (Object.keys(updates).length > 0) {
                database.ref().update(updates).then(() => {
                    updateNotificationUI();
                });
            }
        }
        
        // Clear all notifications
        function clearAllNotifications() {
            notificationsRef.remove().then(() => {
                notifications = [];
                notificationIds.clear();
                updateNotificationUI();
            });
        }
        
       // Enhanced notification creation function
function createContractNotification(contractId, action, field = '', newValue = '', oldValue = '') {
    let message = '';
    const contractDisplayId = contractId || 'N/A';
    
    // Field name to human-readable label mapping
    const fieldLabels = {
        'contractId': 'Contract ID',
        'contractName': 'Contract Name',
        'contractAmount': 'Contract Amount',
        'contractDuration': 'Contract Duration',
        'projectStatus': 'Project Status',
        'remarks': 'Remarks',
        'assignmentTimestamp': 'Assignment Date',
        'updateTimestamp': 'Update Timestamp',
        'CQCAmonthly': 'Monthly CQCA',
        'CQCAweekly': 'Weekly CQCA',
        'QCPoriginal': 'Original QCP',
        'QCPrevised': 'Revised QCP',
        'asBuiltPlan': 'As-Built Plan',
        'asStakedPlan': 'As-Staked Plan',
        'concreteWorksReport': 'Concrete Works Report',
        'concretingReport': 'Concreting Report',
        'trialMix': 'Trial Mix',
        'approvedBudgetCost': 'Approved Budget Cost',
        'appropriation': 'Appropriation',
        'personnel.qaInCharge': 'QA In-Charge',
        'personnel.contractorsMaterialsEngineer': 'Contractor\'s ME',
        'personnel.projectEngineer': 'Project Engineer',
        'personnel.materialsEngineer': 'Materials Engineer',
        'personnel.projectInspector': 'Project Inspector',
        'personnel.residentEngineer': 'Resident Engineer',
        'personnel.provisionalMaterialsEngineer': 'Provisional ME',
        'personnel.provisionalMaterialsInspector': 'Provisional Inspector'
    };
    
    if (action === 'added') {
        message = `New contract added: ${contractDisplayId}`;
    } 
    else if (action === 'updated') {
        const fieldLabel = fieldLabels[field] || field;
        
        if (field === 'projectStatus') {
            message = `Status changed for ${contractDisplayId}: ${oldValue || 'N/A'} → ${newValue}`;
        }
        else if (field === 'remarks') {
            const shortRemarks = newValue.length > 30 ? newValue.substring(0, 30) + '...' : newValue;
            message = `Remarks updated for ${contractDisplayId}: "${shortRemarks}"`;
        }
        else if (field.startsWith('personnel.')) {
            message = `Personnel change for ${contractDisplayId}: ${fieldLabel} changed from ${oldValue || 'N/A'} to ${newValue || 'removed'}`;
        }
        else if (field === 'contractAmount' || field === 'approvedBudgetCost' || field === 'appropriation') {
            message = `${fieldLabel} updated for ${contractDisplayId}: ${oldValue || 'N/A'} → ${newValue}`;
        }
        else if (field === 'CQCAmonthly' || field === 'CQCAweekly' || 
                 field === 'QCPoriginal' || field === 'QCPrevised' ||
                 field === 'asBuiltPlan' || field === 'asStakedPlan') {
            const status = newValue === 'Yes' || newValue === true ? 'submitted' : 'removed';
            message = `${fieldLabel} ${status} for ${contractDisplayId}`;
        }
        else if (field === 'concreteWorksReport' || field === 'concretingReport' || field === 'trialMix') {
            message = `${fieldLabel} updated for ${contractDisplayId}`;
        }
        else {
            message = `${fieldLabel} updated for ${contractDisplayId}: ${oldValue || 'N/A'} → ${newValue}`;
        }
    }
    
    const newNotificationRef = notificationsRef.push();
    const notificationId = newNotificationRef.key;
    
    const notificationData = {
        id: notificationId,
        message: message,
        contractId: contractId,
        timestamp: new Date().getTime(),
        read: false,
        userId: currentUser ? currentUser.uid : 'system',
        action: action,
        field: field,
        oldValue: oldValue,
        newValue: newValue
    };
    
    newNotificationRef.set(notificationData).then(() => {
        if (!notificationIds.has(notificationId)) {
            notificationIds.add(notificationId);
            notifications.unshift(notificationData);
            updateNotificationUI();
        }
    });
}

        // Render projects to the table
        function renderProjects(contracts) {
            const tbody = document.getElementById('projectsTableBody');
            tbody.innerHTML = '';

            if (contracts && Object.keys(contracts).length > 0) {
                Object.keys(contracts).forEach(key => {
                    const contract = contracts[key];
                    const status = contract.projectStatus || 'In Progress';
                    const personnel = contract.personnel || {};
                    
                    const row = document.createElement('tr');
                    row.setAttribute('data-contract-id', key);
                    row.innerHTML = `
                        <td>${personnel.qaInCharge?.name || '-'}</td>
                        <td>${contract['contractId'] || 'N/A'}</td>
                        <td><span class="status-cell ${status === 'Accomplished' ? 'status-accomplished' : 'status-in-progress'}">${status}</span></td>
                        <td>${personnel.contractorsMaterialsEngineer?.name || '-'}</td>
                        <td>${personnel.projectEngineer?.name || '-'}</td>
                        <td>${personnel.materialsEngineer?.name || '-'}</td>
                        <td>${personnel.projectInspector?.name || '-'}</td>
                        <td>${personnel.residentEngineer?.name || '-'}</td>
                        <td>${personnel.provisionalMaterialsEngineer?.name || '-'}</td>
                        <td>${personnel.provisionalMaterialsInspector?.name || '-'}</td>
                        <td class="remarks-cell">
                            <div class="remarks-content">${contract.remarks || 'No remarks'}</div>
                            ${contract.remarkTimestamp ? `<span class="timestamp">Last updated: ${new Date(contract.remarkTimestamp).toLocaleString()}</span>` : ''}
                            <button class="edit-remarks-btn" onclick="editRemarks(this, '${key}')">Edit</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="11" class="empty-state">No project assignments found</td></tr>';
            }
        }

        // Search functionality
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                if (!searchTerm) {
                    renderProjects(allContracts);
                    return;
                }
                
                const filteredContracts = {};
                Object.keys(allContracts).forEach(key => {
                    const contract = allContracts[key];
                    const personnel = contract.personnel || {};
                    
                    const matches = [
                        personnel.qaInCharge?.name?.toLowerCase(),
                        contract.contractId?.toLowerCase(),
                        contract.projectStatus?.toLowerCase(),
                        personnel.contractorsMaterialsEngineer?.name?.toLowerCase(),
                        personnel.projectEngineer?.name?.toLowerCase(),
                        personnel.materialsEngineer?.name?.toLowerCase(),
                        personnel.projectInspector?.name?.toLowerCase(),
                        personnel.residentEngineer?.name?.toLowerCase(),
                        personnel.provisionalMaterialsEngineer?.name?.toLowerCase(),
                        personnel.provisionalMaterialsInspector?.name?.toLowerCase(),
                        contract.remarks?.toLowerCase()
                    ].some(field => field && field.includes(searchTerm));
                    
                    if (matches) filteredContracts[key] = contract;
                });
                
                renderProjects(filteredContracts);
            });
        }

        // Update project statistics
        function updateProjectStats(contracts) {
            const total = Object.keys(contracts).length;
            let inProgress = 0;
            let accomplished = 0;
            
            Object.values(contracts).forEach(contract => {
                const status = contract.projectStatus || 'In Progress';
                if (status === 'In Progress') inProgress++;
                if (status === 'Accomplished') accomplished++;
            });
            
            document.querySelectorAll('.stat-box div:nth-child(2)')[0].textContent = total;
            document.querySelectorAll('.stat-box div:nth-child(2)')[1].textContent = inProgress;
            document.querySelectorAll('.stat-box div:nth-child(2)')[2].textContent = accomplished;
        }

        function editRemarks(button, contractKey) {
            const cell = button.closest('td');
            const currentRemarks = cell.querySelector('.remarks-content')?.textContent || '';
            
            cell.innerHTML = `
                <textarea class="remarks-input">${currentRemarks}</textarea>
                <div class="action-buttons">
                    <button class="save-remarks-btn" onclick="saveRemarks(this, this.previousElementSibling.value, '${contractKey}')">Save</button>
                    <button class="cancel-remarks-btn" onclick="cancelEdit(this, '${contractKey}')">Cancel</button>
                </div>
            `;
            cell.querySelector('textarea').focus();
        }

        function saveRemarks(button, newRemarks, contractKey) {
            const user = firebase.auth().currentUser;
            if (!user) {
                alert('You must be logged in to save remarks');
                return;
            }

            const oldRemarks = allContracts[contractKey]?.remarks || '';
            
            const updates = { 
                remarks: newRemarks,
                remarkTimestamp: new Date().getTime(),
                lastUpdatedBy: user.uid,
                lastUpdatedAt: new Date().getTime()
            };
            
            contractsRef.child(contractKey).update(updates)
            .then(() => {
                // Create notification for remarks update
                createContractNotification(
                    allContracts[contractKey]?.contractId || contractKey,
                    'updated',
                    'remarks',
                    newRemarks,
                    oldRemarks
                );
            }).catch(error => {
                console.error('Error saving remarks:', error);
                alert('Failed to save remarks. Please try again.');
            });
        }

        function cancelEdit(button, contractKey) {
            const cell = button.closest('td');
            const contract = allContracts[contractKey] || {};
            
            cell.innerHTML = `
                <div class="remarks-content">${contract.remarks || 'No remarks'}</div>
                ${contract.remarkTimestamp ? `<span class="timestamp">Last updated: ${new Date(contract.remarkTimestamp).toLocaleString()}</span>` : ''}
                <button class="edit-remarks-btn" onclick="editRemarks(this, '${contractKey}')">Edit</button>
            `;
        }

        // Logout function
        function setupLogout() {
            document.querySelector('.logout-btn').addEventListener('click', () => {
                firebase.auth().signOut().then(() => {
                    window.location.href = "index.html";
                }).catch((error) => {
                    console.error('Logout error:', error);
                    alert('Error signing out. Please try again.');
                });
            });
        }
        
       function setupContractChangeListeners() {
    // Listen for new contracts
    contractsRef.on('child_added', (snapshot) => {
        const contract = snapshot.val();
        const contractKey = snapshot.key;
        
        // Create notification for new contract
        createContractNotification(
            contract.contractId || contractKey,
            'added'
        );
        
        // Update the global contracts object
        allContracts[contractKey] = contract;
    });
    
    // Listen for contract updates
    contractsRef.on('child_changed', (snapshot) => {
        const contract = snapshot.val();
        const contractKey = snapshot.key;
        const oldContract = allContracts[contractKey] || {};
        
        // Check all possible fields that might change
        const fieldsToCheck = [
            'contractId', 'contractName', 'contractAmount', 'contractDuration',
            'projectStatus', 'remarks', 'assignmentTimestamp', 'updateTimestamp',
            'CQCAmonthly', 'CQCAweekly', 'QCPoriginal', 'QCPrevised',
            'asBuiltPlan', 'asStakedPlan', 'concreteWorksReport', 'concretingReport',
            'trialMix', 'approvedBudgetCost', 'appropriation'
        ];
        
        fieldsToCheck.forEach(field => {
            if (!deepEqual(oldContract[field], contract[field])) {
                createContractNotification(
                    contract.contractId || contractKey,
                    'updated',
                    field,
                    formatFieldValue(contract[field]),
                    formatFieldValue(oldContract[field])
                );
            }
        });
        
        // Check personnel changes
        const oldPersonnel = oldContract.personnel || {};
        const newPersonnel = contract.personnel || {};
        
        const personnelFields = [
            'qaInCharge', 'contractorsMaterialsEngineer', 'projectEngineer',
            'materialsEngineer', 'projectInspector', 'residentEngineer',
            'provisionalMaterialsEngineer', 'provisionalMaterialsInspector'
        ];
        
        personnelFields.forEach(field => {
            const oldValue = oldPersonnel[field]?.name || '';
            const newValue = newPersonnel[field]?.name || '';
            if (oldValue !== newValue) {
                createContractNotification(
                    contract.contractId || contractKey,
                    'updated',
                    `personnel.${field}`,
                    newValue,
                    oldValue
                );
            }
        });
        
        // Update the global contracts object
        allContracts[contractKey] = contract;
    });
}
// Helper function to format field values for display
function formatFieldValue(value) {
    if (value === null || value === undefined) return 'N/A';
    if (typeof value === 'boolean') return value ? 'Yes' : 'No';
    if (typeof value === 'object') return JSON.stringify(value);
    return value.toString();
}

// Helper function for deep comparison
function deepEqual(a, b) {
    if (a === b) return true;
    if (typeof a !== 'object' || typeof b !== 'object' || a === null || b === null) return false;
    
    const keysA = Object.keys(a);
    const keysB = Object.keys(b);
    
    if (keysA.length !== keysB.length) return false;
    
    for (const key of keysA) {
        if (!keysB.includes(key) || !deepEqual(a[key], b[key])) {
            return false;
        }
    }
    
    return true;
}


        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    loadProjects();
                    setupSearch();
                    setupLogout();
                    initNotificationSystem();
                    setupContractChangeListeners();
                } else {
                    window.location.href = "index.html";
                }
            });
        });
    </script>
</body>
</html>