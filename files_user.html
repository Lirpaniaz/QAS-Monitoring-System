<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Files</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
        <!-- Add these scripts to your HTML head or before your main script -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    
    
</head>

<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            display: flex;
            height: 100vh;
            background-color: #f2f2f2;
        }
        .sidebar {
            width: 250px;
            background-color: #1c1c64;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px 0;
        }
        .sidebar h3 {
            text-align: center;
            margin-bottom: 20px;
            padding: 0 10px;
            font-size: 25px;
        }
        .menu {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            padding: 0 10px;
            gap: 10px;
        }
        .menu a, .dropdown-btn {
            color: white;
            text-decoration: none;
            padding: 15px;
            cursor: pointer;
            font-size: 18px;
            border-radius: 10px;
            background-color: #1c1c64;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            text-align: center;
            transition: background-color 0.3s ease;
        }
        .menu a:hover, .dropdown-btn:hover {
            background-color: #da471f;
        }
        .menu a.active {
    background-color: #da471f;
}
        .dropdown-container {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        .dropdown-container a {
            font-size: 16px;
            padding: 12px;
            background-color: #1c1c64;
            color: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }
        .dropdown-container a:hover {
            background-color: #da471f;
        }
        .logout-btn {
            margin-top: auto;
            padding: 12px;
            background-color: red;
            color: white;
            border: none;
            cursor: pointer;
            margin: 20px;
            border-radius: 10px;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }
        .logout-btn:hover {
            background-color: #e04a22;
        }
        .main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .files-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        .folder {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        .folder:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .folder-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        .folder-name {
            font-weight: bold;
            margin-bottom: 5px;
            word-break: break-word;
        }
        .folder-info {
            font-size: 12px;
            color: #666;
        }
        /* Consistent folder icon with different colors */
        .folder-blue {
            color: #4285F4;
        }
        .folder-red {
            color: #EA4335;
        }
        .folder-yellow {
            color: #FBBC05;
        }
        .folder-green {
            color: #34A853;
        }
        .folder-purple {
            color: #9C27B0;
        }
        .folder-orange {
            color: #FF9800;
        }
        .files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 20px;
        }
        .files-title {
            font-size: 24px;
            font-weight: bold;
        }
        .add-folder-btn {
            background-color: #1c1c64;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .add-folder-btn:hover {
            background-color: #da471f;
        }
        /* Modal styles */
        .modal {
            display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
    overflow: auto; /* Enable scrolling */
        }
        .modal-content {
            background-color: #fefefe;
    margin: 5% auto; /* Reduced from 15% to give more space */
    padding: 20px;
    border-radius: 10px;
    width: 80%;
    max-width: 600px;
    max-height: 80vh; /* Limit height */
    overflow-y: auto; /* Enable scrolling */
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .submit-btn {
            background-color: #1c1c64;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        .submit-btn:hover {
            background-color: #da471f;
        }
        /* Folder action buttons */
        .folder-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
        }
        .folder-action-btn {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .folder:hover .folder-action-btn {
            opacity: 1;
        }
        .edit-btn {
            color: #1c1c64;
        }
        .delete-btn {
            color: #ff5c33;
        }
        /* Confirmation modal */
        .confirmation-modal {
            display: none;
            position: fixed;
            z-index: 2;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .confirmation-content {
            background-color: #fefefe;
            margin: 20% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 400px;
            text-align: center;
        }
        .confirmation-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .confirm-btn, .cancel-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .confirm-btn {
            background-color: #ff5c33;
            color: white;
        }
        .confirm-btn:hover {
            background-color: #e04a22;
        }
        .cancel-btn {
            background-color: #1c1c64;
            color: white;
        }
        .cancel-btn:hover {
            background-color: #da471f;
        }

        /* Folder Content Modal Styles */
        .folder-content-modal {
            display: none;
            position: fixed;
            z-index: 3;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        
        .folder-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        
        .folder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .folder-title {
            font-size: 24px;
            font-weight: bold;
        }
        
        .close-folder {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close-folder:hover {
            color: black;
        }
        
        .folder-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            border-bottom: 3px solid #1c1c64;
            font-weight: bold;
            color: #1c1c64;
        }
        
        .tab-btn:hover:not(.active) {
            background-color: #f5f5f5;
        }
        
        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }
        
        .tab-content.active {
            display: flex;
        }
        
        /* QA Documents Sidebar */
        .qa-sidebar {
            width: 250px;
            background-color: #f5f5f5;
            border-right: 1px solid #ddd;
            padding: 15px;
            overflow-y: auto;
        }
        
        .qa-menu {
            list-style: none;
        }
        
        .qa-menu-item {
            margin-bottom: 5px;
        }
        
        .qa-menu-link {
            display: block;
            padding: 10px;
            color: #333;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        
        .qa-menu-link:hover {
            background-color: #e0e0e0;
        }
        
        .qa-menu-link.active {
            background-color: #1c1c64;
            color: white;
        }
        
        .qa-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
         /* PDO Checkbox Section */
         .pdo-checkbox {
            margin: 20px 0;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        
        .pdo-checkbox label {
            margin-right: 15px;
            font-weight: bold;
        }
        
      /* Modal Background */
.pdo-personnel-modal {
    display: none; /* Hidden by default */
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow-y: auto;
    background-color: rgba(0, 0, 0, 0.6);
    padding: 2rem;
}

/* Modal Box */
.pdo-personnel-content {
    background-color: #fff;
    max-width: 500px;
    max-height: 90vh; /* Limit height to viewport */
    overflow-y: auto;  /* Enable scrolling inside modal */
    margin: auto;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    padding: 2rem;
    animation: fadeIn 0.3s ease-in-out;
}

/* Optional: Prevent page scroll when modal is open */
body.modal-open {
    overflow: hidden;
}
/* Header */
.pdo-personnel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.pdo-personnel-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: #2c3e50;
}

.close-personnel {
    font-size: 1.5rem;
    cursor: pointer;
    color: #888;
}

/* Form */
.pdo-personnel-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

/* Input Groups */
.pdo-personnel-group {
    
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

/* Add to your CSS */
#pdoStatus.accomplished {
    color: green;
    font-weight: bold;
    border: 1px solid green;
    background-color: #f0fff0;
}

/* Labels and Inputs */
label {
    display: block;
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: #34495e;
}

input[type="text"] {
    width: 100%;
    padding: 0.6rem 0.75rem;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.2s;
}

input[type="text"]:focus {
    border-color: #3498db;
    outline: none;
}

/* Submit Button */
.pdo-personnel-submit {
    margin-top: 1rem;
    padding: 0.75rem 1.5rem;
    background-color: #3498db;
    color: #fff;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    align-self: flex-end;
    transition: background-color 0.3s;
}

.pdo-personnel-submit:hover {
    background-color: #2980b9;
}

/* Animation */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Responsive */
@media (max-width: 768px) {
    .pdo-personnel-group {
        grid-template-columns: 1fr;
    }
}

        
        /* PDO Table */
        .pdo-table-container {
            width: 100%;
            overflow-x: auto;
            margin-top: 20px;
        }
        
        .pdo-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }
        
        .pdo-table th, .pdo-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        .pdo-table th {
            background-color: #1c1c64;
            color: white;
            position: sticky;
            top: 0;
        }
        
        .pdo-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .pdo-table tr:hover {
            background-color: #e9e9e9;
        }
        
        
        .file-actions {
            display: flex;
            gap: 10px;
        }
        
        .file-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
        }
        
        .file-action-btn:hover {
            color: #1c1c64;
        }

        .pdo-meta-fields {
            margin-top: 1rem;
        }

        .pdo-meta-fields label {
            display: block;
            margin-top: 0.5rem;
            font-weight: bold;
        }

        .pdo-meta-fields input,
        .pdo-meta-fields textarea {
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.25rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .accomplished {
    color: green;
    font-weight: bold;
}


/* Add to your CSS */
.document-version {
    margin: 15px 0;
    padding: 10px;
    background-color: #f5f5f5;
    border-radius: 5px;
}

.document-version label {
    margin-right: 15px;
    font-weight: normal;
}

.document-version input[type="checkbox"] {
    margin-right: 5px;
}

#versionSelection {
    margin: 10px 0;
    padding: 10px;
    background: #f5f5f5;
    border-radius: 4px;
    display: none; /* Hidden by default */
}
.version-options {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
    padding: 10px;
    background-color: #f5f5f5;
    border-radius: 5px;
}

.version-options input[type="checkbox"] {
    margin-right: 5px;
}

.version-options label {
    display: inline-block;
    margin-right: 15px;
    margin-bottom: 5px;
    cursor: pointer;
}

.version-option {
    display: flex;
    align-items: center;
    gap: 5px;
}
.version-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 12px;
    margin-left: 5px;
}

.version-badge.original {
    background-color: #4CAF50;
    color: white;
}

.version-badge.revised {
    background-color: #2196F3;
    color: white;
}
/* Add this to your CSS */
#acpntlModal {
    display: none;
    position: fixed;
    z-index: 1001; /* Higher than other modals */
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
}

#acpntlModal .modal-content {
    position: relative;
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    animation: modalFadeIn 0.3s ease-out;
}

@keyframes modalFadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-group div {
    margin-top: 5px;
}

.form-group div label {
    display: inline-block;
    margin-right: 15px;
    font-weight: normal;
}
.acp-display {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .acp-detail-row {
            display: flex;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .acp-detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .acp-detail-label {
            font-weight: bold;
            min-width: 200px;
            color: #1c1c64;
        }
        
        .acp-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        
        .acp-edit-btn {
            background-color: #1c1c64;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .acp-edit-btn:hover {
            background-color: #da471f;
        }
        
        .acp-no-data {
            text-align: center;
            padding: 20px;
            color: #666;
            background-color: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .acp-add-btn {
            background-color: #1c1c64;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .acp-add-btn:hover {
            background-color: #da471f;
        }
.acp-details-container {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    background-color: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
    max-height: 400px;
    overflow-y: auto;
}

.acp-details {
    flex: 1;
}

.acp-no-data {
    text-align: center;
    padding: 20px;
    color: #666;
    background-color: #f5f5f5;
    border-radius: 8px;
    margin-bottom: 20px;
    width: 100%;
}



.file-upload-section {
    flex: 1;
}

.detail-row {
    display: flex;
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid #eee;
}

.detail-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.detail-label {
    font-weight: bold;
    min-width: 150px;
    color: #1c1c64;
}

.edit-btn {
    background-color: #1c1c64;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 15px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}
/* Add this to your CSS */
#displayAcpntlReason {
    max-height: 100px;
    overflow-y: auto;
    padding: 5px;
    background-color: #f5f5f5;
    border-radius: 4px;
    border: 1px solid #ddd;
    margin-top: 5px;
}

/* Style the scrollbar */
#displayAcpntlReason::-webkit-scrollbar {
    width: 8px;
}

#displayAcpntlReason::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

#displayAcpntlReason::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

#displayAcpntlReason::-webkit-scrollbar-thumb:hover {
    background: #555;
}

.edit-btn:hover {
    background-color: #da471f;
}






.file-list-container {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #eee;
    border-radius: 8px;
    padding: 10px;
}

.file-list {
    list-style: none;
}

.file-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.file-list li:last-child {
    border-bottom: none;
}

.file-actions {
    display: flex;
    gap: 8px;
}

.file-action-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: #666;
    font-size: 14px;
}

.file-action-btn:hover {
    color: #1c1c64;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

.cancel-btn {
    background-color: #ccc;
    color: #333;
}

.cancel-btn:hover {
    background-color: #bbb;
}

.radio-group {
    display: flex;
    gap: 15px;
    margin-top: 5px;
}

.radio-group label {
    display: flex;
    align-items: center;
    gap: 5px;
    font-weight: normal;
    cursor: pointer;
}
.acp-details-container {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    background-color: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
    max-height: 400px; /* Limit height */
    overflow-y: auto;  /* Add scrollbar when content overflows */
}

#displayAcpReason {
    max-height: 100px;
    overflow-y: auto;
    padding: 5px;
    background-color: #f5f5f5;
    border-radius: 4px;
    border: 1px solid #ddd;
    margin-top: 5px;
    white-space: pre-wrap; /* Preserve line breaks */
    word-wrap: break-word; /* Break long words */
}

/* Style the scrollbar */
#displayAcpReason::-webkit-scrollbar,
.acp-details-container::-webkit-scrollbar {
    width: 8px;
}

#displayAcpReason::-webkit-scrollbar-track,
.acp-details-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

#displayAcpReason::-webkit-scrollbar-thumb,
.acp-details-container::-webkit-scrollbar-thumb {
    background: #ececec;
    border-radius: 4px;
}

#displayAcpReason::-webkit-scrollbar-thumb:hover,
.acp-details-container::-webkit-scrollbar-thumb:hover {
    background: #9d9d9d;
}

.acp-no-data {
    text-align: center;
    padding: 20px;
    color: #666;
    background-color: #f5f5f5;
    border-radius: 8px;
    margin-bottom: 20px;
    width: 100%;
}

.acp-add-btn {
    background-color: #1c1c64;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 15px;
}

.acp-add-btn:hover {
    background-color: #da471f;
}
.delete-btn {
    background-color: #ff5c33;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 15px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.delete-btn:hover {
    background-color: #e04a22;
}

.acp-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

/* Concrete Pouring Permits specific styles */
.concrete-permit-details {
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 8px;
    margin-bottom: 20px;
}

.concrete-permit-details .detail-row {
    display: flex;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.concrete-permit-details .detail-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.concrete-permit-details .detail-label {
    font-weight: bold;
    min-width: 200px;
    color: #1c1c64;
}

#concretePermitModal {
    z-index: 9000; /* Make sure this is higher than other elements */
    /* ... other styles ... */
}
#concretingReportModal {
    z-index: 9000; /* Make sure this is higher than other elements */
    /* ... other styles ... */
}

    /* Add this to your CSS */
    .materials-testing-container {
        margin-top: 20px;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow-x: auto;
    }
    
    .materials-testing-table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
       min-width: 1200px
    }
    
    .materials-testing-table th, 
    .materials-testing-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
        font-size: 14px;
    }
    
    .materials-testing-table th {
        background-color: #1c1c64;
        color: white;
        position: sticky;
        top: 0;
    }
    
    .materials-testing-table tr:nth-child(even) {
        background-color: #f2f2f2;
    }
    
    .materials-testing-table tr:hover {
        background-color: #e9e9e9;
    }
    
    /* Make specific columns narrower */
    .materials-testing-table td:nth-child(1), /* Item No */
    .materials-testing-table td:nth-child(3), /* Unit */
    .materials-testing-table td:nth-child(5), /* Kind of Test */
    .materials-testing-table td:nth-child(6), /* No. of Test */
    .materials-testing-table td:nth-child(7) { /* Status */
        width: 90px;
    }

    
    .materials-testing-table td:nth-child(8), /* No. of Test */
    .materials-testing-table td:nth-child(9) { /* Status */
        width: 70px;
    }
   
    
    .materials-testing-table td:nth-child(4), /* Quantity */
    .materials-testing-table td:nth-child(6) { /* No. of Test */
        width: 60px;
    }
    
    /* Make inputs smaller */
    .materials-testing-table input[type="text"],
    .materials-testing-table input[type="number"] {
        width: 100%;
        padding: 4px;
        box-sizing: border-box;
    }
    
    /* Style buttons in table */
    .materials-testing-table button {
        padding: 4px 8px;
        font-size: 12px;
        margin: 2px;
    }

.add-row-btn {
    background-color: #1c1c64;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 10px;
}

.add-row-btn:hover {
    background-color: #da471f;
}

.test-checkbox {
    margin-right: 5px;
}

.date-input {
    width: 100px;
    padding: 5px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.save-date-btn {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    margin-left: 5px;
}

.save-date-btn:hover {
    background-color: #45a049;
}

/* Add these styles to your existing CSS */
.status-cell, .date-cell {
    vertical-align: top;
    padding: 8px;
}

/* Add these styles to your existing CSS */
.checkbox-wrapper, .date-wrapper {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
    min-height: 30px;
}

.checkbox-wrapper {
    justify-content: flex-start;
}

.date-wrapper {
    justify-content: flex-start;
}

.test-checkbox {
    margin-right: 8px;
}

.date-input {
    width: 120px;
    margin-right: 8px;
}

.save-date-btn {
    padding: 2px 5px;
    font-size: 12px;
}

.test-checkbox-container, 
.test-date-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    transition: max-height 0.3s ease;
}

.checkbox-wrapper, 
.date-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
    min-height: 30px;
}

.show-more-btn {
    background: none;
    border: none;
    color: #0066cc;
    cursor: pointer;
    padding: 5px 0;
    text-align: left;
    font-size: 0.9em;
    margin-bottom: 5px;
}

.show-more-btn:hover {
    text-decoration: underline;
}

.show-more-btn i {
    margin-left: 5px;
    transition: transform 0.3s ease;
}

.show-more-btn.collapsed i {
    transform: rotate(-90deg);
}

.show-more-btn.expanded i {
    transform: rotate(0deg);
}

/* Ensure modals stay properly layered */
.modal {
    z-index: 1000;
    display: none;
}

/* Concrete permit modal should have higher z-index when active */
#concretePermitModal[style*="display: block"] {
    z-index: 1001;
    display: block !important;
}

/* Hide all other modals when not active */
.modal:not([style*="display: block"]) {
    display: none !important;
}

/* Add this to your CSS */
/* Make sure this is in your CSS */
#acpntlModal {
    display: none;
    position: fixed;
    z-index: 1002; /* Higher than other modals */
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.6);
}

#acpntlModal.modal-open {
    display: block;
}

#acpntlModal .modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border-radius: 10px;
    width: 80%;
    max-width: 600px;
    animation: modalFadeIn 0.3s ease-out;
}

/* Make sure it appears on top when active */
#acpntlModal[style*="display: block"] {
    display: block !important;
}

 /* Simplified Materials Logbook Styles */
        .materials-logbook-container {
            margin-top: 20px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              display: none;
        }
        
        .materials-logbook-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .materials-logbook-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .logbook-status-row {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logbook-status-label {
            font-weight: bold;
            min-width: 100px;
        }
        
        .logbook-status-value {
            padding: 8px 12px;
            border-radius: 4px;
            background-color: #f0f0f0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .logbook-status-value:hover {
            background-color: #e0e0e0;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .status-badge.pending {
            background-color: #FFC107;
            color: #000;
        }
        
        .status-badge.in-progress {
            background-color: #2196F3;
            color: #fff;
        }
        
        .status-badge.completed {
            background-color: #4CAF50;
            color: #fff;
        }
        
        .status-badge.rejected {
            background-color: #F44336;
            color: #fff;
        }
        
        .logbook-date-row {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logbook-date-label {
            font-weight: bold;
            min-width: 100px;
        }
        
        .logbook-date-value {
            padding: 8px 12px;
            border-radius: 4px;
            background-color: #f0f0f0;
        }
        
        .logbook-edit-btn {
            background-color: #1c1c64;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
        }
        
        .logbook-edit-btn:hover {
            background-color: #da471f;
        }
        
        /* Status Edit Modal */
        .status-edit-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .status-edit-content {
            background-color: #fff;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
        }
        
        .status-edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .status-edit-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .close-status-edit {
            font-size: 24px;
            cursor: pointer;
        }
        
        .status-edit-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .status-edit-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }


        /* Site Instructions Styles */
.site-instructions-container {
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.site-instructions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.site-instructions-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.site-instruction-item {
    background-color: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.site-instruction-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.site-instruction-title {
    font-weight: bold;
    color: #1c1c64;
}

.site-instruction-status {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: bold;
    background-color: #f0f0f0;
}

.site-instruction-actions {
    display: flex;
    gap: 10px;
}

.add-site-instruction-btn {
    background-color: #1c1c64;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
}

.add-site-instruction-btn:hover {
    background-color: #da471f;
}

/* Status of Test Styles */
.status-test-container {
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.status-test-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.status-test-item {
    background-color: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.status-test-details {
    display: flex;
    gap: 15px;
    margin-bottom: 10px;
}

.status-test-date {
    font-weight: bold;
    min-width: 120px;
}

.status-test-file {
    padding: 10px;
    background-color: #f5f5f5;
    border-radius: 4px;
}

.status-test-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.add-status-test-btn {
    background-color: #1c1c64;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
}

/* Summary of Field Test Styles */
.summary-field-test-container {
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: none; /* Hidden by default */
}

.summary-field-test-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.summary-field-test-content {
    background-color: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.summary-field-test-details .detail-row {
    display: flex;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.summary-field-test-details .detail-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.summary-field-test-details .detail-label {
    font-weight: bold;
    min-width: 120px;
    color: #1c1c64;
}

.add-summary-field-test-btn {
    background-color: #1c1c64;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
}

.add-summary-field-test-btn:hover {
    background-color: #da471f;
}

/* Time Suspension Report Styles */
.time-suspension-container {
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: none; /* Hidden by default */
}

.time-suspension-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.time-suspension-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.time-suspension-item {
    background-color: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.time-suspension-details .detail-row {
    display: flex;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.time-suspension-details .detail-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.time-suspension-details .detail-label {
    font-weight: bold;
    min-width: 150px;
    color: #1c1c64;
}

.time-suspension-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.add-time-suspension-btn {
    background-color: #1c1c64;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
}

.add-time-suspension-btn:hover {
    background-color: #da471f;
}

/* Time Extension Report Styles */
.time-extension-container {
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: none; /* Hidden by default */
}

.time-extension-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.time-extension-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.time-extension-item {
    background-color: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.time-extension-details .detail-row {
    display: flex;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.time-extension-details .detail-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.time-extension-details .detail-label {
    font-weight: bold;
    min-width: 150px;
    color: #1c1c64;
}

.time-extension-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.add-time-extension-btn {
    background-color: #1c1c64;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
}

.add-time-extension-btn:hover {
    background-color: #da471f;
}

/* Resumption Order Styles */
.resumption-order-container {
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: none; /* Hidden by default */
}

.resumption-order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.resumption-order-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.resumption-order-item {
    background-color: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.resumption-order-details .detail-row {
    display: flex;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.resumption-order-details .detail-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.resumption-order-details .detail-label {
    font-weight: bold;
    min-width: 150px;
    color: #1c1c64;
}

.resumption-order-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.add-resumption-order-btn {
    background-color: #1c1c64;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
}

.add-resumption-order-btn:hover {
    background-color: #da471f;
}

.swa-container {
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: none; /* Hidden by default */
}

.swa-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.swa-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.swa-item {
    background-color: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
}

.swa-number {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: #1c1c64;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.8em;
}

.swa-details .detail-row {
    display: flex;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.swa-details .detail-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.swa-details .detail-label {
    font-weight: bold;
    min-width: 150px;
    color: #1c1c64;
}

.swa-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.add-swa-btn {
    background-color: #1c1c64;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
}

.add-swa-btn:hover {
    background-color: #da471f;
}

.delete-swa-btn {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
}

.delete-swa-btn:hover {
    background-color: #bb2d3b;
}
.no-swa-message {
    text-align: center;
    padding: 20px;
    color: #666;
}


.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
}

.file-item:hover {
    background-color: #f5f5f5;
}

.file-info {
    display: flex;
    align-items: center;
    flex-grow: 1;
}

.file-icon {
    margin-right: 10px;
    font-size: 1.2em;
    color: #555;
}

.file-name {
    margin-right: 10px;
    flex-grow: 1;
}

.file-size {
    color: #777;
    font-size: 0.9em;
    margin-right: 10px;
}

.file-actions {
    display: flex;
    gap: 5px;
}

.file-action-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    color: #555;
    font-size: 1em;
}

.file-action-btn:hover {
    color: #2196F3;
}

.version-badge {
    font-size: 0.7em;
    padding: 2px 5px;
    border-radius: 3px;
    margin-left: 5px;
    background-color: #e0e0e0;
    color: #333;
}

.version-badge.original {
    background-color: #4CAF50;
    color: white;
}

.version-badge.revised {
    background-color: #2196F3;
    color: white;
}

/* Loading indicators */
.upload-loading,
.loading-files {
    text-align: center;
    padding: 10px;
    color: #555;
}

/* Preview modal styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    overflow: auto;
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: black;
}

.preview-content {
    margin-top: 20px;
    text-align: center;
}

.pdf-download-prompt {
    margin-top: 10px;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 4px;
}

.generic-preview {
    padding: 20px;
    text-align: center;
}

.download-link {
    display: inline-block;
    margin-top: 10px;
    padding: 8px 15px;
    background-color: #4CAF50;
    color: white;
    text-decoration: none;
    border-radius: 4px;
}

.download-link:hover {
    background-color: #45a049;
}

.design-mix-scanned-container {
    margin: 20px 0;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 5px;
    border-left: 4px solid #007bff;
}

.scanned-question {
    margin-bottom: 15px;
    font-weight: 500;
}

.scanned-question label {
    margin-right: 15px;
}

.radio-group {
    display: inline-block;
}

.radio-group label {
    margin-right: 15px;
    cursor: pointer;
}

.scanned-notes {
    margin-top: 10px;
    padding: 10px;
    background-color: #e9f7ef;
    border-radius: 4px;
    display: none;
}

.progress-container {
    width: 100%;
    height: 20px;
    background-color: #f0f0f0;
    border-radius: 10px;
    margin: 10px 0;
    position: relative;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background-color: #4CAF50;
    transition: width 0.3s ease;
}

.progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #333;
    font-weight: bold;
}

.status-test-summary {
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.status-details {
    margin-top: 15px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.detail-label {
    font-weight: bold;
    color: #555;
}
/* Summary of Field Test Table CSS */
.summary-table-container {
    margin: 20px 0;
    overflow-x: auto;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.summary-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.summary-table th {
    background-color: #2c3e50;
    color: white;
    font-weight: 600;
    padding: 12px 15px;
    text-align: left;
}

.summary-table td {
    padding: 10px 15px;
    border-bottom: 1px solid #e0e0e0;
    vertical-align: top;
}

.summary-table tr:nth-child(even) {
    background-color: #f8f9fa;
}

.summary-table tr:hover {
    background-color: #f1f1f1;
}

.summary-table tfoot td {
    font-weight: bold;
    background-color: #f8f9fa;
    border-top: 2px solid #2c3e50;
}

.month-header {
    background-color: #e9ecef !important;
    font-size: 1.1em;
}

.month-header td {
    padding: 8px 15px;
    border-bottom: 2px solid #dee2e6;
}

.month-total {
    background-color: #f8f9fa;
    font-weight: bold;
}

.month-total td {
    border-top: 1px solid #dee2e6;
    border-bottom: 1px solid #dee2e6;
}

.summary-actions {
    margin-top: 20px;
    display: flex;
    justify-content: flex-end;
}

.refresh-btn {
    padding: 8px 15px;
    border: none;
    border-radius: 4px;
    background-color: #3498db;
    color: white;
    cursor: pointer;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: all 0.2s;
}

.refresh-btn:hover {
    background-color: #2980b9;
}

.no-summary-data {
    text-align: center;
    padding: 30px;
    background: #f8f9fa;
    border-radius: 8px;
    color: #666;
}

.no-summary-data p {
    margin-bottom: 15px;
}

@media (max-width: 768px) {
    .summary-table {
        display: block;
        overflow-x: auto;
    }
    
    .summary-table th, 
    .summary-table td {
        white-space: nowrap;
    }
}

.variation-orders-container {
    margin: 20px 0;
    padding: 15px;
    background: #f5f5f5;
    border-radius: 5px;
   
}

.vo-checkboxes {
    display: flex;
    gap: 20px;
    margin-top: 10px;
}


.vo-checkbox {
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.vo-date {
  
    color: #2c3e50;
    font-weight: bold;
    min-width: 100px;
    display: inline-block;
}

.edit-vo-date-btn {
   
    padding: 2px 8px;
    font-size: 12px;
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 3px;
    cursor: pointer;
}

.edit-vo-date-btn:hover {
    background-color: #e0e0e0;
}
.test-checkbox-container, 
.test-date-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    transition: max-height 0.3s ease;
}

.checkbox-wrapper, 
.date-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
    min-height: 30px;
}

.show-more-btn {
    background: none;
    border: none;
    color: #0066cc;
    cursor: pointer;
    padding: 5px 0;
    text-align: left;
    font-size: 0.9em;
    margin-bottom: 5px;
}

.show-more-btn:hover {
    text-decoration: underline;
}
#variationOrdersContainer {
    display: none;
}
.scanned-details {
    margin-top: 15px;
    padding: 10px;
    background-color: #f5f5f5;
    border-radius: 4px;
}

.scanned-date {
    display: flex;
    align-items: center;
    gap: 10px;
}

.edit-date-btn {
    margin-left: 10px;
    padding: 2px 8px;
    font-size: 12px;
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 3px;
    cursor: pointer;
}

.edit-date-btn:hover {
    background-color: #e0e0e0;
}

.trial-mix-container {
    margin: 20px 0;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.trial-mix-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.add-trial-mix-btn {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.add-trial-mix-btn:hover {
    background-color: #45a049;
}

.trial-mix-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.trial-mix-item {
    background-color: white;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.trial-mix-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-weight: bold;
}

.trial-mix-type {
    background-color: #e3f2fd;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 13px;
}

.trial-mix-details {
    margin: 10px 0;
}

.detail-row {
    display: flex;
    margin-bottom: 5px;
}

.detail-label {
    font-weight: bold;
    min-width: 80px;
    margin-right: 10px;
}

.trial-mix-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.edit-trial-mix-btn {
    background-color: #2196F3;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
}

.delete-trial-mix-btn {
    background-color: #f44336;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
}

   .remarks-container {
            margin-top: 5px;
        }
        
        .remark-item {
            padding: 8px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #4CAF50;
        }
        
        .remark-text {
            font-size: 14px;
            margin-bottom: 3px;
        }
        
        .remark-date {
            font-size: 12px;
            color: #6c757d;
        }
        
        .remark-input-group {
            display: flex;
            margin-bottom: 8px;
            align-items: center;
            gap: 8px;
        }
        
        .remark-input-group .remark-input {
            flex: 1;
            min-width: 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .remark-input-group .remark-date {
            font-size: 12px;
            color: #6c757d;
            white-space: nowrap;
            min-width: 120px;
        }
        
        .remove-remark-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .remove-remark-btn:hover {
            background: #ff5252;
        }
        
        .remove-remark-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .add-remark-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .add-remark-btn:hover {
            background: #45a049;
        }
        
        .add-remark-btn i {
            font-size: 12px;
        }
    </style>

 <body>
    <div class="sidebar">
       <div>
      <h3>QUALITY<br>ASSURANCE<br>SECTION</h3>
      <div class="menu">
        <a href="user_dashboard.html">Dashboard</a>
        <a href="my_projects.html">My Projects</a>
        <a href="shared_project.html" class="active">Shared Projects</a>
        <a href="files_user.html">Files</a>
      </div>
    </div>
    <button class="logout-btn" id="logout-btn">LOG OUT</button>
  </div>
    </div>

    <div class="main-content">
        <div class="files-header">
            <div class="files-title">Files Management</div>
            <button class="add-folder-btn" id="addFolderBtn">
                <i class="fas fa-plus"></i> New Folder
            </button>
        </div>
        
        <div class="files-container" id="filesContainer">
            <!-- Folders will be dynamically loaded here -->
        </div>
    </div>

    <!-- Add/Edit Folder Modal -->
    <div id="folderModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">Create New Folder</h2>
            <form id="folderForm">
                <input type="hidden" id="folderId">
                <div class="form-group">
                    <label for="contractId">Select Contract</label>
                    <select id="contractId" required>
                        <option value="">Select a Contract</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="folderColor">Folder Color</label>
                    <select id="folderColor" required>
                        <option value="blue">Blue</option>
                        <option value="red">Red</option>
                        <option value="yellow">Yellow</option>
                        <option value="green">Green</option>
                        <option value="purple">Purple</option>
                        <option value="orange">Orange</option>
                    </select>
                </div>
                <button type="submit" class="submit-btn" id="modalSubmitBtn">Create Folder</button>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="confirmation-modal">
        <div class="confirmation-content">
            <h3>Confirm Deletion</h3>
            <p>Are you sure you want to delete this folder? This action cannot be undone.</p>
            <div class="confirmation-buttons">
                <button class="cancel-btn" id="cancelDeleteBtn">Cancel</button>
                <button class="confirm-btn" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Folder Content Modal -->
    <div id="folderContentModal" class="folder-content-modal">
        <div class="folder-content">
            <div class="folder-header">
                <div class="folder-title" id="folderContentTitle">Folder Content</div>
                <span class="close-folder">&times;</span>
            </div>
            
            <div class="folder-tabs">
                <button class="tab-btn active" data-tab="qaDocuments">QA Documents</button>
                <button class="tab-btn" data-tab="pdo">PDO</button>
            </div>
            
            <!-- QA Documents Tab Content -->
            <div class="tab-content active" id="qaDocuments">
                <div class="qa-sidebar">
                    <ul class="qa-menu">
                        <li class="qa-menu-item"><a href="#" class="qa-menu-link active" data-content="programOfWorks">Program of Works</a></li>
                        <li class="qa-menu-item"><a href="#" class="qa-menu-link" data-content="plans">Plans</a></li>
                        <li class="qa-menu-item"><a href="#" class="qa-menu-link" data-content="qualityControlProgram">QCP</a></li>
                        <li class="qa-menu-item"><a href="#" class="qa-menu-link" data-content="designMix">Design Mix</a></li>
                        <li class="qa-menu-item"><a href="#" class="qa-menu-link" data-content="pertCpmGantt">PERT/CPM/Gantt Chart</a></li>
                        <li class="qa-menu-item"><a href="#" class="qa-menu-link" data-content="cqca">CQCA</a></li> 
                        <li class="qa-menu-item"><a href="#" class="qa-menu-link" data-content="trialMix">Trial Mix</a></li>
                        <li class="qa-menu-item"><a href="#" class="qa-menu-link" data-content="materialsLogbook">Materials Logbook</a></li>
                        <li class="qa-menu-item"><a href="#" class="qa-menu-link" data-content="materialsTestingReport">Materials Testing Report</a></li>
                        <li class="qa-menu-item"><a href="#" class="qa-menu-link" data-content="statusOfTest">Status of Test</a></li>
                        <li class="qa-menu-item"><a href="#" class="qa-menu-link" data-content="summaryOfFieldTest">Summary of Field Test</a></li>
                        <li class="qa-menu-item"><a href="#" class="qa-menu-link" data-content="reportOnConcretingWorks">Report on Concreting Works</a></li>
                        <li class="qa-menu-item"><a href="#" class="qa-menu-link" data-content="concretePouringPermits">Concrete Pouring Permits</a></li>
                        <li class="qa-menu-item"><a href="#" class="qa-menu-link" data-content="asphaltConcretePavement">Asphalt Concrete Pavement Notice to Lay</a></li>
                        <li class="qa-menu-item"><a href="#" class="qa-menu-link" data-content="siteInstructions">Site Instructions</a></li>
                        <li class="qa-menu-item"><a href="#" class="qa-menu-link" data-content="variationOrders">Variation Orders</a></li>
                        <li class="qa-menu-item"><a href="#" class="qa-menu-link" data-content="timeSuspensionReport">Time Suspension Report</a></li>
                        <li class="qa-menu-item"><a href="#" class="qa-menu-link" data-content="timeExtensionReport">Time Extension Report</a></li>
                        <li class="qa-menu-item"><a href="#" class="qa-menu-link" data-content="resumptionOrder">Resumption Order</a></li>
                        <li class="qa-menu-item"><a href="#" class="qa-menu-link" data-content="swa">SWA</a></li>
                    </ul>
                </div>
                
                
                <div class="qa-content">
                    <div id="versionSelection">
                        <div class="version-options">
                            <div class="version-option">
                                <input type="checkbox" id="originalVersion" name="documentVersion" value="original" checked>
                                <label for="originalVersion">Original</label>
                            </div>
                            <div class="version-option">
                                <input type="checkbox" id="revisedVersion" name="documentVersion" value="revised">
                                <label for="revisedVersion">Revised</label>
                            </div>
                        </div>

                        <div class="version-options">
                           
                            <label><input type="checkbox" name="planVersion" value="original" id="originalPlanVersion"> Original Plan</label>
                            <label><input type="checkbox" name="planVersion" value="revised" id="revisedPlanVersion"> Revised Plan</label>
                            <label><input type="checkbox" name="planVersion" value="asStaked" id="asStakedPlanVersion"> As Staked Plan</label>
                            <label><input type="checkbox" name="planVersion" value="asBuilt" id="asBuiltPlanVersion"> As Built Plan</label>
                        </div>

                        <div class="version-options">
                           
                            <label><input type="checkbox" name="qcpVersion" value="original" id="originalQCPVersion"> Original QCP</label>
                            <label><input type="checkbox" name="qcpVersion" value="revised" id="revisedQCPVersion"> Revised QCP</label>
                        </div>

                        <div class="version-options">
                            
                            <label><input type="checkbox" name="cqcaVersion" value="weekly" id="weeklyCQCAVersion"> Weekly CQCA</label>
                            <label><input type="checkbox" name="cqcaVersion" value="monthly" id="monthlyCQCAVersion"> Monthly CQCA</label>
                        </div>

                        

                    </div>
                   <div class="variation-orders-container" id="variationOrdersContainer" style="display: none;">
 
    <div class="vo-checkboxes">
        <div class="vo-checkbox">
            <input type="checkbox" id="vo1" name="variationOrders" value="V1">
            <label for="vo1">V1</label>
            <span id="vo1Date" class="vo-date"></span>
            <button class="edit-vo-date-btn" data-vo="vo1" style="display: none;">Edit Date</button>
        </div>
        <div class="vo-checkbox">
            <input type="checkbox" id="vo2" name="variationOrders" value="V2">
            <label for="vo2">V2</label>
            <span id="vo2Date" class="vo-date"></span>
           <button class="edit-vo-date-btn" data-vo="vo2" style="display: none;">Edit Date</button>
        </div>
        <div class="vo-checkbox">
            <input type="checkbox" id="vo3" name="variationOrders" value="V3">
            <label for="vo3">V3</label>
            <span id="vo3Date" class="vo-date"></span>
            <button class="edit-vo-date-btn" data-vo="vo3" style="display: none;">Edit Date</button>
        </div>
        <div class="vo-checkbox">
            <input type="checkbox" id="vo4" name="variationOrders" value="V4">
            <label for="vo4">V4</label>
            <span id="vo4Date" class="vo-date"></span>
            <button class="edit-vo-date-btn" data-vo="vo4" style="display: none;">Edit Date</button>
        </div>
    </div>
</div>






<!-- Add this inside the qa-content div, after the version selection -->
<div class="design-mix-scanned-container" id="designMixScannedContainer" style="display: none;">
    <div class="scanned-question">
        <label>Are the Design Mix files already scanned?</label>
        <div class="radio-group">
            <label><input type="radio" name="designMixScanned" value="yes"> Yes</label>
            <label><input type="radio" name="designMixScanned" value="no"> No</label>
        </div>
    </div>
    <div class="scanned-details" id="scannedDetails" style="display: none;">
        <div class="scanned-date">
            <span>Date Scanned: </span>
            <span id="designMixDateDisplay"></span>
            <button id="editDesignMixDateBtn" class="edit-date-btn">Edit Date</button>
        </div>
    </div>
</div>
                    
   <!-- Simplified Materials Logbook Section -->
                <div class="materials-logbook-container" id="materialsLogbookContainer" style="display: none;">
                  
                    
                    <div class="materials-logbook-content" id="materialsLogbookContent">
                        <div class="logbook-status-row">
                            <span class="logbook-status-label">Status:</span>
                            <span class="logbook-status-value" id="logbookStatusDisplay">
                                <span class="status-badge pending">Pending</span>
                            </span>
                        </div>
                        
                        <div class="logbook-date-row">
                            <span class="logbook-date-label">Last Updated:</span>
                            <span class="logbook-date-value" id="logbookDateDisplay">N/A</span>
                        </div>
                        
                        <button class="logbook-edit-btn" id="editLogbookBtn">
                            <i class="fas fa-edit"></i> Edit Status
                        </button>
                    </div>
                </div>
                  <!-- Status Edit Modal -->
    <div id="statusEditModal" class="status-edit-modal">
        <div class="status-edit-content">
            <div class="status-edit-header">
                <div class="status-edit-title">Update Materials Logbook Status</div>
                <span class="close-status-edit">&times;</span>
            </div>
            
            <form class="status-edit-form" id="statusEditForm">
                <div class="form-group">
                    <label for="statusSelect">Status:</label>
                    <select id="statusSelect" class="form-control">
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="statusDate">Date:</label>
                    <input type="date" id="statusDate" class="form-control" required>
                </div>
                
                <div class="status-edit-actions">
                    <button type="button" class="cancel-btn" id="cancelStatusEdit">Cancel</button>
                    <button type="submit" class="submit-btn">Save</button>
                </div>
            </form>
        </div>
    </div>


<!-- Site Instructions Container -->
<div class="site-instructions-container" id="siteInstructionsContainer" style="display: none;">
    <div class="site-instructions-header">
        <button class="add-site-instruction-btn" id="addSiteInstructionBtn">
            <i class="fas fa-plus"></i> Add Site Instruction
        </button>
    </div>
    
    <div class="site-instructions-list" id="siteInstructionsList">
        <!-- Site Instructions will be added here dynamically -->
    </div>
</div>

<div class="trial-mix-container" id="trialMixContainer" style="display: none;">
    <div class="trial-mix-header">
        <button class="add-trial-mix-btn" id="addTrialMixBtn">
            <i class="fas fa-plus"></i> Add Trial Mix
        </button>
    </div>
    
    <div class="trial-mix-list" id="trialMixList">
        <!-- Trial Mix items will be added here dynamically -->
    </div>
</div>

<!-- Time Suspension Report Container -->
<div class="time-suspension-container" id="timeSuspensionContainer">
    <div class="time-suspension-header">
        <button class="add-time-suspension-btn" id="addTimeSuspensionBtn">
            <i class="fas fa-plus"></i> Add Time Suspension Report
        </button>
    </div>
    
    <div class="time-suspension-list" id="timeSuspensionList">
        <!-- Time Suspension Reports will be added here dynamically -->
    </div>
</div>


<!-- Time Extension Report Container -->
<div class="time-extension-container" id="timeExtensionContainer" style="display: none;">
    <div class="time-extension-header">
        <button class="add-time-extension-btn" id="addTimeExtensionBtn">
            <i class="fas fa-plus"></i> Add Time Extension Report
        </button>
    </div>
    
    <div class="time-extension-list" id="timeExtensionList">
        <!-- Time Extension Reports will be added here dynamically -->
    </div>
</div>

<!-- Resumption Order Container -->
<div class="resumption-order-container" id="resumptionOrderContainer" style="display: none;">
    <div class="resumption-order-header">
        <button class="add-resumption-order-btn" id="addResumptionOrderBtn">
            <i class="fas fa-plus"></i> Add Resumption Order
        </button>
    </div>
    
    <div class="resumption-order-list" id="resumptionOrderList">
        <!-- Resumption Orders will be added here dynamically -->
    </div>
</div>

<!-- Add this to your HTML where you want the SWA section to appear -->
<div id="swaContainer" class="swa-container">
    <div class="swa-header">
        <h3>Statement of Works Accomplishment</h3>
        <button id="addSWABtn" class="add-swa-btn">
            <i class="fas fa-plus"></i> Add SWA
        </button>
    </div>
    <div id="swaList" class="swa-list">
        <!-- SWA items will be rendered here -->
    </div>
</div>



<!-- Status of Test Container -->
<div class="status-test-container" id="statusTestContainer" style="display: none;">
    <div class="status-test-header">
     
      
    </div>
    
    <div class="status-test-list" id="statusTestList">
        <!-- Status test items will be added here dynamically -->
    </div>
</div>

<div class="summary-field-test-container" id="summaryFieldTestContainer" style="display: none;">
  
    
    <div class="summary-field-test-content" id="summaryFieldTestContent">
        <!-- Content will be loaded dynamically -->
    </div>
</div>

                  

                  
<div class="materials-testing-container" id="materialsTestingContainer" style="display: none;">
    
    <div class="table-responsive">
        <table class="materials-testing-table" id="materialsTestingTable">
            <thead>
                <tr>
                    <th>Item No.</th>
                    <th>Description</th>
                    <th>Unit</th>
                    <th>Quantity</th>
                    <th>Kind of Test</th>
                    <th>No. of Test</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="materialsTestingTableBody">
                <!-- Rows will be added dynamically -->
            </tbody>
        </table>
    </div>
    <button class="add-row-btn" id="addMaterialsTestingRowBtn">
        <i class="fas fa-plus"></i> Add Row
    </button>
</div>

                    <div class="file-upload-area" id="fileUploadArea" style="display: none;">
                       
                      
                        <input type="file" id="fileInput" style="display: none;" multiple>
                    </div>
                    
                   
                    <h3 id="currentDocumentType">Program of Works</h3>
                        <ul class="file-list" id="fileList">
                            <!-- Files will be listed here -->
                        </ul>

                </div>
            </div>
            
            <!-- PDO Tab Content -->
            <div class="tab-content" id="pdo">
                <div class="pdo-content">
                    <h2>PDO Documents</h2>

                    <div class="pdo-checkbox">
                        <label>Does this project have PDO present?</label>
                        <label><input type="radio" name="pdoAccreditation" value="yes"> Yes</label>
                        <label><input type="radio" name="pdoAccreditation" value="no"> No</label>
                    </div>

                   
                </div>

                <div class="pdo-table-container">
                    <table id="pdoPersonnelTable" class="pdo-table">
                        <thead>
                            <tr>
                                <th>Role</th>
                                <th>Name</th>
                                <th>Accreditation</th>
                                <th class="actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3">All Personnel</td>
                                <td class="actions">
                                    <button class="btn btn-primary edit-all-personnel-btn">
                                        <i class="fas fa-edit"></i> Edit All
                                    </button>
                                    <button class="btn btn-danger delete-all-personnel-btn">
                                        <i class="fas fa-trash"></i> Delete All
                                    </button>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- PDO Personnel Modal -->
    <div id="pdoPersonnelModal" class="pdo-personnel-modal">
        <div class="pdo-personnel-content">
            <div class="pdo-personnel-header">
                <div class="pdo-personnel-title">Personnel Accreditation</div>
                <span class="close-personnel">&times;</span>
            </div>
            <form id="pdoPersonnelForm">
                <div class="pdo-personnel-form">
                    <div class="pdo-personnel-group">
                        <div>
                            <label for="projectEngineer">Project Engineer</label>
                            <input type="text" id="projectEngineer" placeholder="Enter name">
                            
                            <label for="projectEngineerAccred">Accreditation Number</label>
                            <input type="text" id="projectEngineerAccred" placeholder="Enter accreditation number">
                        </div>
                       
                    </div>
                    
                    <div class="pdo-personnel-group">
                        <div>
                            <label for="projectInspector">Project Inspector</label>
                            <input type="text" id="projectInspector" placeholder="Enter name">

                            
                                <label for="projectInspectorAccred">Accreditation Number</label>
                                <input type="text" id="projectInspectorAccred" placeholder="Enter accreditation number">
                            
                        </div>
                       
                    </div>
                    
                    <div class="pdo-personnel-group">
                        <div>
                            <label for="residentEngineer">Resident Engineer</label>
                            <input type="text" id="residentEngineer" placeholder="Enter name">

                            <label for="residentEngineerAccred">Accreditation Number</label>
                            <input type="text" id="residentEngineerAccred" placeholder="Enter accreditation number">
                        </div>
                        
                    </div>
                    
                    <div class="pdo-personnel-group">
                        <div>
                            <label for="materialsEngineer">Materials Engineer</label>
                            <input type="text" id="materialsEngineer" placeholder="Enter name">

                            <label for="materialsEngineerAccred">Accreditation Number</label>
                            <input type="text" id="materialsEngineerAccred" placeholder="Enter accreditation number">
                        </div>
                        
                    </div>
                    
                    <div class="pdo-personnel-group">
                        <div>
                            <label for="provisionalMaterialsEngineer">Provisional Materials Engineer</label>
                            <input type="text" id="provisionalMaterialsEngineer" placeholder="Enter name">

                            <label for="provisionalMaterialsEngineerAccred">Accreditation Number</label>
                            <input type="text" id="provisionalMaterialsEngineerAccred" placeholder="Enter accreditation number">
                        </div>
                       
                    </div>
                    
                    <div class="pdo-personnel-group">
                        <div>
                            <label for="provisionalMaterialsInspector">Provisional Materials Inspector</label>
                            <input type="text" id="provisionalMaterialsInspector" placeholder="Enter name">

                            <label for="provisionalMaterialsInspectorAccred">Accreditation Number</label>
                            <input type="text" id="provisionalMaterialsInspectorAccred" placeholder="Enter accreditation number">
                        </div>
                        
                    </div>
                    
                    <div class="pdo-personnel-group">
                        <div>
                            <label for="qaInCharge">QA In-Charge</label>
                            <input type="text" id="qaInCharge" placeholder="Enter name">

                            <label for="qaInChargeAccred">Accreditation Number</label>
                            <input type="text" id="qaInChargeAccred" placeholder="Enter accreditation number">
                        </div>
                        
                    </div>
                    
                    <div class="pdo-personnel-group">
                        <div>
                            <label for="contractorsMaterialsEngineer">Contractor's Materials Engineer</label>
                            <input type="text" id="contractorsMaterialsEngineer" placeholder="Enter name">

                            <label for="contractorsMaterialsEngineerAccred">Accreditation Number</label>
                            <input type="text" id="contractorsMaterialsEngineerAccred" placeholder="Enter accreditation number">
                        </div>
                        
                    </div>

                    <div class="form-group">
                        <label for="pdoStatusField">PDO Status</label>
                        <select id="pdoStatusField" class="form-control" required>
                            <option value="">Select Status</option>
                            <option value="Pending">Pending</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Accomplished">Accomplished</option>
                            
                        </select>
                    </div>
                    
                    <button type="submit" class="pdo-personnel-submit">Submit Personnel Information</button>
                </div>
            </form>
        </div>
    </div>


                        <!-- In the HTML, keep the ACP modal as is -->
<div id="acpntlModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close">&times;</span>
        <h2>Asphalt Concrete Pavement Notice to Lay</h2>
        
        <!-- Data Display Section (shown when data exists) -->
        <div id="acpntlDataDisplay" style="display: none;">
            <div class="acpntl-details">
                <div class="detail-row">
                    <span class="detail-label">Status Date:</span>
                    <span id="displayAcpntlStatus"></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Station Covered:</span>
                    <span id="displayAcpntlStation"></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Volume (cu.m):</span>
                    <span id="displayAcpntlVolume"></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Date of Laying:</span>
                    <span id="displayAcpntlDate"></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Job Mix Available:</span>
                    <span id="displayAcpntlJobMix"></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Approval Status:</span>
                    <span id="displayAcpntlApproval"></span>
                </div>
                <div class="detail-row" id="displayAcpntlReasonRow" style="display: none;">
                    <span class="detail-label">Reason for Disapproval:</span>
                    <span id="displayAcpntlReason"></span>
                </div>
                <div class="action-buttons">
                    <button class="edit-btn" id="editAcpntlBtn">
                        <i class="fas fa-edit"></i> Edit Details
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Form Section (hidden when data exists) -->
        <form id="acpntlForm" style="display: none;">
            <div class="form-group">
                <label for="acpntlStatus">Status (Latest Date)</label>
                <input type="date" id="acpntlStatus" required>
            </div>
            
            <div class="form-group">
                <label for="acpntlStation">Station Covered</label>
                <input type="text" id="acpntlStation" required>
            </div>
            
            <div class="form-group">
                <label for="acpntlVolume">Volume to be Laid (cu.m)</label>
                <input type="number" id="acpntlVolume" step="0.01" required>
            </div>
            
            <div class="form-group">
                <label for="acpntlDate">Date of Laying</label>
                <input type="date" id="acpntlDate" required>
            </div>
            
            <div class="form-group">
                <label>Job Mix Available?</label>
                <div class="radio-group">
                    <label><input type="radio" name="acpntlJobMix" value="yes" required> Yes</label>
                    <label><input type="radio" name="acpntlJobMix" value="no"> No</label>
                </div>
            </div>
            
            <div class="form-group">
                <label>Approval Status</label>
                <div class="radio-group">
                    <label><input type="radio" name="acpntlApproval" value="approved" required> Approved</label>
                    <label><input type="radio" name="acpntlApproval" value="disapproved"> Disapproved</label>
                </div>
            </div>
            
            <div class="form-group" id="acpntlReasonGroup" style="display: none;">
                <label for="acpntlReason">Reason for Disapproval</label>
                <textarea id="acpntlReason" rows="3"></textarea>
            </div>
            
            <div class="form-actions">
                <button type="button" class="cancel-btn" id="cancelAcpntlBtn">Cancel</button>
                <button type="submit" class="submit-btn">Save</button>
            </div>
        </form>
    </div>
</div>


<!-- Concrete Pouring Permits Modal -->
<div id="concretePermitModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close">&times;</span>
        <h2>Concrete Pouring Permits</h2>
        
        <!-- Data Display Section (shown when data exists) -->
        <div id="concretePermitDataDisplay" style="display: none;">
            <div class="concrete-permit-details">
                <div class="detail-row">
                    <span class="detail-label">Status Date:</span>
                    <span id="displayConcretePermitStatus"></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Part of Structure/Station:</span>
                    <span id="displayConcretePermitStation"></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Volume (cu.m):</span>
                    <span id="displayConcretePermitVolume"></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Date of Pouring:</span>
                    <span id="displayConcretePermitDate"></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Approval Status:</span>
                    <span id="displayConcretePermitApproval"></span>
                </div>
                <div class="detail-row" id="displayConcretePermitReasonRow" style="display: none;">
                    <span class="detail-label">Reason for Disapproval:</span>
                    <span id="displayConcretePermitReason"></span>
                </div>
                <div class="action-buttons">
                    <button class="edit-btn" id="editConcretePermitBtn">
                        <i class="fas fa-edit"></i> Edit Details
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Form Section (hidden when data exists) -->
        <form id="concretePermitForm" style="display: none;">
            <div class="form-group">
                <label for="concretePermitStatus">Status (Latest Date)</label>
                <input type="date" id="concretePermitStatus" required>
            </div>
            
            <div class="form-group">
                <label for="concretePermitStation">Part of Structure/Station</label>
                <input type="text" id="concretePermitStation" required>
            </div>
            
            <div class="form-group">
                <label for="concretePermitVolume">Volume to be Poured (cu.m)</label>
                <input type="number" id="concretePermitVolume" step="0.01" required>
            </div>
            
            <div class="form-group">
                <label for="concretePermitDate">Date of Pouring</label>
                <input type="date" id="concretePermitDate" required>
            </div>
            
            <div class="form-group">
                <label>Approval Status</label>
                <div class="radio-group">
                    <label><input type="radio" name="concretePermitApproval" value="approved" required> Approved</label>
                    <label><input type="radio" name="concretePermitApproval" value="disapproved"> Disapproved</label>
                </div>
            </div>
            
            <div class="form-group" id="concretePermitReasonGroup" style="display: none;">
                <label for="concretePermitReason">Reason for Disapproval</label>
                <textarea id="concretePermitReason" rows="3"></textarea>
            </div>
            
            <div class="form-actions">
                <button type="button" class="cancel-btn" id="cancelConcretePermitBtn">Cancel</button>
                <button type="submit" class="submit-btn">Save</button>
            </div>
        </form>
    </div>
</div>

   <div id="concretingReportModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close">&times;</span>
            <h2>Report on Concreting Works</h2>
            
            <!-- Data Display Section (shown when data exists) -->
            <div id="concretingReportDataDisplay" style="display: none;">
                <div class="concrete-permit-details">
                    <div class="detail-row">
                        <span class="detail-label">Status Date:</span>
                        <span id="displayConcretingReportStatus"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Part of Structure/Station:</span>
                        <span id="displayConcretingReportStation"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Volume Poured (cu.m):</span>
                        <span id="displayConcretingReportVolume"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Date and Time of Pouring:</span>
                        <span id="displayConcretingReportDateTime"></span>
                    </div>
                    <div class="action-buttons">
                        <button class="edit-btn" id="editConcretingReportBtn">
                            <i class="fas fa-edit"></i> Edit Details
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Form Section (hidden when data exists) -->
            <form id="concretingReportForm" style="display: none;">
                <div class="form-group">
                    <label for="concretingReportStatus">Status (Latest Date)</label>
                    <input type="date" id="concretingReportStatus" required>
                </div>
                
                <div class="form-group">
                    <label for="concretingReportStation">Part of Structure/Station</label>
                    <input type="text" id="concretingReportStation" required>
                </div>
                
                <div class="form-group">
                    <label for="concretingReportVolume">Volume Poured (cu.m)</label>
                    <input type="number" id="concretingReportVolume" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="concretingReportDate">Date of Pouring</label>
                    <div style="display: flex; align-items: center;">
                        <input type="date" id="concretingReportDate" required style="flex: 1;">
                        <input type="time" id="concretingReportTime" class="time-input" required>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="cancel-btn" id="cancelConcretingReportBtn">Cancel</button>
                    <button type="submit" class="submit-btn">Save</button>
                </div>
            </form>
        </div>
    </div>

   

   
</div>

</body>

<script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDuxUQaXiWorKsz1wlpCmho2u9OQq2bAnE",
            authDomain: "qas-section.firebaseapp.com",
            databaseURL: "https://qas-section-default-rtdb.firebaseio.com",
            projectId: "qas-section",
            storageBucket: "qas-section.firebasestorage.app",
            messagingSenderId: "76857155340",
            appId: "1:76857155340:web:8b497e036eb55c33607329"
        };
        
        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const contractsRef = database.ref('contracts');
        const foldersRef = database.ref('folders');
        
        // DOM elements
        const filesContainer = document.getElementById('filesContainer');
        const addFolderBtn = document.getElementById('addFolderBtn');
        const folderModal = document.getElementById('folderModal');
        const closeBtn = document.querySelector('.close');
        const folderForm = document.getElementById('folderForm');
        const contractSelect = document.getElementById('contractId');
        const modalTitle = document.getElementById('modalTitle');
        const modalSubmitBtn = document.getElementById('modalSubmitBtn');
        const folderIdInput = document.getElementById('folderId');
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const folderContentModal = document.getElementById('folderContentModal');
        const closeFolderBtn = document.querySelector('.close-folder');
        const folderContentTitle = document.getElementById('folderContentTitle');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const qaMenuLinks = document.querySelectorAll('.qa-menu-link');
        const currentDocumentType = document.getElementById('currentDocumentType');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const pdoFileUploadArea = document.getElementById('pdoFileUploadArea');
        const pdoFileInput = document.getElementById('pdoFileInput');
        const pdoFileList = document.getElementById('pdoFileList');
        
        // PDO Personnel Modal elements
        const pdoPersonnelModal = document.getElementById('pdoPersonnelModal');
        const closePersonnelBtn = document.querySelector('.close-personnel');
        const pdoPersonnelForm = document.getElementById('pdoPersonnelForm');
        const pdoAccreditationRadios = document.querySelectorAll('input[name="pdoAccreditation"]');
        const pdoPersonnelTable = document.getElementById('pdoPersonnelTable');
        
        // State variables
        let currentFolderId = null;
        let isEditMode = false;
        let currentFolderData = null;
        let currentDocumentCategory = 'programOfWorks';
        let currentContractId = null;
        let editingPersonnelId = null; // Track which personnel is being edited
        let materialsTestingData = {};
        let materialDescriptions = {}; 
        let allMaterialsTestingData = {};
        let allMaterialsLogbookData = {};
        let siteInstructionsData = {};
        let trialMixData = {};

        const acpntlModal = document.getElementById('acpntlModal');
        const acpntlForm = document.getElementById('acpntlForm');
        const acpntlApprovalRadios = document.querySelectorAll('input[name="acpntlApproval"]');
        const acpntlReasonGroup = document.getElementById('acpntlReasonGroup');

        const concretePermitModal = document.getElementById('concretePermitModal');
        const concretePermitForm = document.getElementById('concretePermitForm');
        const concretePermitApprovalRadios = document.querySelectorAll('input[name="concretePermitApproval"]');
        const concretePermitReasonGroup = document.getElementById('concretePermitReasonGroup');


        function highlightCurrentPage() {
        const currentPage = window.location.pathname.split('/').pop() || 'files.html';
        const menuLinks = document.querySelectorAll('.menu a');
    
        document.getElementById('fileUploadArea').addEventListener('click', () => {
    document.getElementById('fileInput').click();
});
    menuLinks.forEach(link => {
        const linkPage = link.getAttribute('href');
        if (linkPage === currentPage) {
            link.classList.add('active');
        } else {
            link.classList.remove('active');
        }
    });
}

        
        // Automatically create folders when contracts are added
        contractsRef.on('child_added', (snapshot) => {
            const contractId = snapshot.key;
            const contractData = snapshot.val();
            
            foldersRef.orderByChild('contractId').equalTo(contractId).once('value')
                .then(folderSnapshot => {
                    if (!folderSnapshot.exists()) {
                        const folderName = contractData.contractId || `Contract ${contractId}`;
                        const defaultColor = 'blue';
                        
                        foldersRef.push().set({
                            name: folderName,
                            contractId: contractId,
                            color: defaultColor,
                            fileCount: 0,
                            createdAt: firebase.database.ServerValue.TIMESTAMP,
                            updatedAt: firebase.database.ServerValue.TIMESTAMP
                        });
                    }
                });
        });
        
        // Show PDO Personnel Modal when Yes is selected
        pdoAccreditationRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'yes') {
                    // Don't clear existing data when opening modal
                    pdoPersonnelModal.style.display = 'block';
                } else if (currentContractId) {
                    if (confirm('Are you sure you want to remove all personnel data?')) {
                        // Clear the table if No is selected
                        pdoPersonnelTable.innerHTML = '';
                        // Update Firebase to remove accreditation data
                        contractsRef.child(currentContractId).update({
                            personnel: null
                        })
                        .then(() => {
                            console.log('Accreditation data removed from contracts table');
                        })
                        .catch(error => {
                            console.error('Error removing accreditation data:', error);
                        });
                    } else {
                        // If user cancels, keep the radio button as "Yes"
                        document.querySelector('input[name="pdoAccreditation"][value="yes"]').checked = true;
                    }
                }
            });
        });




  
        document.addEventListener('DOMContentLoaded', () => {

document.querySelector('.qa-menu-link[data-content="asphaltConcretePavement"]')
  .addEventListener('click', function(e) {
    e.preventDefault();
    currentDocumentCategory = 'asphaltConcretePavement';
    currentDocumentType.textContent = 'Asphalt Concrete Pavement';
    
    // Show the ACP modal
    openACPModal();
    
    // Also load any files for this document type
    loadFilesForCurrentDocument();
});
    highlightCurrentPage();
    loadFolders();
    setupVariationOrderCheckboxes();
loadVariationOrders();
    
   
});

// Initialize ACP container reference
let acpContainer = document.getElementById('acpContainer');

// If the container doesn't exist, create it
if (!acpContainer) {
    acpContainer = document.createElement('div');
    acpContainer.id = 'acpContainer';
    acpContainer.className = 'acp-container';
    acpContainer.style.display = 'none';
    
    const acpDetailsDisplay = document.createElement('div');
    acpDetailsDisplay.id = 'acpDetailsDisplay';
    acpContainer.appendChild(acpDetailsDisplay);
    
    // Insert into the DOM
    const qaContent = document.querySelector('.qa-content');
    if (qaContent) {
        const fileUploadArea = document.getElementById('fileUploadArea');
        if (fileUploadArea) {
            qaContent.insertBefore(acpContainer, fileUploadArea);
        } else {
            qaContent.appendChild(acpContainer);
        }
    }
}

function loadACPData() {
    if (!currentContractId) return;
    
    // Double-check we're on the correct tab
    if (currentDocumentCategory !== 'asphaltConcretePavement') {
        acpntlModal.style.display = 'none';
        return;
    }

    contractsRef.child(currentContractId).child('acpntl').once('value').then(snapshot => {
        const data = snapshot.val();
        
        if (data) {
            updateAcpDetailsDisplay(data);
            // Ensure modal is hidden when we have data
            acpntlModal.style.display = 'none';
        } else {
            showNoAcpData();
            // Only show modal if we're on the correct tab AND no data exists
            if (currentDocumentCategory === 'asphaltConcretePavement') {
                openAcpntlModal();
            }
        }
    });
}

function showNoDataInAcpDetails() {
    let acpContainer = document.getElementById('acpContainer');
    let acpDetailsDisplay = document.getElementById('acpDetailsDisplay');

    // Create acpContainer if it doesn't exist
    if (!acpContainer) {
        acpContainer = document.createElement('div');
        acpContainer.id = 'acpContainer';
        acpContainer.className = 'acp-container';
        acpContainer.style.display = 'block';

        const qaContent = document.querySelector('.qa-content');
        if (qaContent) {
            qaContent.appendChild(acpContainer);
        } else {
            console.error('qa-content not found.');
            return;
        }
    }

    // Create acpDetailsDisplay if it doesn't exist
    if (!acpDetailsDisplay) {
        acpDetailsDisplay = document.createElement('div');
        acpDetailsDisplay.id = 'acpDetailsDisplay';
        acpContainer.appendChild(acpDetailsDisplay);
    }

    // Now safe to assign innerHTML
    acpDetailsDisplay.innerHTML = `
        <div class="acp-no-data">
            <p>No data available for Asphalt Concrete Pavement.</p>
        </div>
    `;
}






// Add this function to load files for the current document type
function loadFilesForCurrentDocument() {
    if (!currentFolderId || !currentDocumentCategory) return;
    
    // Clear existing files
    fileList.innerHTML = '';
    
    // First check if the user has access to this folder
    const user = firebase.auth().currentUser;
    if (!user) return;
    
    // Get the folder data to check the contractId
    foldersRef.child(currentFolderId).once('value').then(folderSnapshot => {
        const folder = folderSnapshot.val();
        if (!folder) return;
        
        const folderContractId = folder.contractId;
        
        // Check if user has access to this contract
        return database.ref('userContracts/' + user.uid + '/' + folderContractId).once('value');
    }).then(accessSnapshot => {
        if (!accessSnapshot.exists()) {
            // User doesn't have direct access, check if they have personnel access
            return checkPersonnelAccess();
        }
        return true; // User has direct access
    }).then(hasAccess => {
        if (!hasAccess) {
            fileList.innerHTML = '<li class="file-item"><div style="padding: 20px; text-align: center; color: #666;">You do not have access to these files</div></li>';
            return;
        }
        
        // User has access, load the files
        return database.ref(`folderDocuments/${currentFolderId}/${currentDocumentCategory}`).once('value');
    }).then(snapshot => {
        if (!snapshot) return;
        
        const files = snapshot.val();
        if (files) {
            Object.entries(files).forEach(([key, file]) => {
                const li = document.createElement('li');
                li.className = 'file-item';
                li.innerHTML = `
                    <div>
                        <i class="fas fa-file"></i>
                        <span>${file.name}</span>
                        ${file.versions ? file.versions.map(v => 
                            `<span class="version-badge ${v}">${v.charAt(0).toUpperCase() + v.slice(1)}</span>`
                        ).join(' ') : ''}
                    </div>
                    <div class="file-actions">
                        <button class="file-action-btn download-btn" data-url="${file.url}" title="Download">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="file-action-btn delete-btn" data-key="${key}" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // Add event listeners
                li.querySelector('.download-btn').addEventListener('click', (e) => {
                    window.open(e.target.closest('button').dataset.url, '_blank');
                });
                
                li.querySelector('.delete-btn').addEventListener('click', (e) => {
                    if (confirm('Are you sure you want to delete this file?')) {
                        const fileKey = e.target.closest('button').dataset.key;
                        deleteFile(fileKey);
                    }
                });
                
                fileList.appendChild(li);
            });
        } else {
            fileList.innerHTML = '<li class="file-item"><div style="padding: 20px; text-align: center; color: #666;">No files found</div></li>';
        }
    }).catch(error => {
        console.error('Error loading files:', error);
        fileList.innerHTML = '<li class="file-item"><div style="padding: 20px; text-align: center; color: #666;">Error loading files</div></li>';
    });
}

function checkPersonnelAccess() {
    const user = firebase.auth().currentUser;
    if (!user || !currentFolderId) return Promise.resolve(false);
    
    return foldersRef.child(currentFolderId).once('value').then(folderSnapshot => {
        const folder = folderSnapshot.val();
        if (!folder) return false;
        
        const folderContractId = folder.contractId;
        
        // Check if user is personnel for this contract
        return contractsRef.child(folderContractId).once('value').then(contractSnapshot => {
            const contract = contractSnapshot.val();
            if (!contract || !contract.personnel) return false;
            
            // Check if user's name matches any personnel
            const userName = user.displayName;
            if (!userName) return false;
            
            // Check all personnel fields for matching name
            for (const role in contract.personnel) {
                if (contract.personnel[role].name === userName) {
                    return true;
                }
            }
            
            return false;
        });
    });
}
// Function to delete a file
function deleteFile(fileKey) {
    if (!currentFolderId || !currentDocumentCategory || !fileKey) return;
    
    // First get the file reference to delete from storage
    database.ref(`folderDocuments/${currentFolderId}/${currentDocumentCategory}/${fileKey}`).once('value')
        .then(snapshot => {
            const file = snapshot.val();
            if (!file) return;
            
            // Delete from Firebase Storage
            const storageRef = firebase.storage().refFromURL(file.url);
            return storageRef.delete().then(() => {
                // Then delete the database reference
                return database.ref(`folderDocuments/${currentFolderId}/${currentDocumentCategory}/${fileKey}`).remove();
            });
        })
        .then(() => {
            alert('File deleted successfully');
            loadFilesForCurrentDocument(); // Refresh the list
        })
        .catch(error => {
            console.error('Error deleting file:', error);
            alert('Error deleting file: ' + error.message);
        });
}

// Function to open ACP modal
function openAcpntlModal() {
    // Only proceed if we're on the correct document type
    if (currentDocumentCategory !== 'asphaltConcretePavement') {
        return;
    }
    
    // Close any other open modals first
    document.querySelectorAll('.modal').forEach(modal => {
        if (modal.id !== 'acpntlModal') {
            modal.style.display = 'none';
        }
    });
    
    if (!currentContractId) return;
    
    // Reset the modal first
    document.getElementById('acpntlDataDisplay').style.display = 'none';
    document.getElementById('acpntlForm').style.display = 'none';
    
    // Load existing data if available
    contractsRef.child(currentContractId).child('acpntl').once('value').then(snapshot => {
        const data = snapshot.val();
        
        if (data) {
            // Show the data display and hide the form
            document.getElementById('acpntlDataDisplay').style.display = 'block';
            populateAcpntlDisplay(data);
        } else {
            // No data exists, show the form for new entry
            document.getElementById('acpntlForm').style.display = 'block';
            document.getElementById('acpntlForm').reset();
            document.getElementById('acpntlReasonGroup').style.display = 'none';
        }
        
        // Show the modal
        document.getElementById('acpntlModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
    });
}


// Function to show modal with data (or empty form)
function showAcpntlModalWithData(data) {
    // Hide display and show form
    document.getElementById('acpntlDataDisplay').style.display = 'none';
    document.getElementById('acpntlForm').style.display = 'block';
    
    // Reset form first
    document.getElementById('acpntlForm').reset();
    acpntlReasonGroup.style.display = 'none';
    
    if (data) {
        // Populate form with existing data
        document.getElementById('acpntlStatus').value = data.status || '';
        document.getElementById('acpntlStation').value = data.station || '';
        document.getElementById('acpntlVolume').value = data.volume || '';
        document.getElementById('acpntlDate').value = data.date || '';
        
        // Set job mix radio
        document.querySelector(`input[name="acpntlJobMix"][value="${data.jobMix || 'no'}"]`).checked = true;
        
        // Set approval radio
        document.querySelector(`input[name="acpntlApproval"][value="${data.approval || 'approved'}"]`).checked = true;
        
        // Show/hide reason field
        acpntlReasonGroup.style.display = data.approval === 'disapproved' ? 'block' : 'none';
        document.getElementById('acpntlReason').value = data.reason || '';
    }
}

// Show/hide reason field based on approval status
document.querySelectorAll('input[name="acpntlApproval"]').forEach(radio => {
    radio.addEventListener('change', () => {
        acpntlReasonGroup.style.display = radio.value === 'disapproved' ? 'block' : 'none';
        if (radio.value !== 'disapproved') {
            document.getElementById('acpntlReason').value = '';
        }
    });
});


function updateAcpDetailsDisplay(data) {
    const acpDetailsDisplay = document.getElementById('acpDetailsDisplay');
    
    if (!data) {
        showNoDataInAcpDetails();
        return;
    }
    
    // Format dates for display
    const formatDate = (dateStr) => {
        if (!dateStr) return 'N/A';
        const date = new Date(dateStr);
        return date.toLocaleDateString();
    };
    
    // Update the display HTML
    acpDetailsDisplay.innerHTML = `
        <div class="acp-details">
            <h3>Asphalt Concrete Pavement Details</h3>
            <div class="detail-row">
                <span class="detail-label">Status Date:</span>
                <span id="displayAcpStatus">${formatDate(data.status) || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Station Covered:</span>
                <span id="displayAcpStation">${data.station || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Volume (cu.m):</span>
                <span id="displayAcpVolume">${data.volume ? `${data.volume} cu.m` : 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Date of Laying:</span>
                <span id="displayAcpDate">${formatDate(data.date) || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Job Mix Available:</span>
                <span id="displayAcpJobMix">${data.jobMix === 'yes' ? 'Yes' : 'No'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Approval Status:</span>
                <span id="displayAcpApproval">${data.approval === 'approved' ? 'Approved' : 'Disapproved'}</span>
            </div>
            ${data.approval === 'disapproved' && data.reason ? `
            <div class="detail-row" id="displayAcpReasonRow" style="display: flex;">
                <span class="detail-label">Reason for Disapproval:</span>
                <span id="displayAcpReason">${data.reason}</span>
            </div>
            ` : `
            <div class="detail-row" id="displayAcpReasonRow" style="display: none;">
                <span class="detail-label">Reason for Disapproval:</span>
                <span id="displayAcpReason"></span>
            </div>
            `}
            <div class="acp-actions">
                <button class="edit-btn" id="editAcpBtn">
                    <i class="fas fa-edit"></i> Edit Details
                </button>
                <button class="delete-btn" id="deleteAcpBtn">
                    <i class="fas fa-trash"></i> Delete Details
                </button>
            </div>
        </div>
    `;
    
    // Set up event listeners for the new buttons
    document.getElementById('editAcpBtn').addEventListener('click', () => {
        showAcpntlModalWithData(data);
    });
    
    document.getElementById('deleteAcpBtn').addEventListener('click', () => {
        if (confirm('Are you sure you want to delete this ACP data?')) {
            contractsRef.child(currentContractId).child('acpntl').remove()
                .then(() => {
                    showNoDataInAcpDetails();
                })
                .catch(error => {
                    console.error('Error deleting ACP data:', error);
                    alert('Error deleting ACP data. Please try again.');
                });
        }
    });
    
    // Make sure the display is visible
    acpDetailsDisplay.style.display = 'flex';
}

function populateAcpntlDisplay(data) {
    // Format dates for display
    const formatDate = (dateStr) => {
        if (!dateStr) return 'N/A';
        const date = new Date(dateStr);
        return date.toLocaleDateString();
    };
    
    // Populate the display fields in the modal
    document.getElementById('displayAcpntlStatus').textContent = formatDate(data.status) || 'N/A';
    document.getElementById('displayAcpntlStation').textContent = data.station || 'N/A';
    document.getElementById('displayAcpntlVolume').textContent = data.volume ? `${data.volume} cu.m` : 'N/A';
    document.getElementById('displayAcpntlDate').textContent = formatDate(data.date) || 'N/A';
    document.getElementById('displayAcpntlJobMix').textContent = data.jobMix === 'yes' ? 'Yes' : 'No';
    document.getElementById('displayAcpntlApproval').textContent = data.approval === 'approved' ? 'Approved' : 'Disapproved';
    
    if (data.approval === 'disapproved' && data.reason) {
        document.getElementById('displayAcpntlReasonRow').style.display = 'flex';
        document.getElementById('displayAcpntlReason').textContent = data.reason;
    } else {
        document.getElementById('displayAcpntlReasonRow').style.display = 'none';
    }
    
    // Set up edit button - this now just shows the form with existing data
    document.getElementById('editAcpntlBtn').onclick = () => {
        document.getElementById('acpntlDataDisplay').style.display = 'none';
        document.getElementById('acpntlForm').style.display = 'block';
        showAcpntlModalWithData(data);
    };
}


function showNoDataInAcpDetails() {
    const acpDetailsDisplay = document.getElementById('acpDetailsDisplay');
    acpDetailsDisplay.innerHTML = `
        <div class="acp-no-data">
            <p>No data available for Asphalt Concrete Pavement</p>
            <button class="acp-add-btn" id="addAcpBtn">
                <i class="fas fa-plus"></i> Add Details
            </button>
        </div>
    `;
    
    document.getElementById('addAcpBtn').addEventListener('click', () => {
        showAcpntlModalWithData(null);
    });
}

// Close button
document.querySelector('#acpntlModal .close').addEventListener('click', function() {
    document.getElementById('acpntlModal').style.display = 'none';
    document.body.style.overflow = 'auto';
});

// Close when clicking outside
window.addEventListener('click', function(e) {
    if (e.target === document.getElementById('acpntlModal')) {
        // Just hide the modal, don't change the display state
        document.getElementById('acpntlModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        
        // Reload the ACP data to ensure the display is correct
        loadACPData();
    }
});


document.querySelector('#acpntlModal .close').addEventListener('click', () => {
    acpntlModal.style.display = 'none';
    document.body.style.overflow = 'auto'; // Restore scrolling
    
    // If no data exists, show "no data available" in the ACP details display
    if (!document.getElementById('acpntlDataDisplay').style.display || 
        document.getElementById('acpntlDataDisplay').style.display === 'none') {
        showNoDataInAcpDetails();
    }
});

function showNoDataInAcpDetails() {
    const acpDetailsDisplay = document.getElementById('acpDetailsDisplay');
    acpDetailsDisplay.innerHTML = `
        <div class="acp-no-data">
            <p>No data available for Asphalt Concrete Pavement</p>
            <button class="acp-add-btn" id="addAcpBtn">
                <i class="fas fa-plus"></i> Add Details
            </button>
        </div>
    `;
    
    document.getElementById('addAcpBtn').addEventListener('click', () => {
        showAcpntlModalWithData(null);
    });
}

// Close modal when clicking outside
window.addEventListener('click', (e) => {
    if (e.target === acpntlModal) {
        acpntlModal.style.display = 'none';
    }
});


        // Add this function to check if all PDO fields are complete
        function checkPDOFieldsComplete() {
    // Check accreditation status
    const accreditationValue = document.querySelector('input[name="pdoAccreditation"]:checked')?.value;
    if (!accreditationValue || accreditationValue === 'no') {
        console.log('Accreditation not set or set to no');
        return false;
    }
    
    // Check all personnel fields
    const personnelFields = [
        'projectEngineer', 'projectEngineerAccred',
        'projectInspector', 'projectInspectorAccred',
        'residentEngineer', 'residentEngineerAccred',
        'materialsEngineer', 'materialsEngineerAccred',
        'provisionalMaterialsEngineer', 'provisionalMaterialsEngineerAccred',
        'provisionalMaterialsInspector', 'provisionalMaterialsInspectorAccred',
        'qaInCharge', 'qaInChargeAccred',
        'contractorsMaterialsEngineer', 'contractorsMaterialsEngineerAccred'
    ];
    
    for (const fieldId of personnelFields) {
        const field = document.getElementById(fieldId);
        if (!field || !field.value.trim()) {
            console.log(`Field ${fieldId} is missing`);
            return false;
        }
    }
    
    console.log('All fields complete');
    return true;
}
// Add event listeners to all PDO fields to check completion
function setupPDOFieldListeners() {
    const allFields = [
        'pdoRemarks', 'projectEngineer', 'projectEngineerAccred',
        'projectInspector', 'projectInspectorAccred',
        'residentEngineer', 'residentEngineerAccred',
        'materialsEngineer', 'materialsEngineerAccred',
        'provisionalMaterialsEngineer', 'provisionalMaterialsEngineerAccred',
        'provisionalMaterialsInspector', 'provisionalMaterialsInspectorAccred',
        'qaInCharge', 'qaInChargeAccred',
        'contractorsMaterialsEngineer', 'contractorsMaterialsEngineerAccred'
    ];
    
    allFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', () => {
                updatePDOStatus();
                // Highlight empty required fields
                if (!field.value.trim()) {
                    field.style.border = '1px solid red';
                } else {
                    field.style.border = '';
                }
            });
        }
    });
    
    // Listen to radio button changes
    document.querySelectorAll('input[name="pdoAccreditation"]').forEach(radio => {
        radio.addEventListener('change', updatePDOStatus);
    });
}

// Function to update PDO status based on field completion
function updatePDOStatus() {
    const statusField = document.getElementById('pdoStatus');
    if (checkPDOFieldsComplete()) {
        statusField.value = "Accomplished PDO";
        statusField.classList.add('accomplished');
        statusField.readOnly = true;
        
        // Update in Firebase if we have a contract ID
        if (currentContractId) {
            contractsRef.child(currentContractId).update({
                pdoStatus: "Accomplished PDO",
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            });
        }
    } else {
        statusField.value = "";
        statusField.classList.remove('accomplished');
        statusField.readOnly = false;
    }
}

// Call this when opening the PDO tab
function initializePDOTab() {
    setupPDOFieldListeners();
    
    // Check initial status
    updatePDOStatus();
    
    // Load existing data
    if (currentContractId) {
        loadPDOData(currentContractId);
    }
}
        
        // Close PDO Personnel Modal without clearing data
        closePersonnelBtn.addEventListener('click', () => {
            pdoPersonnelModal.style.display = 'none';
            document.body.classList.remove('modal-open');
            editingPersonnelId = null; // Reset editing state
        });





       // Modify the pdoPersonnelForm submit handler
       pdoPersonnelForm.addEventListener('submit', (e) => {
    e.preventDefault();
    
    if (!currentContractId) {
        alert('No contract selected. Please select a contract first.');
        return;
    }
    
    // Collect all personnel data (same as before)
    const personnelData = {
        projectEngineer: {
            name: document.getElementById('projectEngineer').value,
            accreditation: document.getElementById('projectEngineerAccred').value
        },
        projectInspector: {
            name: document.getElementById('projectInspector').value,
            accreditation: document.getElementById('projectInspectorAccred').value
        },
        residentEngineer: {
            name: document.getElementById('residentEngineer').value,
            accreditation: document.getElementById('residentEngineerAccred').value
        },
        materialsEngineer: {
            name: document.getElementById('materialsEngineer').value,
            accreditation: document.getElementById('materialsEngineerAccred').value
        },
        provisionalMaterialsEngineer: {
            name: document.getElementById('provisionalMaterialsEngineer').value,
            accreditation: document.getElementById('provisionalMaterialsEngineerAccred').value
        },
        provisionalMaterialsInspector: {
            name: document.getElementById('provisionalMaterialsInspector').value,
            accreditation: document.getElementById('provisionalMaterialsInspectorAccred').value
        },
        qaInCharge: {
            name: document.getElementById('qaInCharge').value,
            accreditation: document.getElementById('qaInChargeAccred').value
        },
        contractorsMaterialsEngineer: {
            name: document.getElementById('contractorsMaterialsEngineer').value,
            accreditation: document.getElementById('contractorsMaterialsEngineerAccred').value
        }
    };
    
    // Get the PDO status from the form
    const pdoStatus = document.getElementById('pdoStatusField').value;
    
    // Prepare the update data
    const updateData = {
        personnel: personnelData,
        pdo: {
            status: pdoStatus,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        },
        updatedAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    // Update the contract
    contractsRef.child(currentContractId).update(updateData)
    .then(() => {
        updatePersonnelTable(personnelData);
        pdoPersonnelModal.style.display = 'none';
        document.body.classList.remove('modal-open');
        document.querySelector('input[name="pdoAccreditation"][value="yes"]').checked = true;
        
        editingPersonnelId = null;
    })
    .catch(error => {
        console.error('Error saving personnel data:', error);
        alert('Error saving personnel data. Please try again.');
    });
});

// Modify your file list display to show versions
function displayFiles(files) {
    fileList.innerHTML = '';
    
    files.forEach(file => {
        const li = document.createElement('li');
        li.className = 'file-item';
        
        // Only show versions for program of works
        let versionBadges = '';
        if (currentDocumentCategory === 'programOfWorks' && file.versions) {
            versionBadges = file.versions.map(v => 
                `<span class="version-badge ${v}">${v.charAt(0).toUpperCase() + v.slice(1)}</span>`
            ).join(' ');
        }
        
        li.innerHTML = `
            <div>
                <i class="fas fa-file"></i>
                <span>${file.name}</span>
                ${versionBadges}
            </div>
            <div class="file-actions">
                <button class="file-action-btn download-btn" title="Download"><i class="fas fa-download"></i></button>
                <button class="file-action-btn delete-btn" title="Delete"><i class="fas fa-trash"></i></button>
            </div>
        `;
        
        fileList.appendChild(li);
    });
}
        
        // Function to update the personnel table with edit/delete buttons
        function updatePersonnelTable(personnelData) {
    pdoPersonnelTable.innerHTML = `
        <thead>
            <tr>
                <th>Role</th>
                <th>Name</th>
                <th>Accreditation</th>
                <th class="actions">Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Personnel rows will be added here -->
        </tbody>
        <tfoot>
            <tr>
                <td colspan="3">All Personnel</td>
                <td class="actions">
                    <button class="edit-all-personnel-btn" title="Edit All"><i class="fas fa-edit"></i> Edit All</button>
                    <button class="delete-all-personnel-btn" title="Delete All"><i class="fas fa-trash"></i> Delete All</button>
                </td>
            </tr>
        </tfoot>
    `;

    const tbody = pdoPersonnelTable.querySelector('tbody');
    const roles = [
        { key: 'projectEngineer', label: 'Project Engineer' },
        { key: 'projectInspector', label: 'Project Inspector' },
        { key: 'residentEnginneer', label: 'Resident Engineer' },
        { key: 'materialsEngineer', label: 'Materials Engineer' },
        { key: 'provisionalMaterialsEngineer', label: 'Provisional  Materials Engneer' },
        { key: 'provisionalMaterialsInspector', label: 'Provisional Materials Inspector' },
        { key: 'qaInCharge', label: 'QA-Incharge' },
        { key: 'contractorsMaterialsEngineer', label: 'Contractors Materials Engineer' },
    ];

    roles.forEach(role => {
        const person = personnelData[role.key];
        if (person && (person.name || person.accreditation)) {
            const row = document.createElement('tr');
            row.dataset.role = role.key;
            row.innerHTML = `
                <td>${role.label}</td>
                <td>${person.name || '-'}</td>
                <td>${person.accreditation || '-'}</td>
                <td></td> <!-- Empty cell for alignment -->
            `;
            tbody.appendChild(row);
        }
    });

    // Add event listeners for the global buttons
    pdoPersonnelTable.querySelector('.edit-all-personnel-btn').addEventListener('click', () => {
        editAllPersonnel(personnelData);
    });

    pdoPersonnelTable.querySelector('.delete-all-personnel-btn').addEventListener('click', () => {
        deleteAllPersonnel();
    });
}

function editAllPersonnel(personnelData) {
    editingPersonnelId = 'all';
    pdoPersonnelModal.style.display = 'block';
    document.body.classList.add('modal-open');
    
    // Fill the form with all existing data
    for (const role in personnelData) {
        if (personnelData.hasOwnProperty(role)) {
            document.getElementById(role).value = personnelData[role].name || '';
            document.getElementById(`${role}Accred`).value = personnelData[role].accreditation || '';
        }
    }
}
        
function deleteAllPersonnel() {
    if (!currentContractId) return;
    
    if (confirm('Are you sure you want to delete ALL personnel data?')) {
        contractsRef.child(currentContractId).update({
            personnel: null,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            pdoPersonnelTable.querySelector('tbody').innerHTML = '';
            document.querySelector('input[name="pdoAccreditation"][value="no"]').checked = true;
        });
    }
}
        
 function loadPDOData(contractId) {
    contractsRef.child(contractId).once('value').then((snapshot) => {
        const contractData = snapshot.val();
        console.log('Loaded contract data:', contractData); // Debugging
        
        // Set accreditation radio button and load personnel data
        if (contractData && contractData.personnel) {
            document.querySelector('input[name="pdoAccreditation"][value="yes"]').checked = true;
            updatePersonnelTable(contractData.personnel);
            
            // Only call if function exists
            if (typeof populatePersonnelFormFields === 'function') {
                populatePersonnelFormFields(contractData.personnel);
            }
        } else {
            document.querySelector('input[name="pdoAccreditation"][value="no"]').checked = true;
        }
        
        // Load PDO status
        if (contractData && contractData.PDO) {
            const statusField = document.getElementById('pdoStatusField');
            if (statusField) {
                statusField.value = contractData.PDO.status || '';
            }
        }
    }).catch(error => {
        console.error('Error loading PDO data:', error);
    });
}
       // Helper function to check if all personnel data is complete
function isPersonnelDataComplete() {
    const personnelData = {
        projectEngineer: document.getElementById('projectEngineer').value,
        projectEngineerAccred: document.getElementById('projectEngineerAccred').value,
        projectInspector: document.getElementById('projectInspector').value,
        projectInspectorAccred: document.getElementById('projectInspectorAccred').value,
        residentEngineer: document.getElementById('residentEngineer').value,
        residentEngineerAccred: document.getElementById('residentEngineerAccred').value,
        materialsEngineer: document.getElementById('materialsEngineer').value,
        materialsEngineerAccred: document.getElementById('materialsEngineerAccred').value,
        provisionalMaterialsEngineer: document.getElementById('provisionalMaterialsEngineer').value,
        provisionalMaterialsEngineerAccred: document.getElementById('provisionalMaterialsEngineerAccred').value,
        provisionalMaterialsInspector: document.getElementById('provisionalMaterialsInspector').value,
        provisionalMaterialsInspectorAccred: document.getElementById('provisionalMaterialsInspectorAccred').value,
        qaInCharge: document.getElementById('qaInCharge').value,
        qaInChargeAccred: document.getElementById('qaInChargeAccred').value,
        contractorsMaterialsEngineer: document.getElementById('contractorsMaterialsEngineer').value,
        contractorsMaterialsEngineerAccred: document.getElementById('contractorsMaterialsEngineerAccred').value
    };
    
    // Check if all required fields have values
    return Object.values(personnelData).every(value => value.trim() !== '');
}
        
        // Load folders
     function loadFolders() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) return;

    const userId = currentUser.uid;
    const userEmail = currentUser.email;
    const isAdmin = userEmail === 'admin@example.com'; // Adjust as needed

    // Get user display name for name matching
    const userName = currentUser.displayName || '';

    // Fetch user contracts
    database.ref('userContracts/' + userId).once('value').then(userSnapshot => {
        const userContracts = userSnapshot.val();
        const userContractIds = userContracts ? Object.keys(userContracts) : [];

        // Fetch all contracts to check personnel and qaIncharge
        database.ref('contracts').once('value').then(contractsSnapshot => {
            const allContracts = contractsSnapshot.val();
            const additionalContractIds = [];

            if (allContracts) {
                Object.entries(allContracts).forEach(([contractId, contract]) => {
                    // Check personnel subtable
                    const personnel = contract.personnel || {};
                    const isPersonnel = Object.values(personnel).some(p => p.name === userName);

                    // Check qaIncharge
                    const isQAIncharge = contract.qaIncharge && contract.qaIncharge.name === userName;

                    if (isPersonnel || isQAIncharge) {
                        additionalContractIds.push(contractId);
                    }
                });
            }

            // Merge all contractIds: from userContracts, personnel, and qaIncharge
            const visibleContractIds = new Set([...userContractIds, ...additionalContractIds]);

            // Now load folders
            foldersRef.on('value', (snapshot) => {
                const folders = snapshot.val();
                filesContainer.innerHTML = '';

                if (folders) {
                    Object.entries(folders).forEach(([key, folder]) => {
                        if (isAdmin || visibleContractIds.has(folder.contractId)) {
                            createFolderElement(key, folder);
                        }
                    });

                    if (filesContainer.innerHTML === '') {
                        filesContainer.innerHTML = '<p>No folders assigned to your account.</p>';
                    }
                } else {
                    filesContainer.innerHTML = '<p>No folders found.</p>';
                }
            });
        });
    });
}



        function createFolderElement(key, folder) {
            const folderElement = document.createElement('div');
            folderElement.className = `folder folder-${folder.color || 'blue'}`;
            folderElement.dataset.id = key;
            folderElement.innerHTML = `
                <div class="folder-actions">
                    <button class="folder-action-btn edit-btn" title="Edit folder"><i class="fas fa-edit"></i></button>
                    <button class="folder-action-btn delete-btn" title="Delete folder"><i class="fas fa-trash"></i></button>
                </div>
                <div class="folder-icon"><i class="fas fa-folder"></i></div>
                <div class="folder-name">${folder.name}</div>
                <div class="folder-info">${folder.fileCount || 0} files</div>
            `;
            
            folderElement.addEventListener('click', (e) => {
                if (!e.target.closest('.folder-actions')) {
                    openFolderContent(key, folder.name);
                }
            });
            
            folderElement.querySelector('.edit-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                editFolder(key, folder);
            });
            
            folderElement.querySelector('.delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                showDeleteConfirmation(key);
            });
            
            filesContainer.appendChild(folderElement);
        }
        
        // FOLDER CRUD
        function showDeleteConfirmation(folderId) {
            currentFolderId = folderId;
            deleteModal.style.display = 'block';
        }
        
        function deleteFolder(folderId) {
            if (!folderId) return console.error('No folder ID for deletion');
            
            foldersRef.child(folderId).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        alert('Folder not found!');
                        deleteModal.style.display = 'none';
                        return;
                    }
                    return foldersRef.child(folderId).remove();
                })
                .then(() => {
                    deleteModal.style.display = 'none';
                    currentFolderId = null;
                })
                .catch((error) => {
                    console.error('Error deleting folder:', error);
                    alert('Error deleting folder: ' + error.message);
                    deleteModal.style.display = 'none';
                });
        }
        
        function editFolder(folderId, folderData) {
            isEditMode = true;
            currentFolderId = folderId;
            modalTitle.textContent = 'Edit Folder';
            modalSubmitBtn.textContent = 'Update Folder';
            folderForm.reset();
            folderIdInput.value = folderId;
            loadContractsForDropdown().then(() => {
                document.getElementById('contractId').value = folderData.contractId;
                document.getElementById('folderColor').value = folderData.color || 'blue';
                folderModal.style.display = 'block';
            });
        }
        
        function createNewFolder(name, contractId, color) {
            foldersRef.push().set({
                name, 
                contractId, 
                color, 
                fileCount: 0,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                folderModal.style.display = 'none';
                folderForm.reset();
            });
        }
        
        function updateFolder(id, name, contractId, color) {
            foldersRef.child(id).update({
                name, 
                contractId, 
                color,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                folderModal.style.display = 'none';
                folderForm.reset();
            });
        }
   function openFolderContent(folderId, folderName) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    const isAdmin = user.email === 'admin@example.com'; // Adjust this as needed
    const userName = user.displayName || '';

    foldersRef.child(folderId).once('value').then((snapshot) => {
        const folder = snapshot.val();
        if (!folder) return;

        const contractId = folder.contractId;

        // Check if user has access by userContracts
        database.ref('userContracts/' + user.uid + '/' + contractId).once('value').then(accessSnapshot => {
            const hasDirectAccess = accessSnapshot.exists();

            // If admin or has direct access, proceed
            if (isAdmin || hasDirectAccess) {
                proceedWithFolderAccess(folderId, folderName, contractId);
                return;
            }

            // If not, check for personnel access
            return contractsRef.child(contractId).once('value').then(contractSnapshot => {
                const contract = contractSnapshot.val();
                const personnel = contract?.personnel || {};
                const isPersonnel = Object.values(personnel).some(p => p.name === userName);
                
                if (isPersonnel) {
                    proceedWithFolderAccess(folderId, folderName, contractId);
                } else {
                    alert('You do not have access to this folder.');
                }
            });
        });
    });
}

function proceedWithFolderAccess(folderId, folderName, contractId) {
    currentFolderId = folderId;
    currentContractId = contractId;

    folderContentTitle.textContent = folderName;
    currentFolderData = {
        id: folderId,
        name: folderName,
        contractId: contractId
    };

    folderContentModal.style.display = 'block';
    loadPDOData(contractId);
    loadVersionInfo(contractId);
    switchDocumentType('programOfWorks', 'Program of Works');
}


// Add event listeners to version checkboxes
// Update event listeners for version checkboxes

document.getElementById('originalVersion').addEventListener('change', (e) => {
    if (currentContractId) {
        contractsRef.child(currentContractId).update({
            programOfWorksOriginal: e.target.checked,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        });
    }
});

document.getElementById('revisedVersion').addEventListener('change', (e) => {
    if (currentContractId) {
        contractsRef.child(currentContractId).update({
            programOfWorksRevised: e.target.checked,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        });
    }
});

// Fix the plan version checkbox event listeners
document.getElementById('originalPlanVersion').addEventListener('change', (e) => {
    if (currentContractId) {
        contractsRef.child(currentContractId).update({
            originalPlan: e.target.checked,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        });
    }
});

document.getElementById('revisedPlanVersion').addEventListener('change', (e) => {
    if (currentContractId) {
        contractsRef.child(currentContractId).update({
            revisedPlan: e.target.checked,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        });
    }
});

document.getElementById('asStakedPlanVersion').addEventListener('change', (e) => {
    if (currentContractId) {
        contractsRef.child(currentContractId).update({
            asStakedPlan: e.target.checked,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        });
    }
});

document.getElementById('asBuiltPlanVersion').addEventListener('change', (e) => {
    if (currentContractId) {
        contractsRef.child(currentContractId).update({
            asBuiltPlan: e.target.checked,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        });
    }
});

document.getElementById('weeklyCQCAVersion').addEventListener('change', (e) => {
    if (currentContractId) {
        contractsRef.child(currentContractId).update({
            CQCAweekly: e.target.checked,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        });
    }
});

document.getElementById('monthlyCQCAVersion').addEventListener('change', (e) => {
    if (currentContractId) {
        contractsRef.child(currentContractId).update({
            CQCAmonthly: e.target.checked,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        });
    }
});

// Fix the QCP version checkbox event listeners
document.getElementById('originalQCPVersion').addEventListener('change', (e) => {
    if (currentContractId) {
        contractsRef.child(currentContractId).update({
            QCPoriginal: e.target.checked,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        });
    }
});

document.getElementById('revisedQCPVersion').addEventListener('change', (e) => {
    if (currentContractId) {
        contractsRef.child(currentContractId).update({
            QCPrevised: e.target.checked,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        });
    }
});
    

function closeFolderContent() {
    // Remove any dynamically created displays
    const dynamicDisplays = document.querySelectorAll('#concretingReportDetailsDisplay, #concretePermitDetailsDisplay, #acpDetailsDisplay');
    dynamicDisplays.forEach(display => {
        if (display) display.remove();
    });
    
     // Explicitly hide all modals when closing folder
    document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
    });
    folderContentModal.style.display = 'none';
    currentFolderData = null;
    currentContractId = null;
    
    qaMenuLinks.forEach(link => link.classList.remove('active'));
    currentDocumentCategory = null;
    currentDocumentType.textContent = '';
    
    document.getElementById('versionSelection').style.display = 'none';
    document.getElementById('acpDetailsDisplay').style.display = 'none';
}


        tabButtons.forEach(btn => btn.addEventListener('click', () => {
    switchTab(btn.dataset.tab);
    if (btn.dataset.tab === 'pdo') {
        initializePDOTab();
    }
}));
        
    function switchTab(tabId) {
    // Don't hide modals when switching tabs
    const openModals = document.querySelectorAll('.modal[style*="display: block"]');
    
    tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
    tabContents.forEach(content => content.classList.toggle('active', content.id === tabId));
    
    // If PDO tab is selected, initialize it
    if (tabId === 'pdo') {
        initializePDOTab();
    }
    
    // Restore any open modals
    openModals.forEach(modal => {
        modal.style.display = 'block';
    });
}

function switchDocumentType(type, name) {
    if (!type) {
        console.error("Error: 'type' is undefined!");
        return;
    }

    // Hide all modals and special displays first
    hideAllModalsAndDisplays();

    // Set current document type
    currentDocumentCategory = type;
    currentDocumentType.textContent = name;

    // Hide all document-specific containers first
    const containersToHide = [
        'materialsTestingContainer',
        'materialsLogbookContainer',
        'siteInstructionsContainer',
        'statusTestContainer',
        'summaryFieldTestContainer',
        'timeSuspensionContainer',
        'timeExtensionContainer',
        'resumptionOrderContainer',
        'swaContainer',
        'designMixScannedContainer',
        'acpContainer',
        'variationOrdersContainer',
        'trialMixContainer'
    ];
    
    containersToHide.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });

    // Reset version selection and file upload visibility
    document.getElementById('versionSelection').style.display = 'none';
    document.getElementById('fileUploadArea').style.display = 'none';

    // Handle specific document types
    switch(type) {
        case 'programOfWorks':
            document.getElementById('fileUploadArea').style.display = 'block';
            document.getElementById('versionSelection').style.display = 'block';
            document.querySelectorAll('.version-options').forEach((el, index) => {
                el.style.display = index === 0 ? 'flex' : 'none';
            });
            loadFilesForCurrentDocument();
            break;
            
        case 'plans':
            document.getElementById('fileUploadArea').style.display = 'block';
            document.getElementById('versionSelection').style.display = 'block';
            document.querySelectorAll('.version-options').forEach((el, index) => {
                el.style.display = index === 1 ? 'flex' : 'none';
            });
            loadFilesForCurrentDocument();
            break;
            
        case 'qualityControlProgram':
            document.getElementById('fileUploadArea').style.display = 'block';
            document.getElementById('versionSelection').style.display = 'block';
            document.querySelectorAll('.version-options').forEach((el, index) => {
                el.style.display = index === 2 ? 'flex' : 'none';
            });
            loadFilesForCurrentDocument();
            break;
            
        case 'cqca':
            document.getElementById('fileUploadArea').style.display = 'block';
            document.getElementById('versionSelection').style.display = 'block';
            document.querySelectorAll('.version-options').forEach((el, index) => {
                el.style.display = index === 3 ? 'flex' : 'none';
            });
            loadFilesForCurrentDocument();
            break;
            
        case 'materialsTestingReport':
            document.getElementById('materialsTestingContainer').style.display = 'block';
            initializeMaterialsTestingReport();
            break;
            
       case 'materialsLogbook':
    document.getElementById('materialsLogbookContainer').style.display = 'block';
    initializeMaterialsLogbook();
    break;
        case 'siteInstructions':
            document.getElementById('siteInstructionsContainer').style.display = 'block';
            loadSiteInstructions();
            break;
            
        case 'statusOfTest':
            document.getElementById('statusTestContainer').style.display = 'block';
            loadStatusTests();
            break;
            
        case 'summaryOfFieldTest':
            document.getElementById('summaryFieldTestContainer').style.display = 'block';
            loadSummaryFieldTestData();
            break;
            
        case 'timeSuspensionReport':
            document.getElementById('timeSuspensionContainer').style.display = 'block';
            loadTimeSuspensionReports();
            break;
            
        case 'timeExtensionReport':
            document.getElementById('timeExtensionContainer').style.display = 'block';
            loadTimeExtensionReports();
            break;
            
        case 'resumptionOrder':
            document.getElementById('resumptionOrderContainer').style.display = 'block';
            loadResumptionOrders();
            break;
            
        case 'swa':
            document.getElementById('swaContainer').style.display = 'block';
            loadSWAs();
            break;
            
        case 'designMix':
            document.getElementById('designMixScannedContainer').style.display = 'block';
            loadDesignMixScannedStatus();
            document.getElementById('fileUploadArea').style.display = 'block';
            loadFilesForCurrentDocument();
            break;
            
        case 'concretePouringPermits':
            loadConcretePermitData();
            document.getElementById('fileUploadArea').style.display = 'block';
            loadFilesForCurrentDocument();
            break;
            
        case 'asphaltConcretePavement':
            loadACPData();
            document.getElementById('fileUploadArea').style.display = 'block';
            loadFilesForCurrentDocument();
            break;
            
        case 'reportOnConcretingWorks':
            loadConcretingReportData();
            document.getElementById('fileUploadArea').style.display = 'block';
            loadFilesForCurrentDocument();
            break;

        case 'variationOrders':
            document.getElementById('variationOrdersContainer').style.display = 'block';
            document.getElementById('fileUploadArea').style.display = 'block';
            loadVariationOrders();
            loadFilesForCurrentDocument();
            break;

          case 'trialMix':
        document.getElementById('trialMixContainer').style.display = 'block';
        loadTrialMix();
        break;
            
        default:
            document.getElementById('fileUploadArea').style.display = 'block';
            loadFilesForCurrentDocument();
            break;
    }

    // Update active menu item
    qaMenuLinks.forEach(link => link.classList.remove('active'));
    const activeLink = document.querySelector(`.qa-menu-link[data-content="${type}"]`);
    if (activeLink) {
        activeLink.classList.add('active');
    }

     if (type === 'designMix') {
        initializeDesignMix();
    }
}

acpntlApprovalRadios.forEach(radio => {
  radio.addEventListener('change', () => {
    acpntlReasonGroup.style.display = radio.value === 'disapproved' ? 'block' : 'none';
  });
});

function loadACPData() {
    if (!currentContractId) return;
    
    // Double-check we're on the correct tab
    if (currentDocumentCategory !== 'asphaltConcretePavement') {
        return;
    }

    // Ensure the ACP container exists
    let acpContainer = document.getElementById('acpContainer');
    if (!acpContainer) {
        acpContainer = document.createElement('div');
        acpContainer.id = 'acpContainer';
        acpContainer.className = 'acp-container';
        document.querySelector('.qa-content').insertBefore(acpContainer, document.querySelector('.file-upload-area'));
    }

    // Ensure the details display exists
    let acpDetailsDisplay = document.getElementById('acpDetailsDisplay');
    if (!acpDetailsDisplay) {
        acpDetailsDisplay = document.createElement('div');
        acpDetailsDisplay.id = 'acpDetailsDisplay';
        acpContainer.appendChild(acpDetailsDisplay);
    }

    // Show the container
    acpContainer.style.display = 'block';

    // Check for existing ACP data
    contractsRef.child(currentContractId).child('acpntl').once('value').then(snapshot => {
        const data = snapshot.val();
        
        if (data) {
            // Update the display with existing data
            updateAcpDetailsDisplay(data);
        } else {
            // Show "no data" message with "Add Details" button
            showNoAcpData();
            // Automatically open the modal since there's no data
            openAcpntlModal();
        }
    }).catch(error => {
        console.error('Error loading ACP data:', error);
        showNoAcpData();
        openAcpntlModal();
    });
}

function showNoAcpData() {
    const acpDetailsDisplay = document.getElementById('acpDetailsDisplay');
    if (!acpDetailsDisplay) return;
    
    acpDetailsDisplay.innerHTML = `
        <div class="acp-no-data">
            <p>No data available for Asphalt Concrete Pavement.</p>
            <button class="acp-add-btn" id="addAcpBtn">
                <i class="fas fa-plus"></i> Add Details
            </button>
        </div>
    `;
    
    // Set up the "Add Details" button to open the modal
    document.getElementById('addAcpBtn').addEventListener('click', () => {
        openAcpntlModal();
    });
}


        // Modified function to show modal with data (or empty form)
        function showAcpntlModalWithData(data) {
    // Hide display and show form
    document.getElementById('acpntlDataDisplay').style.display = 'none';
    document.getElementById('acpntlForm').style.display = 'block';
    
    if (data) {
        // Populate form with existing data
        document.getElementById('acpntlStatus').value = data.status || '';
        document.getElementById('acpntlStation').value = data.station || '';
        document.getElementById('acpntlVolume').value = data.volume || '';
        document.getElementById('acpntlDate').value = data.date || '';
        
        // Set job mix radio
        document.querySelector(`input[name="acpntlJobMix"][value="${data.jobMix || 'no'}"]`).checked = true;
        
        // Set approval radio
        document.querySelector(`input[name="acpntlApproval"][value="${data.approval || 'approved'}"]`).checked = true;
        
        // Show/hide reason field
        acpntlReasonGroup.style.display = data.approval === 'disapproved' ? 'block' : 'none';
        document.getElementById('acpntlReason').value = data.reason || '';
    } else {
        // Reset form for new entry
        document.getElementById('acpntlForm').reset();
        acpntlReasonGroup.style.display = 'none';
    }
    
    // Show the modal
    acpntlModal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}
// Form submission handler
acpntlForm.addEventListener('submit', (e) => {
    e.preventDefault();
    
    if (!currentContractId) return;
    
    const acpntlData = {
        status: document.getElementById('acpntlStatus').value,
        station: document.getElementById('acpntlStation').value,
        volume: parseFloat(document.getElementById('acpntlVolume').value),
        date: document.getElementById('acpntlDate').value,
        jobMix: document.querySelector('input[name="acpntlJobMix"]:checked').value,
        approval: document.querySelector('input[name="acpntlApproval"]:checked').value,
        reason: document.querySelector('input[name="acpntlApproval"]:checked').value === 'disapproved' 
               ? document.getElementById('acpntlReason').value 
               : '',
        updatedAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    // Save to Firebase
    contractsRef.child(currentContractId).child('acpntl').set(acpntlData)
        .then(() => {
            // Close the modal
            acpntlModal.style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // Update the display immediately with the new data
            populateAcpntlDisplay(acpntlData);
            
            // Also update the ACP details display in the folder content
            updateAcpDetailsDisplay(acpntlData);
        })
        .catch(error => {
            console.error('Error saving ACP data:', error);
            alert('Error saving data. Please try again.');
        });
});


document.getElementById('editAcpntlBtn').addEventListener('click', () => {
  const dataDisplay = document.getElementById('acpntlDataDisplay');
  if (dataDisplay) dataDisplay.style.display = 'none';
  acpntlForm.style.display = 'block';
});


// Add this to load version info for plans and QCP
// Update the loadVersionInfo function to properly load all versions
function loadVersionInfo(contractId) {
    contractsRef.child(contractId).once('value').then((snapshot) => {
        const contractData = snapshot.val();
        if (contractData) {
            // Program of Works versions
            if (contractData.programOfWorksOriginal !== undefined) {
                document.getElementById('originalVersion').checked = contractData.programOfWorksOriginal;
            }
            if (contractData.programOfWorksRevised !== undefined) {
                document.getElementById('revisedVersion').checked = contractData.programOfWorksRevised;
            }
            
            // Plan versions
            if (contractData.originalPlan !== undefined) {
                document.getElementById('originalPlanVersion').checked = contractData.originalPlan;
            }
            if (contractData.revisedPlan !== undefined) {
                document.getElementById('revisedPlanVersion').checked = contractData.revisedPlan;
            }
            if (contractData.asStakedPlan !== undefined) {
                document.getElementById('asStakedPlanVersion').checked = contractData.asStakedPlan;
            }
            if (contractData.asBuiltPlan !== undefined) {
                document.getElementById('asBuiltPlanVersion').checked = contractData.asBuiltPlan;
            }
            
            // QCP versions
            if (contractData.QCPoriginal !== undefined) {
                document.getElementById('originalQCPVersion').checked = contractData.QCPoriginal;
            }
            if (contractData.QCPrevised !== undefined) {
                document.getElementById('revisedQCPVersion').checked = contractData.QCPrevised;
            }
            if (contractData.CQCAweekly !== undefined) {
                document.getElementById('weeklyCQCAVersion').checked = contractData.CQCAweekly;
            }
            if (contractData.CQCAmonthly !== undefined) {
                document.getElementById('monthlyCQCAVersion').checked = contractData.CQCAmonthly;
            }
        }
    });
}

        
        // HELPER FUNCTIONS
        function loadContractsForDropdown() {
            return contractsRef.once('value').then((snapshot) => {
                const contracts = snapshot.val();
                contractSelect.innerHTML = '<option value="">Select a Contract</option>';
                if (contracts) {
                    Object.entries(contracts).forEach(([key, contract]) => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = contract.contractId || `Contract ${key}`;
                        contractSelect.appendChild(option);
                    });
                }
                return contracts;
            });
        }
        
        // EVENT LISTENERS
       addFolderBtn.addEventListener('click', () => {
    const user = firebase.auth().currentUser;
    if (!user || !user.isAdmin) {
        alert('Only administrators can create folders.');
        return;
    }
    
    isEditMode = false;
    modalTitle.textContent = 'Create New Folder';
    modalSubmitBtn.textContent = 'Create Folder';
    folderForm.reset();
    folderIdInput.value = '';
    loadContractsForDropdown();
    folderModal.style.display = 'block';
});
        
        closeBtn.addEventListener('click', () => {
            folderModal.style.display = 'none';
            isEditMode = false;
            currentFolderId = null;
            folderForm.reset();
        });
        
        window.addEventListener('click', (event) => {
            if (event.target === folderModal) {
                folderModal.style.display = 'none';
                isEditMode = false;
                currentFolderId = null;
                folderForm.reset();
            }
            if (event.target === deleteModal) {
                deleteModal.style.display = 'none';
            }
            if (event.target === folderContentModal) {
                closeFolderContent();
            }
            if (event.target === pdoPersonnelModal) {
                pdoPersonnelModal.style.display = 'none';
                document.body.classList.remove('modal-open');
                editingPersonnelId = null;
            }
        });
        
        folderForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const contractId = document.getElementById('contractId').value;
            const folderColor = document.getElementById('folderColor').value;
            if (!contractId) return alert('Please select a contract');
        
            if (!isEditMode) {
                foldersRef.orderByChild('contractId').equalTo(contractId).once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            alert('A folder already exists for this contract.');
                            return;
                        }
                        proceedWithFolderCreationOrUpdate(contractId, folderColor);
                    });
            } else {
                proceedWithFolderCreationOrUpdate(contractId, folderColor);
            }
        });
        
        function proceedWithFolderCreationOrUpdate(contractId, folderColor) {
            contractsRef.child(contractId).once('value').then((snapshot) => {
                const contract = snapshot.val();
                if (!contract) return alert('Selected contract not found');
                const folderName = contract.contractId;
                if (isEditMode && currentFolderId) {
                    updateFolder(currentFolderId, folderName, contractId, folderColor);
                } else {
                    createNewFolder(folderName, contractId, folderColor);
                }
            });
        }
        
        confirmDeleteBtn.addEventListener('click', () => {
            if (currentFolderId) {
                deleteFolder(currentFolderId);
            } else {
                deleteModal.style.display = 'none';
            }
        });
        
        cancelDeleteBtn.addEventListener('click', () => {
            deleteModal.style.display = 'none';
            currentFolderId = null;
        });
        
        closeFolderBtn.addEventListener('click', closeFolderContent);
        
        tabButtons.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
        
        qaMenuLinks.forEach(link => link.addEventListener('click', (e) => {
            e.preventDefault();
            switchDocumentType(link.dataset.content, link.textContent);
        }));
        
 

async function checkFolderAccess(userId, folderId) {
    const folderSnapshot = await foldersRef.child(folderId).once('value');
    const folder = folderSnapshot.val();
    if (!folder) return false;
    
    // Check direct access
    const accessSnapshot = await database.ref('userContracts/' + userId + '/' + folder.contractId).once('value');
    if (accessSnapshot.exists()) return true;
    
    // Check personnel access
    const user = firebase.auth().currentUser;
    if (!user) return false;
    
    const contractSnapshot = await contractsRef.child(folder.contractId).once('value');
    const contract = contractSnapshot.val();
    if (!contract || !contract.personnel) return false;
    
    const userName = user.displayName;
    if (!userName) return false;
    
    // Check all personnel fields for matching name
    for (const role in contract.personnel) {
        if (contract.personnel[role].name === userName) {
            return true;
        }
    }
    
    return false;
}

        
   // Add this to your file input change handler
   fileInput.addEventListener('change', async (e) => {
    const files = e.target.files;
    if (files.length === 0) return;
     // Determine versions based on document type
    let versions = [];
    const versionCheckboxes = document.querySelectorAll(`input[name^="${currentDocumentCategory}Version"]:checked`);
    
      const user = firebase.auth().currentUser;
    if (!user) return;
    
    const hasAccess = await checkFolderAccess(user.uid, currentFolderId);
    if (!hasAccess) {
        alert('You do not have permission to upload files to this folder');
        fileInput.value = '';
        return;
    }
    
    // Check versions based on document type
    if (currentDocumentCategory === 'programOfWorks') {
        const versionCheckboxes = document.querySelectorAll('input[name="documentVersion"]:checked');
        if (versionCheckboxes.length === 0) {
            alert('Please select at least one version (Original/Revised)');
            return;
        }
        versions = Array.from(versionCheckboxes).map(cb => cb.value);
    } 
    else if (currentDocumentCategory === 'plans') {
        const versionCheckboxes = document.querySelectorAll('input[name="planVersion"]:checked');
        if (versionCheckboxes.length === 0) {
            alert('Please select at least one plan version');
            return;
        }
        versions = Array.from(versionCheckboxes).map(cb => cb.value);
    }
    else if (currentDocumentCategory === 'qcp') {
        const versionCheckboxes = document.querySelectorAll('input[name="qcpVersion"]:checked');
        if (versionCheckboxes.length === 0) {
            alert('Please select at least one QCP version');
            return;
        }
        versions = Array.from(versionCheckboxes).map(cb => cb.value);
    }
    
    // Update the contract with version information using the specified field names
    const versionData = {};
    if (currentDocumentCategory === 'programOfWorks') {
        versionData.programOfWorksOriginal = versions.includes('original');
        versionData.programOfWorksRevised = versions.includes('revised');
    } 
    else if (currentDocumentCategory === 'plans') {
        versionData.originalPlan = versions.includes('original');
        versionData.revisedPlan = versions.includes('revised');
        versionData.asStakedPlan = versions.includes('asStaked');
        versionData.asBuiltPlan = versions.includes('asBuilt');
    }
    else if (currentDocumentCategory === 'qcp') {
        versionData.QCPoriginal = versions.includes('original');
        versionData.QCPrevised = versions.includes('revised');
    }
    
    versionData.updatedAt = firebase.database.ServerValue.TIMESTAMP;
    
    try {
        await contractsRef.child(currentContractId).update(versionData);
        
        const storageRef = firebase.storage().ref();
        const dbRef = database.ref(`folderDocuments/${currentFolderId}/${currentDocumentCategory}`);
        
        // Upload each file
        for (const file of files) {
            const filePath = `folders/${currentFolderId}/${currentDocumentCategory}/${Date.now()}_${file.name}`;
            const fileRef = storageRef.child(filePath);
            
            await fileRef.put(file);
            const downloadURL = await fileRef.getDownloadURL();
            
            await dbRef.push().set({
                name: file.name,
                url: downloadURL,
                versions: versions,
                uploadedAt: firebase.database.ServerValue.TIMESTAMP,
                uploadedBy: "admin"
            });
        }
        
        alert('Files uploaded successfully!');
        fileInput.value = '';
    } catch (error) {
        console.error('Error uploading files:', error);
        alert('Error uploading files: ' + error.message);
    }

   
    
    if (versionCheckboxes.length > 0) {
        versions = Array.from(versionCheckboxes).map(cb => cb.value);
    } else {
        // Default to 'original' if no version is selected for document types that support versions
        if (['programOfWorks', 'plans', 'qualityControlProgram', 'cqca'].includes(currentDocumentCategory)) {
            versions = ['original'];
        }
    }

    try {
        const storageRef = firebase.storage().ref();
        const dbRef = database.ref(`folderDocuments/${currentFolderId}/${currentDocumentCategory}`);
        
        // Update version info in contracts if needed
        if (versions.length > 0) {
            const versionData = {};
            
            if (currentDocumentCategory === 'programOfWorks') {
                versionData.programOfWorksOriginal = versions.includes('original');
                versionData.programOfWorksRevised = versions.includes('revised');
            } 
            else if (currentDocumentCategory === 'plans') {
                versionData.originalPlan = versions.includes('original');
                versionData.revisedPlan = versions.includes('revised');
                versionData.asStakedPlan = versions.includes('asStaked');
                versionData.asBuiltPlan = versions.includes('asBuilt');
            }
            else if (currentDocumentCategory === 'qualityControlProgram') {
                versionData.QCPoriginal = versions.includes('original');
                versionData.QCPrevised = versions.includes('revised');
            }
            else if (currentDocumentCategory === 'cqca') {
                versionData.CQCAweekly = versions.includes('weekly');
                versionData.CQCAmonthly = versions.includes('monthly');
            }
            
            if (Object.keys(versionData).length > 0) {
                versionData.updatedAt = firebase.database.ServerValue.TIMESTAMP;
                await contractsRef.child(currentContractId).update(versionData);
            }
        }



        // Upload each file
        for (const file of files) {
            // Create a unique filename with timestamp and original name
            const timestamp = Date.now();
            const fileExt = file.name.split('.').pop();
            const fileName = `${timestamp}_${file.name.replace(/\s+/g, '_')}`;
            
            const filePath = `folders/${currentFolderId}/${currentDocumentCategory}/${fileName}`;
            const fileRef = storageRef.child(filePath);
            
            // Show upload progress
            const uploadTask = fileRef.put(file);
            
            uploadTask.on('state_changed', 
                (snapshot) => {
                    // Progress tracking could be added here
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log(`Upload is ${progress}% done`);
                },
                (error) => {
                    console.error('Upload error:', error);
                    throw error;
                }
            );
            
            // Wait for upload to complete
            await uploadTask;
            
            // Get download URL
            const downloadURL = await fileRef.getDownloadURL();
            
            // Save file metadata to database
            await dbRef.push().set({
                name: file.name,
                url: downloadURL,
                size: file.size,
                type: file.type,
                versions: versions.length > 0 ? versions : null,
                uploadedAt: firebase.database.ServerValue.TIMESTAMP,
                uploadedBy: "admin" // You might want to replace this with actual user info
            });
        }
        
        alert('Files uploaded successfully!');
        fileInput.value = ''; // Reset file input
        loadFilesForCurrentDocument(); // Refresh the file list
    } catch (error) {
        console.error('Error uploading files:', error);
        alert('Error uploading files: ' + error.message);
    }
});

document.getElementById('originalPlanVersion').addEventListener('change', function(e) {
    if (currentContractId) {
        contractsRef.child(currentContractId).update({
            originalPlan: e.target.checked,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        });
    }
});

document.getElementById('revisedPlanVersion').addEventListener('change', function(e) {
    if (currentContractId) {
        contractsRef.child(currentContractId).update({
            revisedPlan: e.target.checked,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        });
    }
});

document.getElementById('asStakedPlanVersion').addEventListener('change', function(e) {
    if (currentContractId) {
        contractsRef.child(currentContractId).update({
            asStakedPlan: e.target.checked,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        });
    }
});

document.getElementById('asBuiltPlanVersion').addEventListener('change', function(e) {
    if (currentContractId) {
        contractsRef.child(currentContractId).update({
            asBuiltPlan: e.target.checked,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        });
    }
});

function loadVersionInfo(contractId) {
    contractsRef.child(contractId).once('value').then((snapshot) => {
        const contractData = snapshot.val();
        if (contractData) {
            // Program of Works versions
            if (contractData.programOfWorksOriginal !== undefined) {
                document.getElementById('originalVersion').checked = contractData.programOfWorksOriginal;
            }
            if (contractData.programOfWorksRevised !== undefined) {
                document.getElementById('revisedVersion').checked = contractData.programOfWorksRevised;
            }
            
            // Plan versions
            if (contractData.originalPlan !== undefined) {
                document.getElementById('originalPlanVersion').checked = contractData.originalPlan;
            }
            if (contractData.revisedPlan !== undefined) {
                document.getElementById('revisedPlanVersion').checked = contractData.revisedPlan;
            }
            if (contractData.asStakedPlan !== undefined) {
                document.getElementById('asStakedPlanVersion').checked = contractData.asStakedPlan;
            }
            if (contractData.asBuiltPlan !== undefined) {
                document.getElementById('asBuiltPlanVersion').checked = contractData.asBuiltPlan;
            }
            
            // QCP versions
            if (contractData.QCPoriginal !== undefined) {
                document.getElementById('originalQCPVersion').checked = contractData.QCPoriginal;
            }
            if (contractData.QCPrevised !== undefined) {
                document.getElementById('revisedQCPVersion').checked = contractData.QCPrevised;
            }
            if (contractData.CQCAweekly !== undefined) {
                document.getElementById('weeklyCQCAVersion').checked = contractData.CQCAweekly;
            }
            if (contractData.CQCAmonthly !== undefined) {
                document.getElementById('monthlyCQCAVersion').checked = contractData.CQCAmonthly;
            }
        }
    });
}

// Function to check if all fields are complete
async function checkAllFieldsComplete() {
    // Check basic fields
    const remarksValue = document.getElementById('pdoRemarks').value.trim();
    if (!remarksValue) return false;
    
    // Check accreditation status
    const accreditationValue = document.querySelector('input[name="pdoAccreditation"]:checked')?.value;
    if (!accreditationValue) return false;
    
    // If accreditation is "yes", check all personnel fields
    if (accreditationValue === 'yes') {
        const personnelFields = [
            'projectEngineer', 'projectEngineerAccred',
            'projectInspector', 'projectInspectorAccred',
            'residentEngineer', 'residentEngineerAccred',
            'materialsEngineer', 'materialsEngineerAccred',
            'provisionalMaterialsEngineer', 'provisionalMaterialsEngineerAccred',
            'provisionalMaterialsInspector', 'provisionalMaterialsInspectorAccred',
            'qaInCharge', 'qaInChargeAccred',
            'contractorsMaterialsEngineer', 'contractorsMaterialsEngineerAccred'
        ];
        
        for (const fieldId of personnelFields) {
            const fieldValue = document.getElementById(fieldId)?.value.trim();
            if (!fieldValue) return false;
        }
    }
    
    return true;
}

// Add this to show which fields are missing
function highlightMissingFields() {
    document.querySelectorAll('input[required], textarea[required]').forEach(input => {
        if (!input.value.trim()) {
            input.style.border = '1px solid red';
        } else {
            input.style.border = '';
        }
    });
}

      

document.querySelector('.qa-menu-link[data-content="concretePouringPermits"]').addEventListener('click', function(e) {
    e.preventDefault();
    currentDocumentCategory = 'concretePouringPermits';
    currentDocumentType.textContent = 'Concrete Pouring Permits';
    
    // Hide ALL other modals and content displays
    hideAllModalsAndDisplays();
    
    // Now handle concrete permit data
    loadConcretePermitData();
});

function hideAllModalsAndDisplays() {
    // Hide all modals
    document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
    });
    
    // Hide special displays but preserve file upload area
    const displaysToHide = [
        'concretePermitDetailsDisplay',
        'concretingReportDetailsDisplay',
        'acpDetailsDisplay',
        'materialsTestingContainer',
        'materialsLogbookContainer',
        'siteInstructionsContainer',
        'statusTestContainer',
        'summaryFieldTestContainer',
        'timeSuspensionContainer',
        'timeExtensionContainer',
        'resumptionOrderContainer',
        'swaContainer',
        'designMixScannedContainer'
    ];
    
    displaysToHide.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });
}
function openConcretePermitModal() {
    // Only proceed if we're on the correct document type
    if (currentDocumentCategory !== 'concretePouringPermits') return;
    
    // Close any other open modals first
    document.querySelectorAll('.modal').forEach(modal => {
        if (modal.id !== 'concretePermitModal') {
            modal.style.display = 'none';
        }
    });
    
    if (!currentContractId) return;
    
    // Reset the modal first
    document.getElementById('concretePermitDataDisplay').style.display = 'none';
    document.getElementById('concretePermitForm').style.display = 'none';
    
    // Load existing data if available
    contractsRef.child(currentContractId).child('concretePermits').once('value').then(snapshot => {
        const data = snapshot.val();
        
        if (data) {
            // Show the data display and hide the form
            document.getElementById('concretePermitDataDisplay').style.display = 'block';
            populateConcretePermitDisplay(data);
        } else {
            // No data exists, show the form for new entry
            document.getElementById('concretePermitForm').style.display = 'block';
            document.getElementById('concretePermitForm').reset();
            concretePermitReasonGroup.style.display = 'none';
        }
        
        // Show the modal
        concretePermitModal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    });
}

function showConcretePermitModalWithData(data) {
    // Hide display and show form
    document.getElementById('concretePermitDataDisplay').style.display = 'none';
    document.getElementById('concretePermitForm').style.display = 'block';
    
    // Reset form first
    document.getElementById('concretePermitForm').reset();
    concretePermitReasonGroup.style.display = 'none';
    
    if (data) {
        // Populate form with existing data
        document.getElementById('concretePermitStatus').value = data.status || '';
        document.getElementById('concretePermitStation').value = data.station || '';
        document.getElementById('concretePermitVolume').value = data.volume || '';
        document.getElementById('concretePermitDate').value = data.date || '';
        
        // Set approval radio
        document.querySelector(`input[name="concretePermitApproval"][value="${data.approval || 'approved'}"]`).checked = true;
        
        // Show/hide reason field
        concretePermitReasonGroup.style.display = data.approval === 'disapproved' ? 'block' : 'none';
        document.getElementById('concretePermitReason').value = data.reason || '';
    }
}

// Show/hide reason field based on approval status
concretePermitApprovalRadios.forEach(radio => {
    radio.addEventListener('change', () => {
        concretePermitReasonGroup.style.display = radio.value === 'disapproved' ? 'block' : 'none';
        if (radio.value !== 'disapproved') {
            document.getElementById('concretePermitReason').value = '';
        }
    });
});

concretePermitForm.addEventListener('submit', (e) => {
    e.preventDefault();
    
    if (!currentContractId) return;
    
    const concretePermitData = {
        status: document.getElementById('concretePermitStatus').value,
        station: document.getElementById('concretePermitStation').value,
        volume: parseFloat(document.getElementById('concretePermitVolume').value),
        date: document.getElementById('concretePermitDate').value,
        approval: document.querySelector('input[name="concretePermitApproval"]:checked').value,
        reason: document.querySelector('input[name="concretePermitApproval"]:checked').value === 'disapproved' 
               ? document.getElementById('concretePermitReason').value 
               : '',
        updatedAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    // Save to Firebase
    contractsRef.child(currentContractId).child('concretePermits').set(concretePermitData)
        .then(() => {
            // Close the modal
            concretePermitModal.style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // Update the display immediately with the new data
            populateConcretePermitDisplay(concretePermitData);
            updateConcretePermitDetailsDisplay(concretePermitData); // Add this line
        })
        .catch(error => {
            console.error('Error saving concrete permit data:', error);
            alert('Error saving data. Please try again.');
        });
});


// Update the populateConcretePermitDisplay function to also update the main display
function populateConcretePermitDisplay(data) {
    // Format dates for display
    const formatDate = (dateStr) => {
        if (!dateStr) return 'N/A';
        const date = new Date(dateStr);
        return date.toLocaleDateString();
    };
    
    // Populate the display fields in the modal
    document.getElementById('displayConcretePermitStatus').textContent = formatDate(data.status) || 'N/A';
    document.getElementById('displayConcretePermitStation').textContent = data.station || 'N/A';
    document.getElementById('displayConcretePermitVolume').textContent = data.volume ? `${data.volume} cu.m` : 'N/A';
    document.getElementById('displayConcretePermitDate').textContent = formatDate(data.date) || 'N/A';
    document.getElementById('displayConcretePermitApproval').textContent = data.approval === 'approved' ? 'Approved' : 'Disapproved';
    
    if (data.approval === 'disapproved' && data.reason) {
        document.getElementById('displayConcretePermitReasonRow').style.display = 'flex';
        document.getElementById('displayConcretePermitReason').textContent = data.reason;
    } else {
        document.getElementById('displayConcretePermitReasonRow').style.display = 'none';
    }
    
    // Update the main display in the QA Documents tab
    updateConcretePermitDetailsDisplay(data);
    
    // Set up edit button
    document.getElementById('editConcretePermitBtn').onclick = () => {
        showConcretePermitModalWithData(data);
    };
}

document.querySelector('#concretePermitModal .close').addEventListener('click', () => {
    concretePermitModal.style.display = 'none';
    document.body.style.overflow = 'auto';
});

// Close modal when clicking outside
window.addEventListener('click', (e) => {
    if (e.target === concretePermitModal) {
        concretePermitModal.style.display = 'none';
    }
});

function loadConcretePermitData() {
    // Double-check we're on the correct tab
    if (currentDocumentCategory !== 'concretePouringPermits') {
        concretePermitModal.style.display = 'none';
        return;
    }

    if (!currentContractId) return;
    
    contractsRef.child(currentContractId).child('concretePermits').once('value').then(snapshot => {
        const data = snapshot.val();
        
        if (data) {
            updateConcretePermitDetailsDisplay(data);
            // Ensure modal is hidden when we have data
            concretePermitModal.style.display = 'none';
        } else {
            showNoConcretePermitData();
            // Only show modal if we're on the correct tab AND no data exists
            if (currentDocumentCategory === 'concretePouringPermits') {
                openConcretePermitModal();
            }
        }
    });
}
function updateConcretePermitDetailsDisplay(data) {
    let detailsDisplay = document.getElementById('concretePermitDetailsDisplay');
    
    if (!detailsDisplay) {
        // Create the display if it doesn't exist
        detailsDisplay = document.createElement('div');
        detailsDisplay.id = 'concretePermitDetailsDisplay';
        detailsDisplay.className = 'acp-details-container';
        document.querySelector('.qa-content').insertBefore(detailsDisplay, document.querySelector('.file-upload-area'));
    }
    
    // Format dates for display
    const formatDate = (dateStr) => {
        if (!dateStr) return 'N/A';
        const date = new Date(dateStr);
        return date.toLocaleDateString();
    };
    
    detailsDisplay.innerHTML = `
        <div class="acp-details">
           
            <div class="detail-row">
                <span class="detail-label">Status Date:</span>
                <span>${formatDate(data.status) || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Part of Structure/Station:</span>
                <span>${data.station || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Volume (cu.m):</span>
                <span>${data.volume ? `${data.volume} cu.m` : 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Date of Pouring:</span>
                <span>${formatDate(data.date) || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Approval Status:</span>
                <span>${data.approval === 'approved' ? 'Approved' : 'Disapproved'}</span>
            </div>
            ${data.approval === 'disapproved' && data.reason ? `
            <div class="detail-row">
                <span class="detail-label">Reason for Disapproval:</span>
                <span>${data.reason}</span>
            </div>
            ` : ''}
            <div class="acp-actions">
                <button class="edit-btn" id="editConcretePermitDetailsBtn">
                    <i class="fas fa-edit"></i> Edit Details
                </button>
                <button class="delete-btn" id="deleteConcretePermitDetailsBtn">
                    <i class="fas fa-trash"></i> Delete Details
                </button>
            </div>
        </div>
    `;
    
    // Set up event listeners
    document.getElementById('editConcretePermitDetailsBtn').addEventListener('click', () => {
        openConcretePermitModal();
    });
    
    document.getElementById('deleteConcretePermitDetailsBtn').addEventListener('click', () => {
        if (confirm('Are you sure you want to delete these concrete permit details?')) {
            contractsRef.child(currentContractId).child('concretePermits').remove()
                .then(() => {
                    showNoConcretePermitData();
                })
                .catch(error => {
                    console.error('Error deleting concrete permit data:', error);
                    alert('Error deleting data. Please try again.');
                });
        }
    });
    
    detailsDisplay.style.display = 'flex';
}
function showNoConcretePermitData() {
    let detailsDisplay = document.getElementById('concretePermitDetailsDisplay');
    
    if (!detailsDisplay) {
        detailsDisplay = document.createElement('div');
        detailsDisplay.id = 'concretePermitDetailsDisplay';
        detailsDisplay.className = 'acp-details-container';
        document.querySelector('.qa-content').insertBefore(detailsDisplay, document.querySelector('.file-upload-area'));
    }
    
    detailsDisplay.innerHTML = `
        <div class="acp-no-data">
            <p>No data available for Concrete Pouring Permits</p>
            <button class="acp-add-btn" id="addConcretePermitBtn">
                <i class="fas fa-plus"></i> Add Details
            </button>
        </div>
    `;
    
    // This is the important part - make sure the click handler is properly set up
    document.getElementById('addConcretePermitBtn').addEventListener('click', (e) => {
        e.preventDefault();
        openConcretePermitModal();
    });
    
    detailsDisplay.style.display = 'flex';
}


// Event listener for Report on Concreting Works menu item
 // Event listener for Report on Concreting Works menu item
 document.querySelector('.qa-menu-link[data-content="reportOnConcretingWorks"]').addEventListener('click', (e) => {
    e.preventDefault();
    // Only load data, the modal will open from the "Add Details" button if no data exists
    loadConcretingReportData();
});

        function openConcretingReportModal() {
            // Close any other open modals first
            document.querySelectorAll('.modal').forEach(modal => {
                if (modal.id !== 'concretingReportModal') {
                    modal.style.display = 'none';
                }
            });
            
            if (!currentContractId) return;
            
            // Reset the modal first
            document.getElementById('concretingReportDataDisplay').style.display = 'none';
            document.getElementById('concretingReportForm').style.display = 'none';
            
            // Load existing data if available
            contractsRef.child(currentContractId).child('concretingReport').once('value').then(snapshot => {
                const data = snapshot.val();
                
                if (data) {
                    // Show the data display and hide the form
                    document.getElementById('concretingReportDataDisplay').style.display = 'block';
                    populateConcretingReportDisplay(data);
                } else {
                    // No data exists, show the form for new entry
                    document.getElementById('concretingReportForm').style.display = 'block';
                    document.getElementById('concretingReportForm').reset();
                }
                
                // Show the modal
                concretingReportModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            });
        }

        function showConcretingReportModalWithData(data) {
    // Hide display and show form
    document.getElementById('concretingReportDataDisplay').style.display = 'none';
    document.getElementById('concretingReportForm').style.display = 'block';
    
    // Reset form first
    document.getElementById('concretingReportForm').reset();
    
    if (data) {
        // Populate form with existing data
        document.getElementById('concretingReportStatus').value = data.status || '';
        document.getElementById('concretingReportStation').value = data.station || '';
        document.getElementById('concretingReportVolume').value = data.volume || '';
        
        // Split date and time if available
        if (data.date) {
            document.getElementById('concretingReportDate').value = data.date;
        }
        if (data.time) {
            document.getElementById('concretingReportTime').value = data.time;
        }
    }
    
    // Show the modal
    concretingReportModal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

// Show/hide reason field based on approval status
document.querySelectorAll('input[name="concretingReportApproval"]').forEach(radio => {
    radio.addEventListener('change', () => {
        document.getElementById('concretingReportReasonGroup').style.display = radio.value === 'disapproved' ? 'block' : 'none';
        if (radio.value !== 'disapproved') {
            document.getElementById('concretingReportReason').value = '';
        }
    });
});

// Make sure you have this at the top of your script to get the form element
const concretingReportForm = document.getElementById('concretingReportForm');

concretingReportForm.addEventListener('submit', (e) => {
    e.preventDefault();
    
    if (!currentContractId) {
        alert('No contract selected. Please open a folder first.');
        return;
    }
    
    // Get form values
    const status = document.getElementById('concretingReportStatus').value;
    const station = document.getElementById('concretingReportStation').value;
    const volume = document.getElementById('concretingReportVolume').value;
    const date = document.getElementById('concretingReportDate').value;
    const time = document.getElementById('concretingReportTime').value;
    
    // Validate required fields
    if (!status || !station || !volume || !date || !time) {
        alert('Please fill in all required fields');
        return;
    }
    
    const concretingReportData = {
        status: status,
        station: station,
        volume: parseFloat(volume),
        date: date,
        time: time,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    // Save to Firebase
    contractsRef.child(currentContractId).child('concretingReport').set(concretingReportData)
        .then(() => {
            // Close the modal
            concretingReportModal.style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // Update the display in the main content area
            updateConcretingReportDetailsDisplay(concretingReportData);
            
            // Only try to update modal display if it's open
            if (document.getElementById('concretingReportDataDisplay')) {
                populateConcretingReportDisplay(concretingReportData);
            }
        })
        .catch(error => {
            console.error('Error saving concreting report data:', error);
            alert('Error saving data: ' + error.message);
        });
});


function populateConcretingReportDisplay(data) {
    // Format dates for display
    const formatDate = (dateStr) => {
        if (!dateStr) return 'N/A';
        const date = new Date(dateStr);
        return date.toLocaleDateString();
    };
    
    // Safely update display fields if they exist
    const displayStatus = document.getElementById('displayConcretingReportStatus');
    const displayStation = document.getElementById('displayConcretingReportStation');
    const displayVolume = document.getElementById('displayConcretingReportVolume');
    const displayDate = document.getElementById('displayConcretingReportDateTime');
    const displayApproval = document.getElementById('displayConcretingReportApproval');
    const displayReason = document.getElementById('displayConcretingReportReason');
    const displayReasonRow = document.getElementById('displayConcretingReportReasonRow');
    
    if (displayStatus) displayStatus.textContent = formatDate(data.status) || 'N/A';
    if (displayStation) displayStation.textContent = data.station || 'N/A';
    if (displayVolume) displayVolume.textContent = data.volume ? `${data.volume} cu.m` : 'N/A';
    if (displayDate) displayDate.textContent = formatDate(data.date) || 'N/A';
    
    if (displayApproval) {
        displayApproval.textContent = data.approval === 'approved' ? 'Approved' : 'Disapproved';
    }
    
    if (displayReason && displayReasonRow) {
        if (data.approval === 'disapproved' && data.reason) {
            displayReasonRow.style.display = 'flex';
            displayReason.textContent = data.reason;
        } else {
            displayReasonRow.style.display = 'none';
        }
    }
    
    // Set up edit button if it exists
    const editBtn = document.getElementById('editConcretingReportBtn');
    if (editBtn) {
        editBtn.onclick = () => {
            showConcretingReportModalWithData(data);
        };
    }
}

function loadConcretingReportData() {
    if (!currentContractId) return;
    
    contractsRef.child(currentContractId).child('concretingReport').once('value').then(snapshot => {
        const data = snapshot.val();
        if (data) {
            // Only update the display, don't open modal
            updateConcretingReportDetailsDisplay(data);
        } else {
            // Show "no data" message but don't automatically open modal
            showNoConcretingReportData();
        }
    });
}


function updateConcretingReportDetailsDisplay(data) {
    let detailsDisplay = document.getElementById('concretingReportDetailsDisplay');
    
    if (!detailsDisplay) {
        detailsDisplay = document.createElement('div');
        detailsDisplay.id = 'concretingReportDetailsDisplay';
        detailsDisplay.className = 'acp-details-container';
        document.querySelector('.qa-content').insertBefore(detailsDisplay, document.querySelector('.file-upload-area'));
    }
    
    // Format dates for display
    const formatDate = (dateStr) => {
        if (!dateStr) return 'N/A';
        const date = new Date(dateStr);
        return date.toLocaleDateString();
    };
    
    detailsDisplay.innerHTML = `
        <div class="acp-details">
           
            <div class="detail-row">
                <span class="detail-label">Status Date:</span>
                <span>${formatDate(data.status) || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Part of Structure/Station:</span>
                <span>${data.station || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Volume (cu.m):</span>
                <span>${data.volume ? `${data.volume} cu.m` : 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Date and Time of Concreting:</span>
                <span>${formatDate(data.date) || 'N/A'} ${data.time || ''}</span>
            </div>
            <div class="acp-actions">
                <button class="edit-btn" id="editConcretingReportDetailsBtn">
                    <i class="fas fa-edit"></i> Edit Details
                </button>
                <button class="delete-btn" id="deleteConcretingReportDetailsBtn">
                    <i class="fas fa-trash"></i> Delete Details
                </button>
            </div>
        </div>
    `;
    
    // Set up edit button - use event delegation
    detailsDisplay.addEventListener('click', (e) => {
        if (e.target.closest('#editConcretingReportDetailsBtn')) {
            showConcretingReportModalWithData(data);
        }
    });
    
    // Set up delete button
    document.getElementById('deleteConcretingReportDetailsBtn').addEventListener('click', () => {
        if (confirm('Are you sure you want to delete these concreting report details?')) {
            contractsRef.child(currentContractId).child('concretingReport').remove()
                .then(() => {
                    showNoConcretingReportData();
                })
                .catch(error => {
                    console.error('Error deleting concreting report data:', error);
                    alert('Error deleting data. Please try again.');
                });
        }
    });
    
    detailsDisplay.style.display = 'flex';
}

function showNoConcretingReportData() {
    let detailsDisplay = document.getElementById('concretingReportDetailsDisplay');
    
    if (!detailsDisplay) {
        detailsDisplay = document.createElement('div');
        detailsDisplay.id = 'concretingReportDetailsDisplay';
        detailsDisplay.className = 'acp-details-container';
        document.querySelector('.qa-content').insertBefore(detailsDisplay, document.querySelector('.file-upload-area'));
    }
    
    detailsDisplay.innerHTML = `
        <div class="acp-no-data">
            <p>No data available for Report on Concreting Works</p>
            <button class="acp-add-btn" id="addConcretingReportBtn">
                <i class="fas fa-plus"></i> Add Details
            </button>
        </div>
    `;
    
    document.getElementById('addConcretingReportBtn').addEventListener('click', (e) => {
        e.preventDefault();
        openConcretingReportModal();
    });
    
    detailsDisplay.style.display = 'flex';
}

document.querySelector('#concretingReportModal .close').addEventListener('click', () => {
    concretingReportModal.style.display = 'none';
    document.body.style.overflow = 'auto';
});

// Close modal when clicking outside
window.addEventListener('click', (e) => {
    if (e.target === concretingReportModal) {
        concretingReportModal.style.display = 'none';
    }
});




function initializeMaterialsTestingReport() {
    const container = document.getElementById('materialsTestingContainer');
    
    if (!currentContractId) return;
    
    container.style.display = 'block';
    
    // First get the contractId (like "24IK0100") from contracts node
    contractsRef.child(currentContractId).once('value').then(contractSnapshot => {
        const contractData = contractSnapshot.val();
        if (!contractData) return;
        
        const contractId = contractData.contractId;
        
        // Clear any previous data
        allMaterialsTestingData = null;
        
        // Load data from FDT/{currentContractId} node
        database.ref(`FDT/${contractId}`).once('value').then(snapshot => {
            const data = snapshot.val();
            if (data) {
                allMaterialsTestingData = data;
                renderMaterialsTestingTable(contractId);
            } else {
                // Create empty table if no data exists
                renderMaterialsTestingTable(contractId);
            }
        });
    });
    
    document.getElementById('addMaterialsTestingRowBtn').addEventListener('click', addNewMaterialsTestingRow);
}

function renderMaterialsTestingTable(contractId) {
    const container = document.getElementById('materialsTestingContainer');
    
    // Create or update the table
    let table = document.getElementById('materialsTestingTable');
    if (!table) {
        table = document.createElement('table');
        table.id = 'materialsTestingTable';
        table.className = 'materials-testing-table';
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Item No.</th>
                    <th>Description</th>
                    <th>Unit</th>
                    <th>Quantity</th>
                    <th>Test Type</th>
                    <th>Test Count</th>
                    <th>Status</th>
                    <th>Date of Test</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="materialsTestingTableBody"></tbody>
        `;
        container.appendChild(table);
    }
    
    const tableBody = document.getElementById('materialsTestingTableBody');
    tableBody.innerHTML = '';
    
    // Create a row for each material test record
    if (allMaterialsTestingData) {
        Object.keys(allMaterialsTestingData).forEach(rowId => {
            const rowData = allMaterialsTestingData[rowId];
            renderMaterialsTestingRow(rowId, rowData, contractId);
        });
    }
}

// Update the renderMaterialsTestingRow function
function renderMaterialsTestingRow(rowId, rowData, contractId) {
    const tableBody = document.getElementById('materialsTestingTableBody');
    if (!tableBody) return;
    
    const row = document.createElement('tr');
    row.dataset.rowId = rowId;
    row.dataset.contractId = contractId;
    
    // Create cells with FDT structure
    row.innerHTML = `
        <td><input type="text" class="item-no-input" value="${rowData.item || ''}"></td>
        <td><input type="text" class="description-input" value="${rowData.description || ''}"></td>
        <td><input type="text" class="unit-input" value="${rowData.unit || ''}"></td>
        <td><input type="number" class="quantity-input" value="${rowData.quantity || ''}" step="0.01"></td>
        <td><input type="text" class="test-type-input" value="${rowData.testType || ''}"></td>
        <td>
            <input type="number" class="test-count-input" value="${rowData.testCount || 0}" min="0">
            <button class="update-test-count-btn">Update</button>
        </td>
        <td class="status-cell"></td>
        <td class="date-cell"></td>
        <td>
            <button class="save-btn"><i class="fas fa-save"></i> Save</button>
            <button class="delete-btn"><i class="fas fa-trash"></i> Delete</button>
        </td>
    `;
    
    tableBody.appendChild(row);
    
    updateStatusAndDateCells(rowId, rowData);
    
    // Set up event listeners for inputs
    row.querySelector('.item-no-input').addEventListener('change', function() {
        const itemNo = this.value;
        if (itemNo && materialDescriptions[itemNo]) {
            row.querySelector('.description-input').value = materialDescriptions[itemNo];
        }
    });
    
    row.querySelector('.update-test-count-btn').addEventListener('click', () => {
        const newCount = parseInt(row.querySelector('.test-count-input').value) || 0;
        updateTestCount(contractId, rowId, newCount);
    });
    
    row.querySelector('.save-btn').addEventListener('click', () => {
        saveMaterialsTestingData(contractId, rowId);
    });
    
    row.querySelector('.delete-btn').addEventListener('click', () => {
        if (confirm('Are you sure you want to delete this materials testing record?')) {
            deleteMaterialsTestingData(contractId, rowId);
        }
    });
}


function addNewMaterialsTestingRow() {
    if (!currentContractId) return;
    
    // Get the contractId (like "23IK0100")
    contractsRef.child(currentContractId).once('value').then(contractSnapshot => {
        const contractData = contractSnapshot.val();
        if (!contractData) return;
        
        const contractId = contractData.contractId;
        const newRowId = database.ref().child(`FDT/${contractId}`).push().key;
        
        // Initialize default data structure
        const defaultData = {
            item: '',
            description: '',
            unit: '',
            quantity: 0,
            testType: '',
            testCount: 0,
            dateOfTest: [],
            dateOfWork: '',
            createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        // Save new row to FDT/{contractId}/{rowId} node
        database.ref(`FDT/${contractId}/${newRowId}`).set(defaultData)
            .then(() => {
                // Initialize allMaterialsTestingData if it doesn't exist
                if (!allMaterialsTestingData) {
                    allMaterialsTestingData = {};
                }
                // Add to our local data
                allMaterialsTestingData[newRowId] = defaultData;
                // Render the new row
                renderMaterialsTestingRow(newRowId, defaultData, contractId);
            })
            .catch(error => {
                console.error('Error adding new row:', error);
                alert('Error adding new row: ' + error.message);
            });
    });
}

function saveMaterialsTestingData(contractId, rowId) {
    const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
    if (!row) return;
    
    const updatedData = {
        item: row.querySelector('.item-no-input').value,
        description: row.querySelector('.description-input').value,
        unit: row.querySelector('.unit-input').value,
        quantity: parseFloat(row.querySelector('.quantity-input').value) || 0,
        testType: row.querySelector('.test-type-input').value,
        testCount: parseInt(row.querySelector('.test-count-input').value) || 0,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    // Update description mapping
    if (updatedData.item && updatedData.description) {
        materialDescriptions[updatedData.item] = updatedData.description;
    }
    
    // Merge with existing data to preserve dateOfTest and dateOfWork
    const fullUpdate = {
        ...(allMaterialsTestingData[rowId] || {}),
        ...updatedData
    };
    
    // Ensure dateOfTest array matches testCount
    if (fullUpdate.testCount > 0) {
        if (!fullUpdate.dateOfTest || fullUpdate.dateOfTest.length < fullUpdate.testCount) {
            fullUpdate.dateOfTest = Array(fullUpdate.testCount).fill('');
        }
    } else {
        fullUpdate.dateOfTest = [];
    }
    
    // Save to Firebase
    database.ref(`FDT/${contractId}/${rowId}`).update(fullUpdate)
        .then(() => {
            if (!allMaterialsTestingData) {
                allMaterialsTestingData = {};
            }
            allMaterialsTestingData[rowId] = fullUpdate;
            alert('Data saved successfully!');
            // Instead of re-rendering the row, just update the status and date cells
            updateStatusAndDateCells(rowId, fullUpdate);
        })
        .catch(error => {
            console.error('Error saving data:', error);
            alert('Error saving data: ' + error.message);
        });
}

function updateStatusAndDateCells(rowId, rowData) {
    const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
    if (!row) return;
    
    const testCount = parseInt(rowData.testCount) || 0;
    const statusCell = row.querySelector('.status-cell');
    const dateCell = row.querySelector('.date-cell');
    const contractId = row.dataset.contractId;
    
    // Clear existing content
    statusCell.innerHTML = '';
    dateCell.innerHTML = '';
    
    if (testCount === 0) {
        statusCell.textContent = 'No testing needed';
        dateCell.textContent = 'N/A';
        return;
    }
    
    // Initialize dateOfTest array if it doesn't exist
    if (!rowData.dateOfTest || !Array.isArray(rowData.dateOfTest)) {
        rowData.dateOfTest = Array(testCount).fill('');
    }
    
    // Create containers for checkboxes and date inputs
    const checkboxContainer = document.createElement('div');
    checkboxContainer.className = 'test-checkbox-container';
    
    const dateContainer = document.createElement('div');
    dateContainer.className = 'test-date-container';
    
    // Add CSS to align items properly
    checkboxContainer.style.display = 'flex';
    checkboxContainer.style.flexDirection = 'column';
    checkboxContainer.style.gap = '8px';
    
    dateContainer.style.display = 'flex';
    dateContainer.style.flexDirection = 'column';
    dateContainer.style.gap = '8px';
    dateContainer.style.alignItems = 'flex-start';
    
    // Create checkboxes and date inputs
    for (let i = 0; i < testCount; i++) {
        const testDate = rowData.dateOfTest[i] || '';
        const isCompleted = testDate !== '';
        
        // Create checkbox wrapper
        const checkboxWrapper = document.createElement('div');
        checkboxWrapper.className = 'checkbox-wrapper';
        checkboxWrapper.style.display = 'flex';
        checkboxWrapper.style.alignItems = 'center';
        checkboxWrapper.style.gap = '8px';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'test-checkbox';
        checkbox.checked = isCompleted;
        checkbox.dataset.index = i;
        
        const label = document.createElement('span');
        label.textContent = `Test ${i+1}`;
        
        checkboxWrapper.appendChild(checkbox);
        checkboxWrapper.appendChild(label);
        checkboxContainer.appendChild(checkboxWrapper);
        
        // Create date wrapper
        const dateWrapper = document.createElement('div');
        dateWrapper.className = 'date-wrapper';
        dateWrapper.style.display = 'flex';
        dateWrapper.style.alignItems = 'center';
        dateWrapper.style.gap = '8px';
        dateWrapper.style.height = '24px'; // Match checkbox height
        
        const dateInput = document.createElement('input');
        dateInput.type = 'date';
        dateInput.className = 'date-input';
        dateInput.value = testDate;
        dateInput.dataset.index = i;
        dateInput.style.display = isCompleted ? 'inline-block' : 'none';
        dateInput.style.width = '150px';
        
        const saveBtn = document.createElement('button');
        saveBtn.className = 'save-date-btn';
        saveBtn.innerHTML = '<i class="fas fa-save"></i>';
        saveBtn.dataset.index = i;
        saveBtn.style.display = 'none'; // Hidden by default
        saveBtn.style.padding = '2px 5px';
        saveBtn.style.opacity = '0';
        saveBtn.style.transition = 'opacity 0.2s';
        
        dateWrapper.appendChild(dateInput);
        dateWrapper.appendChild(saveBtn);
        dateContainer.appendChild(dateWrapper);
        
        // Show save button on date input hover
        dateWrapper.addEventListener('mouseenter', () => {
            if (dateInput.style.display !== 'none' && dateInput.value) {
                saveBtn.style.display = 'inline-block';
                saveBtn.style.opacity = '1';
            }
        });
        
        dateWrapper.addEventListener('mouseleave', () => {
            saveBtn.style.opacity = '0';
            setTimeout(() => {
                if (saveBtn.style.opacity === '0') {
                    saveBtn.style.display = 'none';
                }
            }, 200); // Match transition duration
        });
        
        // Keep save button visible when hovering over it
        saveBtn.addEventListener('mouseenter', () => {
            saveBtn.style.opacity = '1';
            saveBtn.style.display = 'inline-block';
        });
        
        // Add event listeners
        checkbox.addEventListener('change', function() {
            const index = parseInt(this.dataset.index);
            const dateInput = dateWrapper.querySelector('.date-input');
            const saveBtn = dateWrapper.querySelector('.save-date-btn');
            
            if (this.checked) {
                dateInput.style.display = 'inline-block';
                // Don't show save button yet - only on hover
            } else {
                // Ask for confirmation before removing date
                if (dateInput.value) {
                    if (confirm('Do you want to remove this test date?')) {
                        dateInput.value = '';
                        saveTestStatus(contractId, rowId, index, false, '');
                    } else {
                        // If user cancels, keep the checkbox checked
                        this.checked = true;
                        return;
                    }
                }
                dateInput.style.display = 'none';
                saveBtn.style.display = 'none';
                saveBtn.style.opacity = '0';
            }
        });
        
        saveBtn.addEventListener('click', function() {
            const index = parseInt(this.dataset.index);
            const dateInput = dateWrapper.querySelector('.date-input');
            const checkbox = checkboxWrapper.querySelector('.test-checkbox');
            
            if (!dateInput.value) {
                alert('Please select a date before saving');
                return;
            }
            
            saveTestStatus(contractId, rowId, index, true, dateInput.value);
            checkbox.checked = true;
        });
        
        // Show save button when date changes (but still only visible on hover)
        dateInput.addEventListener('change', function() {
            const saveBtn = dateWrapper.querySelector('.save-date-btn');
            saveBtn.style.display = 'inline-block';
            saveBtn.style.opacity = '0'; // Still hidden until hover
        });
    }
    
    // Rest of the function remains the same...
    // Add containers to cells
    statusCell.appendChild(checkboxContainer);
    dateCell.appendChild(dateContainer);
    
    // Add "Show X tests" button if more than 3 tests
    if (testCount > 3) {
        const showMoreBtn = document.createElement('button');
        showMoreBtn.className = 'show-more-btn';
        showMoreBtn.style.marginBottom = '8px';
        
        let isExpanded = rowData.isExpanded || false;
        
        showMoreBtn.innerHTML = isExpanded 
            ? `Hide tests <i class="fas fa-chevron-up"></i>`
            : `Show all ${testCount} tests <i class="fas fa-chevron-down"></i>`;
        
        if (!isExpanded) {
            checkboxContainer.style.maxHeight = '120px';
            checkboxContainer.style.overflowY = 'hidden';
            dateContainer.style.maxHeight = '120px';
            dateContainer.style.overflowY = 'hidden';
        } else {
            checkboxContainer.style.maxHeight = 'none';
            checkboxContainer.style.overflowY = 'visible';
            dateContainer.style.maxHeight = 'none';
            dateContainer.style.overflowY = 'visible';
        }
        
        statusCell.insertBefore(showMoreBtn, checkboxContainer);
        
        showMoreBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            isExpanded = !isExpanded;
            
            if (isExpanded) {
                checkboxContainer.style.maxHeight = 'none';
                checkboxContainer.style.overflowY = 'visible';
                dateContainer.style.maxHeight = 'none';
                dateContainer.style.overflowY = 'visible';
                this.innerHTML = `Hide tests <i class="fas fa-chevron-up"></i>`;
            } else {
                checkboxContainer.style.maxHeight = '120px';
                checkboxContainer.style.overflowY = 'hidden';
                dateContainer.style.maxHeight = '120px';
                dateContainer.style.overflowY = 'hidden';
                this.innerHTML = `Show all ${testCount} tests <i class="fas fa-chevron-down"></i>`;
            }
            
            database.ref(`FDT/${contractId}/${rowId}`).update({
                isExpanded: isExpanded,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            }).catch(error => {
                console.error('Error saving expanded state:', error);
            });
        });
    }
}

function saveTestStatus(contractId, rowId, index, isCompleted, date) {
    // Get current row data
    const rowData = allMaterialsTestingData[rowId] || {};
    
    // Initialize dateOfTest array if needed
    if (!rowData.dateOfTest || !Array.isArray(rowData.dateOfTest)) {
        rowData.dateOfTest = Array(rowData.testCount || 0).fill('');
    }
    
    // Ensure array is large enough
    while (rowData.dateOfTest.length <= index) {
        rowData.dateOfTest.push('');
    }
    
    // Update the specific date
    rowData.dateOfTest[index] = isCompleted ? date : '';
    
    // Prepare update (preserve isExpanded state)
    const updateData = {
        dateOfTest: rowData.dateOfTest,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    // Only update isExpanded if it exists (don't overwrite with undefined)
    if (rowData.isExpanded !== undefined) {
        updateData.isExpanded = rowData.isExpanded;
    }
    
    // Save to Firebase
    return database.ref(`FDT/${contractId}/${rowId}`).update(updateData)
        .then(() => {
            // Update local data
            allMaterialsTestingData[rowId] = rowData;
            // Show success message
            alert('Test status saved successfully!');
        })
        .catch(error => {
            console.error('Error saving test status:', error);
            alert('Error saving test status: ' + error.message);
            throw error; // Re-throw the error for further handling if needed
        });
}

function updateTestCount(contractId, rowId, newCount) {
    // Get current row data
    const rowData = allMaterialsTestingData[rowId] || {};
    
    // Update test count
    rowData.testCount = newCount;
    
    if (newCount > 0) {
        // Update dateOfTest array size if it exists
        if (rowData.dateOfTest) {
            while (rowData.dateOfTest.length < newCount) {
                rowData.dateOfTest.push('');
            }
            while (rowData.dateOfTest.length > newCount) {
                rowData.dateOfTest.pop();
            }
        } else {
            rowData.dateOfTest = Array(newCount).fill('');
        }
    } else {
        rowData.dateOfTest = [];
    }
    
     database.ref(`FDT/${contractId}/${rowId}`).update({
        testCount: newCount,
        dateOfTest: rowData.dateOfTest,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
    })
    .then(() => {
        allMaterialsTestingData[rowId] = rowData;
        updateStatusAndDateCells(rowId, rowData);
        
        // After updating test count, reload the status tests
        loadStatusTests();
    })
    .catch(error => {
        console.error('Error updating test count:', error);
        alert('Error updating test count: ' + error.message);
    });
}


function deleteMaterialsTestingData(contractId, rowId) {
    if (!contractId || !rowId) return;
    
    database.ref(`FDT/${contractId}/${rowId}`).remove()
        .then(() => {
            // Remove from local data
            if (allMaterialsTestingData && allMaterialsTestingData[rowId]) {
                delete allMaterialsTestingData[rowId];
            }
            // Remove from DOM
            document.querySelector(`tr[data-row-id="${rowId}"]`)?.remove();
            alert('Materials testing record deleted successfully');
        })
        .catch(error => {
            console.error('Error deleting materials testing data:', error);
            alert('Error deleting materials testing data: ' + error.message);
        });
}

document.querySelector('#concretePermitModal .close').addEventListener('click', function() {
    concretePermitModal.style.display = 'none';
    
    // If we're not on the concrete pouring permits tab, switch back
    if (currentDocumentCategory !== 'concretePouringPermits') {
        // Find the active QA menu item and click it to refresh
        const activeItem = document.querySelector('.qa-menu-link.active');
        if (activeItem) {
            activeItem.click();
        }
    }
});
// Close button
document.querySelector('#acpntlModal .close').addEventListener('click', function() {
    // Just hide the modal, don't change the display state
    document.getElementById('acpntlModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // Reload the ACP data to ensure the display is correct
    loadACPData();
});

window.addEventListener('click', function(e) {
    if (e.target === document.getElementById('acpntlModal')) {
        document.getElementById('acpntlModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }
});

function initializeMaterialsLogbook() {
    const container = document.getElementById('materialsLogbookContainer');
    
    if (!currentContractId) {
        console.error("No current contract ID");
        return;
    }
    
    container.style.display = 'block';
    
    // Clear previous content while loading
    const logbookContent = document.getElementById('materialsLogbookContent');
    if (logbookContent) {
        logbookContent.innerHTML = '<p>Loading materials logbook data...</p>';
    }
    
    // Load logbook data from the correct path: contracts/{contractId}/materialsLogbook
    contractsRef.child(currentContractId).child('materialsLogbook').once('value').then(snapshot => {
        const data = snapshot.val();
        
        if (data) {
            updateMaterialsLogbookDisplay(data);
        } else {
            // No data exists - show "Add Status" button
            showNoMaterialsLogbookData();
        }
    }).catch(error => {
        console.error("Error loading materials logbook:", error);
        showNoMaterialsLogbookData();
    });
}


function showNoMaterialsLogbookData() {
    const logbookContent = document.getElementById('materialsLogbookContent');
    if (!logbookContent) return;
    
    logbookContent.innerHTML = `
        <div class="logbook-no-data">
            <p>No materials logbook data available</p>
            <button class="add-status-btn" id="addLogbookStatusBtn">
                <i class="fas fa-plus"></i> Add Status
            </button>
        </div>
    `;
    
    document.getElementById('addLogbookStatusBtn').addEventListener('click', openStatusEditModal);
}


function updateMaterialsLogbookDisplay(data) {
    const logbookContent = document.getElementById('materialsLogbookContent');
    if (!logbookContent) return;
    
    // Format the date for display
    const formatDate = (dateString) => {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString();
        } catch (e) {
            return dateString; // Return as-is if it's already formatted
        }
    };
    
    logbookContent.innerHTML = `
        <div class="logbook-status-display">
            <div class="status-badge ${data.status || 'pending'}">
                ${(data.status || 'pending').charAt(0).toUpperCase() + (data.status || 'pending').slice(1)}
            </div>
            <div class="status-details">
                <div class="detail-row">
                    <span class="detail-label">Last Updated:</span>
                    <span>${formatDate(data.lastUpdated) || 'N/A'}</span>
                </div>
            </div>
            <div class="logbook-actions">
                <button class="edit-btn" id="editLogbookBtn">
                    <i class="fas fa-edit"></i> Edit Status
                </button>
            </div>
        </div>
    `;
    
    // Set up edit button
    document.getElementById('editLogbookBtn').addEventListener('click', () => {
        openStatusEditModal(data);
    });
}


function openStatusEditModal(existingData = null) {
    if (!currentContractId) {
        alert('No contract selected. Please open a folder first.');
        return;
    }
    
    // Create modal HTML
    const modalHTML = `
        <div id="statusEditModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <span class="close">&times;</span>
                <h3>${existingData ? 'Edit' : 'Add'} Materials Logbook Status</h3>
                
                <div class="form-group">
                    <label for="statusSelect">Status:</label>
                    <select id="statusSelect" class="form-control">
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="statusDate">Date:</label>
                    <input type="date" id="statusDate" class="form-control">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="cancel-btn" id="cancelStatusEdit">Cancel</button>
                    <button type="button" class="submit-btn" id="saveStatusEdit">Save</button>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    const modal = document.getElementById('statusEditModal');
    
    // Set current values if editing
    if (existingData) {
        document.getElementById('statusSelect').value = existingData.status || 'pending';
        
        // Set the date - use existing date or today
        const dateInput = document.getElementById('statusDate');
        if (existingData.lastUpdated) {
            // Handle both timestamp and date string
            const date = existingData.lastUpdated instanceof Date ? 
                existingData.lastUpdated : 
                new Date(existingData.lastUpdated);
            dateInput.value = date.toISOString().split('T')[0];
        } else {
            dateInput.value = new Date().toISOString().split('T')[0];
        }
    } else {
        // Set default date to today
        document.getElementById('statusDate').value = new Date().toISOString().split('T')[0];
    }
    
    // Show modal
    modal.style.display = 'block';
    
    // Close button
    modal.querySelector('.close').addEventListener('click', () => {
        modal.remove();
    });
    
    // Cancel button
    document.getElementById('cancelStatusEdit').addEventListener('click', () => {
        modal.remove();
    });
    
    // Save button
    document.getElementById('saveStatusEdit').addEventListener('click', () => {
        const status = document.getElementById('statusSelect').value;
        const date = document.getElementById('statusDate').value;
        
        if (!date) {
            alert('Please select a date');
            return;
        }
        
        const updateData = {
            status: status,
            lastUpdated: date,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        // Save to Firebase
        contractsRef.child(currentContractId).child('materialsLogbook').set(updateData)
            .then(() => {
                // Update the display
                updateMaterialsLogbookDisplay(updateData);
                modal.remove();
            })
            .catch(error => {
                console.error('Error saving materials logbook status:', error);
                alert('Error saving status: ' + error.message);
            });
    });
    
    // Close when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function openStatusEditModal() {
    if (!currentContractId) {
        alert('No contract selected. Please open a folder first.');
        return;
    }
    
    // Get current status or initialize with defaults
    contractsRef.child(currentContractId).child('materialsLogbook').once('value').then(snapshot => {
        const data = snapshot.val() || { status: 'pending', lastUpdated: null };
        
        // Populate modal with current data
        document.getElementById('statusSelect').value = data.status || 'pending';
        
        // Set date - use today if no date exists
        const dateInput = document.getElementById('statusDate');
        if (data.lastUpdated) {
            // If it's a timestamp, convert to date string
            if (typeof data.lastUpdated === 'number') {
                const date = new Date(data.lastUpdated);
                dateInput.value = date.toISOString().split('T')[0];
            } else {
                // If it's already a date string, use as-is
                dateInput.value = data.lastUpdated;
            }
        } else {
            // Default to today
            dateInput.value = new Date().toISOString().split('T')[0];
        }
        
        // Show modal
        document.getElementById('statusEditModal').style.display = 'block';
    }).catch(error => {
        console.error("Error loading current status:", error);
        alert('Error loading current status. Please try again.');
    });
}

// Handle status edit form submission
document.getElementById('statusEditForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!currentContractId) {
        alert('No contract selected. Please open a folder first.');
        return;
    }
    
    const newStatus = document.getElementById('statusSelect').value;
    const statusDate = document.getElementById('statusDate').value;
    
    if (!statusDate) {
        alert('Please select a date');
        return;
    }
    
    // Data to be saved
    const updateData = {
        status: newStatus,
        lastUpdated: statusDate, // Store as date string
        updatedAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    // Save under contracts/{currentContractId}/materialsLogbook
    contractsRef.child(currentContractId).child('materialsLogbook').update(updateData)
        .then(() => {
            updateMaterialsLogbookDisplay(updateData);
            document.getElementById('statusEditModal').style.display = 'none';
        })
        .catch(error => {
            console.error("Error saving status:", error);
            alert('Error saving status: ' + error.message);
        });
});


function showStatusEditModal(rowId, rowData, contractId) {
    // Create modal HTML
    const modalHTML = `
        <div id="statusEditModal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <span class="close">&times;</span>
                <h3>Update Status</h3>
                <div class="form-group">
                    <label for="statusSelect">Status:</label>
                    <select id="statusSelect" class="form-control">
                        <option value="pending" ${rowData.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="in-progress" ${rowData.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                        <option value="completed" ${rowData.status === 'completed' ? 'selected' : ''}>Completed</option>
                        <option value="rejected" ${rowData.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="cancel-btn" id="cancelStatusEdit">Cancel</button>
                    <button type="button" class="submit-btn" id="saveStatusEdit">Save</button>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Show modal
    const modal = document.getElementById('statusEditModal');
    modal.style.display = 'block';
    
    // Close button
    modal.querySelector('.close').addEventListener('click', () => {
        modal.remove();
    });
    
    // Cancel button
    modal.querySelector('#cancelStatusEdit').addEventListener('click', () => {
        modal.remove();
    });
    
    // Save button
    modal.querySelector('#saveStatusEdit').addEventListener('click', () => {
        const newStatus = document.getElementById('statusSelect').value;
        updateMaterialsLogbookStatus(contractId, rowId, newStatus);
        modal.remove();
    });
    
    // Close when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function updateMaterialsLogbookStatus(contractId, rowId, newStatus) {
    // Update the status and set lastUpdated to current date
    const updateData = {
        status: newStatus,
        lastUpdated: firebase.database.ServerValue.TIMESTAMP
    };
    
    // Save to Firebase
    contractsRef.child(currentContractId).child('materialsLogbook').update(updateData)
        .then(() => {
            // Update local data
            if (!allMaterialsLogbookData) {
                allMaterialsLogbookData = {};
            }
            if (!allMaterialsLogbookData[rowId]) {
                allMaterialsLogbookData[rowId] = {};
            }
            allMaterialsLogbookData[rowId].status = newStatus;
            allMaterialsLogbookData[rowId].lastUpdated = Date.now();
            
            // Update the row in the table
            const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
            if (row) {
                const statusCell = row.querySelector('.status-cell');
                const dateCell = row.querySelector('.date-cell');
                
                // Update status badge
                statusCell.innerHTML = `
                    <span class="status-badge ${newStatus}">
                        ${newStatus.charAt(0).toUpperCase() + newStatus.slice(1)}
                    </span>
                    <button class="edit-status-btn">Edit</button>
                `;
                
                // Update last updated date
                dateCell.textContent = new Date().toLocaleDateString();
                
                // Reattach event listener to the new edit button
                statusCell.querySelector('.edit-status-btn').addEventListener('click', () => {
                    showStatusEditModal(rowId, allMaterialsLogbookData[rowId], contractId);
                });
            }
        })
        .catch(error => {
            console.error('Error updating status:', error);
            alert('Error updating status: ' + error.message);
        });
}

function addNewMaterialsLogbookRow() {
    if (!currentContractId) return;
    
    // Get the contractId (like "23IK0100")
    contractsRef.child(currentContractId).once('value').then(contractSnapshot => {
        const contractData = contractSnapshot.val();
        if (!contractData) return;
        
        const contractId = contractData.contractId;
        const newRowId = database.ref().child(`MaterialsLogbook/${contractId}`).push().key;
        
        // Initialize default data structure
        const defaultData = {
            item: '',
            description: '',
            unit: '',
            quantity: 0,
            status: 'pending',
            lastUpdated: firebase.database.ServerValue.TIMESTAMP,
            createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        // Save new row to MaterialsLogbook/{contractId}/{rowId} node
        database.ref(`MaterialsLogbook/${contractId}/${rowId}`).set(defaultData)
            .then(() => {
                // Initialize allMaterialsLogbookData if it doesn't exist
                if (!allMaterialsLogbookData) {
                    allMaterialsLogbookData = {};
                }
                // Add to our local data
                allMaterialsLogbookData[newRowId] = defaultData;
                // Render the new row
                renderMaterialsLogbookRow(newRowId, defaultData, contractId);
            })
            .catch(error => {
                console.error('Error adding new row:', error);
                alert('Error adding new row: ' + error.message);
            });
    });
}

function saveMaterialsLogbookData(contractId, rowId) {
    const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
    if (!row) return;
    
    const updatedData = {
        item: row.querySelector('.item-no-input').value,
        description: row.querySelector('.description-input').value,
        unit: row.querySelector('.unit-input').value,
        quantity: parseFloat(row.querySelector('.quantity-input').value) || 0,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    // Update description mapping
    if (updatedData.item && updatedData.description) {
        materialDescriptions[updatedData.item] = updatedData.description;
    }
    
    // Merge with existing data to preserve status and dates
    const fullUpdate = {
        ...(allMaterialsLogbookData[rowId] || {}),
        ...updatedData
    };
    
    // Save to Firebase
    database.ref(`MaterialsLogbook/${contractId}/${rowId}`).update(fullUpdate)
        .then(() => {
            if (!allMaterialsLogbookData) {
                allMaterialsLogbookData = {};
            }
            allMaterialsLogbookData[rowId] = fullUpdate;
            alert('Data saved successfully!');
        })
        .catch(error => {
            console.error('Error saving data:', error);
            alert('Error saving data: ' + error.message);
        });
}

function deleteMaterialsLogbookData(contractId, rowId) {
    if (!contractId || !rowId) return;
    
    database.ref(`MaterialsLogbook/${contractId}/${rowId}`).remove()
        .then(() => {
            // Remove from local data
            if (allMaterialsLogbookData && allMaterialsLogbookData[rowId]) {
                delete allMaterialsLogbookData[rowId];
            }
            // Remove from DOM
            document.querySelector(`tr[data-row-id="${rowId}"]`)?.remove();
            alert('Materials logbook record deleted successfully');
        })
        .catch(error => {
            console.error('Error deleting materials logbook data:', error);
            alert('Error deleting materials logbook data: ' + error.message);
        });
}

// Site Instructions Functions
function loadSiteInstructions() {
    if (!currentContractId) return;
    
    const siteInstructionsRef = database.ref(`contracts/${currentContractId}/siteInstructions`);
    
    siteInstructionsRef.on('value', (snapshot) => {
        const data = snapshot.val();
        siteInstructionsData = data || {};
        renderSiteInstructions();
    });
}

function renderSiteInstructions() {
    const container = document.getElementById('siteInstructionsList');
    container.innerHTML = '';
    
    if (!siteInstructionsData || Object.keys(siteInstructionsData).length === 0) {
        container.innerHTML = '<p>No site instructions found. Add your first one!</p>';
        return;
    }
    
    Object.entries(siteInstructionsData).forEach(([id, instruction]) => {
        const instructionElement = document.createElement('div');
        instructionElement.className = 'site-instruction-item';
        instructionElement.dataset.id = id;
        
        instructionElement.innerHTML = `
            <div class="site-instruction-header">
                <div class="site-instruction-title">Site Instruction No. ${instruction.number}: ${instruction.date || 'No date'}</div>
                <div class="site-instruction-status">${instruction.status || 'Pending'}</div>
            </div>
            
         
            
            <div class="site-instruction-actions">
                <button class="edit-instruction-btn">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="delete-instruction-btn">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        `;
        
        container.appendChild(instructionElement);
        
        // Add event listeners
        instructionElement.querySelector('.download-file-btn')?.addEventListener('click', (e) => {
            window.open(e.target.closest('button').dataset.url, '_blank');
        });
        
        instructionElement.querySelector('.edit-instruction-btn').addEventListener('click', () => {
            editSiteInstruction(id, instruction);
        });
        
        instructionElement.querySelector('.delete-instruction-btn').addEventListener('click', () => {
            deleteSiteInstruction(id);
        });
    });
}

function addNewSiteInstruction() {
    if (!currentContractId) return;
    
    const newInstructionRef = database.ref(`contracts/${currentContractId}/siteInstructions`).push();
    const instructionNumber = Object.keys(siteInstructionsData).length + 1;
    const today = new Date().toISOString().split('T')[0];
    
    const newInstruction = {
        number: instructionNumber,
        date: today,
        status: 'Pending',
        createdAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    newInstructionRef.set(newInstruction)
        .then(() => {
            // The realtime listener will update the display
        })
        .catch(error => {
            console.error('Error adding site instruction:', error);
            alert('Error adding site instruction: ' + error.message);
        });
}

function editSiteInstruction(id, instruction) {
    // Create a modal for editing
    const modalHTML = `
        <div id="editSiteInstructionModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <span class="close">&times;</span>
                <h3>Edit Site Instruction No. ${instruction.number}</h3>
                
                <div class="form-group">
                    <label for="siDate">Date:</label>
                    <input type="date" id="siDate" value="${instruction.date || ''}">
                </div>
                
                <div class="form-group">
                    <label for="siStatus">Status:</label>
                    <select id="siStatus">
                        <option value="Pending" ${instruction.status === 'Pending' ? 'selected' : ''}>Pending</option>
                        <option value="In Progress" ${instruction.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                        <option value="Completed" ${instruction.status === 'Completed' ? 'selected' : ''}>Completed</option>
                    </select>
                </div>
                
                <div class="form-group">
               
                </div>
                
                <div class="form-actions">
                    <button class="cancel-btn" id="cancelEditSI">Cancel</button>
                    <button class="submit-btn" id="saveEditSI">Save</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    const modal = document.getElementById('editSiteInstructionModal');
    modal.style.display = 'block';
    
  
    
    // Close modal
    modal.querySelector('.close').addEventListener('click', () => {
        modal.remove();
    });
    
    document.getElementById('cancelEditSI').addEventListener('click', () => {
        modal.remove();
    });
    
    // Save changes
    document.getElementById('saveEditSI').addEventListener('click', async () => {
        const date = document.getElementById('siDate').value;
        const status = document.getElementById('siStatus').value;
        const fileInput = document.getElementById('siFileUpload');
        
        const updateData = {
            date: date,
            status: status,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        };
       
    });
    
    // Close when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function deleteSiteInstruction(id) {
    if (!confirm('Are you sure you want to delete this site instruction?')) return;
    
    database.ref(`contracts/${currentContractId}/siteInstructions/${id}`).remove()
        .then(() => {
            // The realtime listener will update the display
        })
        .catch(error => {
            console.error('Error deleting site instruction:', error);
            alert('Error deleting site instruction: ' + error.message);
        });
}

document.getElementById('addSiteInstructionBtn')?.addEventListener('click', addNewSiteInstruction);


function loadStatusTests() {
    if (!currentContractId) return;
    
    // First get the contractId (like "24IK0100") from contracts node
    contractsRef.child(currentContractId).once('value').then(contractSnapshot => {
        const contractData = contractSnapshot.val();
        if (!contractData) return;
        
        const contractId = contractData.contractId;
        
        // Load materials testing data to calculate percentage
        database.ref(`FDT/${contractId}`).once('value').then(snapshot => {
            const materialsData = snapshot.val();
            let totalTests = 0;
            let completedTests = 0;
            let latestDate = null;

            if (materialsData) {
                Object.values(materialsData).forEach(material => {
                    if (material.testCount && material.testCount > 0) {
                        totalTests += material.testCount;
                        
                        // Check if dateOfTest exists and is an array
                        if (material.dateOfTest && Array.isArray(material.dateOfTest)) {
                            material.dateOfTest.forEach(date => {
                                if (date && date !== '') {
                                    completedTests++;
                                    // Track the latest date
                                    const testDate = new Date(date);
                                    if (!latestDate || testDate > latestDate) {
                                        latestDate = testDate;
                                    }
                                }
                            });
                        }
                    }
                });
            }

            // Calculate percentage (avoid division by zero)
            const percentage = totalTests > 0 ? Math.round((completedTests / totalTests) * 100) : 0;
            
            // Format the latest date
            const formattedLatestDate = latestDate ? latestDate.toISOString().split('T')[0] : null;
            
            // Update the status test display
            updateStatusTestDisplay(percentage, formattedLatestDate);
            
            // Also save this data to the statusTests node
      const statusTestData = {
    percentage: percentage + '%',  // Add percent sign here
    latestDate: formattedLatestDate,
    updatedAt: firebase.database.ServerValue.TIMESTAMP
};
            
            contractsRef.child(currentContractId).child('statusTests').set(statusTestData);
        });
    });
}

function updateStatusTestDisplay(percentage, latestDate) {
    const container = document.getElementById('statusTestList');
    
    // Extract numeric value if percentage includes % sign
    const percentValue = typeof percentage === 'string' ? parseInt(percentage) : percentage;
    
    // Determine status based on percentage
    let status = 'Pending';
    let statusClass = 'pending';
    
    if (percentValue === 100) {
        status = 'Completed';
        statusClass = 'completed';
    } else if (percentValue > 0) {
        status = 'In Progress';
        statusClass = 'in-progress';
    }
    
    // Display value with % sign (use the original percentage parameter)
    const displayPercentage = typeof percentage === 'string' ? percentage : percentage + '%';
    
    container.innerHTML = `
        <div class="status-test-summary">
            <div class="progress-container">
                <div class="progress-bar" style="width: ${percentValue}%"></div>
                <span class="progress-text">${displayPercentage}</span>
            </div>
            <div class="status-details">
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="status-badge ${statusClass}">${status}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Latest Test Date:</span>
                    <span>${latestDate ? formatDate(latestDate) : 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Tests Completed:</span>
                    <span>${displayPercentage} of all required tests</span>
                </div>
            </div>
        </div>
    `;
}

function renderStatusTests(statusTests) {
    const container = document.getElementById('statusTestList');
    
    if (!statusTests || !statusTests.percentage) {
        container.innerHTML = '<p>No status test data available. Calculations will appear after materials testing data is entered.</p>';
        return;
    }
    
    const percentage = statusTests.percentage;
    const latestDate = statusTests.latestDate;
    
    // Extract numeric value if percentage includes % sign
    const percentValue = typeof percentage === 'string' ? parseInt(percentage) : percentage;
    
    // Determine status based on percentage
    let status = 'Pending';
    let statusClass = 'pending';
    
    if (percentValue === 100) {
        status = 'Completed';
        statusClass = 'completed';
    } else if (percentValue > 0) {
        status = 'In Progress';
        statusClass = 'in-progress';
    }
    
    // Display value with % sign (use the original percentage parameter)
    const displayPercentage = typeof percentage === 'string' ? percentage : percentage + '%';
    
    container.innerHTML = `
        <div class="status-test-summary">
            <div class="progress-container">
                <div class="progress-bar" style="width: ${percentValue}%"></div>
                <span class="progress-text">${displayPercentage}</span>
            </div>
            <div class="status-details">
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="status-badge ${statusClass}">${status}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Latest Test Date:</span>
                    <span>${latestDate ? formatDate(latestDate) : 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Tests Completed:</span>
                    <span>${displayPercentage} of all required tests</span>
                </div>
            </div>
        </div>
    `;
}

function addNewStatusTest() {
    if (!currentContractId) return;
    
    const newTestRef = database.ref(`contracts/${currentContractId}/statusTests`).push();
    const today = new Date().toISOString().split('T')[0];
    
    const newTest = {
        date: today,
        status: 'Pending',
        createdAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    newTestRef.set(newTest)
        .then(() => {
            // The realtime listener will update the display
        })
        .catch(error => {
            console.error('Error adding status test:', error);
            alert('Error adding status test: ' + error.message);
        });
}

function editStatusTest(id, test) {
    // Create a modal for editing
    const modalHTML = `
        <div id="editStatusTestModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <span class="close">&times;</span>
                <h3>Edit Status Test</h3>
                
                <div class="form-group">
                    <label for="stDate">Date:</label>
                    <input type="date" id="stDate" value="${test.date || ''}">
                </div>
                
                <div class="form-group">
                    <label for="stStatus">Status:</label>
                    <select id="stStatus">
                        <option value="Pending" ${test.status === 'Pending' ? 'selected' : ''}>Pending</option>
                        <option value="In Progress" ${test.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                        <option value="Completed" ${test.status === 'Completed' ? 'selected' : ''}>Completed</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button class="cancel-btn" id="cancelEditST">Cancel</button>
                    <button class="submit-btn" id="saveEditST">Save</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    const modal = document.getElementById('editStatusTestModal');
    modal.style.display = 'block';
    
    // Close modal
    modal.querySelector('.close').addEventListener('click', () => {
        modal.remove();
    });
    
    document.getElementById('cancelEditST').addEventListener('click', () => {
        modal.remove();
    });
    
    // Save changes
    document.getElementById('saveEditST').addEventListener('click', async () => {
        const date = document.getElementById('stDate').value;
        const status = document.getElementById('stStatus').value;
        
        const updateData = {
            date: date,
            status: status,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        try {
            // Update in database
            await database.ref(`contracts/${currentContractId}/statusTests/${id}`).update(updateData);
            
            modal.remove();
        } catch (error) {
            console.error('Error updating status test:', error);
            alert('Error updating status test: ' + error.message);
        }
    });
    
    // Close when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function deleteStatusTest(id) {
    if (!confirm('Are you sure you want to delete this status test?')) return;
    
    database.ref(`contracts/${currentContractId}/statusTests/${id}`).remove()
        .then(() => {
            // The realtime listener will update the display
        })
        .catch(error => {
            console.error('Error deleting status test:', error);
            alert('Error deleting status test: ' + error.message);
        });
}

// Add event listener for the add button
document.getElementById('addStatusTestBtn')?.addEventListener('click', addNewStatusTest);


// Logout button
document.getElementById('logout-btn').addEventListener('click', () => {
    firebase.auth().signOut().then(() => {
        window.location.href = 'index.html';
    }).catch((error) => {
        console.error('Logout error:', error);
    });
});

// Summary of Field Test Functions - Detailed by date
function loadSummaryFieldTestData() {
    if (!currentContractId) return;
    
    // First get the contractId (like "24IK0100") from contracts node
    contractsRef.child(currentContractId).once('value').then(contractSnapshot => {
        const contractData = contractSnapshot.val();
        if (!contractData) return;
        
        const contractId = contractData.contractId;
        
        // Load materials testing data from FDT node
        database.ref(`FDT/${contractId}`).once('value').then(snapshot => {
            const materialsData = snapshot.val();
            
            if (materialsData) {
                // Process the data to create detailed summary
                const summaryData = processMaterialsDataForSummary(materialsData);
                updateSummaryFieldTestDisplay(summaryData);
            } else {
                showNoSummaryFieldTestData();
            }
        });
    });
}

function processMaterialsDataForSummary(materialsData) {
    const monthlySummary = {};
    
    // Process each material test record
    Object.entries(materialsData).forEach(([materialId, material]) => {
        if (!material.dateOfTest || !Array.isArray(material.dateOfTest)) return;
        
        // Process each test date
        material.dateOfTest.forEach((testDate, index) => {
            if (!testDate) return; // Skip empty dates
            
            // Parse the date
            const dateObj = new Date(testDate);
            const monthYear = `${dateObj.getFullYear()}-${(dateObj.getMonth() + 1).toString().padStart(2, '0')}`;
            const monthName = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });
            const formattedDate = dateObj.toLocaleDateString();
            
            // Initialize month entry if not exists
            if (!monthlySummary[monthYear]) {
                monthlySummary[monthYear] = {
                    monthName: monthName,
                    tests: []
                };
            }
            
            // Add test details if date exists
            if (testDate) {
                monthlySummary[monthYear].tests.push({
                    date: formattedDate,
                    testType: material.testType || 'Unknown',
                    description: material.description || 'No description',
                    itemNo: material.item || 'N/A'
                });
            }
        });
    });
    
    // Convert to array sorted by date and sort tests within each month
    return Object.keys(monthlySummary)
        .sort()
        .map(monthKey => {
            // Sort tests by date within each month
            monthlySummary[monthKey].tests.sort((a, b) => {
                return new Date(a.date) - new Date(b.date);
            });
            return {
                month: monthlySummary[monthKey].monthName,
                tests: monthlySummary[monthKey].tests
            };
        });
}

function updateSummaryFieldTestDisplay(summaryData) {
    const container = document.getElementById('summaryFieldTestContent');
    
    if (summaryData.length === 0) {
        showNoSummaryFieldTestData();
        return;
    }
    
    // Create table HTML
    let tableHTML = `
        <div class="summary-table-container">
            <table class="summary-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Test Type</th>
                        <th>Item No.</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Add rows for each test
    summaryData.forEach(monthData => {
        // Add month header row
        tableHTML += `
            <tr class="month-header">
                <td colspan="4">
                    <strong>${monthData.month}</strong>
                </td>
            </tr>
        `;
        
        // Add rows for each test in this month
        monthData.tests.forEach(test => {
            tableHTML += `
                <tr>
                    <td>${test.date}</td>
                    <td>${test.testType}</td>
                    <td>${test.itemNo}</td>
                    <td>${test.description}</td>
                </tr>
            `;
        });
        
        // Add month total row
        tableHTML += `
            <tr class="month-total">
                <td colspan="3"><strong>Total for ${monthData.month}</strong></td>
                <td><strong>${monthData.tests.length} tests</strong></td>
            </tr>
        `;
    });
    
    // Add grand total
    const totalTests = summaryData.reduce((sum, month) => sum + month.tests.length, 0);
    tableHTML += `
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3"><strong>Grand Total</strong></td>
                        <td><strong>${totalTests} tests</strong></td>
                    </tr>
                </tfoot>
            </table>
            
            <div class="summary-actions">
                <button class="refresh-btn" id="refreshSummaryBtn">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
            </div>
        </div>
    `;
    
    container.innerHTML = tableHTML;
    
    // Add event listener for refresh
    document.getElementById('refreshSummaryBtn').addEventListener('click', loadSummaryFieldTestData);
}

function showNoSummaryFieldTestData() {
    const container = document.getElementById('summaryFieldTestContent');
    
    container.innerHTML = `
        <div class="no-summary-data">
            <p>No test data available for summary.</p>
            <button class="refresh-btn" id="refreshEmptySummaryBtn">
                <i class="fas fa-sync-alt"></i> Refresh Data
            </button>
        </div>
    `;
    
    document.getElementById('refreshEmptySummaryBtn').addEventListener('click', loadSummaryFieldTestData);
}



// Time Suspension Report Functions
function loadTimeSuspensionReports() {
    if (!currentContractId) return;
    
    const timeSuspensionRef = database.ref(`contracts/${currentContractId}/timeSuspensionReports`);
    
    timeSuspensionRef.on('value', (snapshot) => {
        const data = snapshot.val();
        renderTimeSuspensionReports(data || {});
    });
}

function renderTimeSuspensionReports(reports) {
    const container = document.getElementById('timeSuspensionList');
    container.innerHTML = '';
    
    if (!reports || Object.keys(reports).length === 0) {
        container.innerHTML = '<p>No time suspension reports found. Add your first one!</p>';
        return;
    }
    
    Object.entries(reports).forEach(([id, report]) => {
        const reportElement = document.createElement('div');
        reportElement.className = 'time-suspension-item';
        reportElement.dataset.id = id;
        
        reportElement.innerHTML = `
            <div class="time-suspension-details">
                <div class="detail-row">
                    <span class="detail-label">Inclusive Dates:</span>
                    <span>${report.startDate || 'N/A'} to ${report.endDate || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Remarks:</span>
                    <span>${report.remarks || 'No remarks'}</span>
                </div>
            </div>
            
            <div class="time-suspension-actions">
                <button class="edit-btn edit-time-suspension-btn">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="delete-btn delete-time-suspension-btn">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        `;
        
        container.appendChild(reportElement);
        
        // Add event listeners
        reportElement.querySelector('.edit-time-suspension-btn').addEventListener('click', () => {
            editTimeSuspensionReport(id, report);
        });
        
        reportElement.querySelector('.delete-time-suspension-btn').addEventListener('click', () => {
            deleteTimeSuspensionReport(id);
        });
    });
}

function addNewTimeSuspensionReport() {
    if (!currentContractId) return;
    
    const newReportRef = database.ref(`contracts/${currentContractId}/timeSuspensionReports`).push();
    const today = new Date().toISOString().split('T')[0];
    
    const newReport = {
        startDate: today,
        endDate: today,
        remarks: '',
        createdAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    newReportRef.set(newReport)
        .then(() => {
            // The realtime listener will update the display
        })
        .catch(error => {
            console.error('Error adding time suspension report:', error);
            alert('Error adding time suspension report: ' + error.message);
        });
}

function editTimeSuspensionReport(id, report) {
    // Create a modal for editing
    const modalHTML = `
        <div id="editTimeSuspensionModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <span class="close">&times;</span>
                <h3>Edit Time Suspension Report</h3>
                
                <div class="form-group">
                    <label for="tsStartDate">Start Date:</label>
                    <input type="date" id="tsStartDate" value="${report.startDate || ''}">
                </div>
                
                <div class="form-group">
                    <label for="tsEndDate">End Date:</label>
                    <input type="date" id="tsEndDate" value="${report.endDate || ''}">
                </div>
                
                <div class="form-group">
                    <label for="tsRemarks">Remarks:</label>
                    <textarea id="tsRemarks" rows="3">${report.remarks || ''}</textarea>
                </div>
                
                <div class="form-actions">
                    <button class="cancel-btn" id="cancelEditTS">Cancel</button>
                    <button class="submit-btn" id="saveEditTS">Save</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    const modal = document.getElementById('editTimeSuspensionModal');
    modal.style.display = 'block';
    
    // Close modal
    modal.querySelector('.close').addEventListener('click', () => {
        modal.remove();
    });
    
    document.getElementById('cancelEditTS').addEventListener('click', () => {
        modal.remove();
    });
    
    // Save changes
    document.getElementById('saveEditTS').addEventListener('click', async () => {
        const startDate = document.getElementById('tsStartDate').value;
        const endDate = document.getElementById('tsEndDate').value;
        const remarks = document.getElementById('tsRemarks').value;
        
        const updateData = {
            startDate: startDate,
            endDate: endDate,
            remarks: remarks,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        try {
            // Update in database
            await database.ref(`contracts/${currentContractId}/timeSuspensionReports/${id}`).update(updateData);
            
            modal.remove();
        } catch (error) {
            console.error('Error updating time suspension report:', error);
            alert('Error updating time suspension report: ' + error.message);
        }
    });
    
    // Close when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function deleteTimeSuspensionReport(id) {
    if (!confirm('Are you sure you want to delete this time suspension report?')) return;
    
    database.ref(`contracts/${currentContractId}/timeSuspensionReports/${id}`).remove()
        .then(() => {
            // The realtime listener will update the display
        })
        .catch(error => {
            console.error('Error deleting time suspension report:', error);
            alert('Error deleting time suspension report: ' + error.message);
        });
}

// Add event listener for the add button
document.getElementById('addTimeSuspensionBtn')?.addEventListener('click', addNewTimeSuspensionReport);

// Time Extension Report Functions
function loadTimeExtensionReports() {
    if (!currentContractId) return;
    
    const timeExtensionRef = database.ref(`contracts/${currentContractId}/timeExtensionReports`);
    
    timeExtensionRef.on('value', (snapshot) => {
        const data = snapshot.val();
        renderTimeExtensionReports(data || {});
    });
}

function renderTimeExtensionReports(reports) {
    const container = document.getElementById('timeExtensionList');
    container.innerHTML = '';
    
    if (!reports || Object.keys(reports).length === 0) {
        container.innerHTML = '<p>No time extension reports found. Add your first one!</p>';
        return;
    }
    
    Object.entries(reports).forEach(([id, report]) => {
        const reportElement = document.createElement('div');
        reportElement.className = 'time-extension-item';
        reportElement.dataset.id = id;
        
        reportElement.innerHTML = `
            <div class="time-extension-details">
                <div class="detail-row">
                    <span class="detail-label">Inclusive Dates:</span>
                    <span>${report.startDate || 'N/A'} to ${report.endDate || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Remarks:</span>
                    <span>${report.remarks || 'No remarks'}</span>
                </div>
            </div>
            
            <div class="time-extension-actions">
                <button class="edit-btn edit-time-extension-btn">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="delete-btn delete-time-extension-btn">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        `;
        
        container.appendChild(reportElement);
        
        // Add event listeners
        reportElement.querySelector('.edit-time-extension-btn').addEventListener('click', () => {
            editTimeExtensionReport(id, report);
        });
        
        reportElement.querySelector('.delete-time-extension-btn').addEventListener('click', () => {
            deleteTimeExtensionReport(id);
        });
    });
}

function addNewTimeExtensionReport() {
    if (!currentContractId) return;
    
    const newReportRef = database.ref(`contracts/${currentContractId}/timeExtensionReports`).push();
    const today = new Date().toISOString().split('T')[0];
    
    const newReport = {
        startDate: today,
        endDate: today,
        remarks: '',
        createdAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    newReportRef.set(newReport)
        .then(() => {
            // The realtime listener will update the display
        })
        .catch(error => {
            console.error('Error adding time extension report:', error);
            alert('Error adding time extension report: ' + error.message);
        });
}

function editTimeExtensionReport(id, report) {
    // Create a modal for editing
    const modalHTML = `
        <div id="editTimeExtensionModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <span class="close">&times;</span>
                <h3>Edit Time Extension Report</h3>
                
                <div class="form-group">
                    <label for="teStartDate">Start Date:</label>
                    <input type="date" id="teStartDate" value="${report.startDate || ''}">
                </div>
                
                <div class="form-group">
                    <label for="teEndDate">End Date:</label>
                    <input type="date" id="teEndDate" value="${report.endDate || ''}">
                </div>
                
                <div class="form-group">
                    <label for="teRemarks">Remarks:</label>
                    <textarea id="teRemarks" rows="3">${report.remarks || ''}</textarea>
                </div>
                
                <div class="form-actions">
                    <button class="cancel-btn" id="cancelEditTE">Cancel</button>
                    <button class="submit-btn" id="saveEditTE">Save</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    const modal = document.getElementById('editTimeExtensionModal');
    modal.style.display = 'block';
    
    // Close modal
    modal.querySelector('.close').addEventListener('click', () => {
        modal.remove();
    });
    
    document.getElementById('cancelEditTE').addEventListener('click', () => {
        modal.remove();
    });
    
    // Save changes
    document.getElementById('saveEditTE').addEventListener('click', async () => {
        const startDate = document.getElementById('teStartDate').value;
        const endDate = document.getElementById('teEndDate').value;
        const remarks = document.getElementById('teRemarks').value;
        
        const updateData = {
            startDate: startDate,
            endDate: endDate,
            remarks: remarks,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        try {
            // Update in database
            await database.ref(`contracts/${currentContractId}/timeExtensionReports/${id}`).update(updateData);
            
            modal.remove();
        } catch (error) {
            console.error('Error updating time extension report:', error);
            alert('Error updating time extension report: ' + error.message);
        }
    });
    
    // Close when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function deleteTimeExtensionReport(id) {
    if (!confirm('Are you sure you want to delete this time extension report?')) return;
    
    database.ref(`contracts/${currentContractId}/timeExtensionReports/${id}`).remove()
        .then(() => {
            // The realtime listener will update the display
        })
        .catch(error => {
            console.error('Error deleting time extension report:', error);
            alert('Error deleting time extension report: ' + error.message);
        });
}

// Resumption Order Functions
function loadResumptionOrders() {
    if (!currentContractId) return;
    
    const resumptionOrderRef = database.ref(`contracts/${currentContractId}/resumptionOrders`);
    
    resumptionOrderRef.on('value', (snapshot) => {
        const data = snapshot.val();
        renderResumptionOrders(data || {});
    });
}

function renderResumptionOrders(orders) {
    const container = document.getElementById('resumptionOrderList');
    container.innerHTML = '';
    
    if (!orders || Object.keys(orders).length === 0) {
        container.innerHTML = '<p>No resumption orders found. Add your first one!</p>';
        return;
    }
    
    Object.entries(orders).forEach(([id, order]) => {
        const orderElement = document.createElement('div');
        orderElement.className = 'resumption-order-item';
        orderElement.dataset.id = id;
        
        orderElement.innerHTML = `
            <div class="resumption-order-details">
                <div class="detail-row">
                    <span class="detail-label">Date:</span>
                    <span>${order.date || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Remarks:</span>
                    <span>${order.remarks || 'No remarks'}</span>
                </div>
            </div>
            
            <div class="resumption-order-actions">
                <button class="edit-btn edit-resumption-order-btn">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="delete-btn delete-resumption-order-btn">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        `;
        
        container.appendChild(orderElement);
        
        // Add event listeners
        orderElement.querySelector('.edit-resumption-order-btn').addEventListener('click', () => {
            editResumptionOrder(id, order);
        });
        
        orderElement.querySelector('.delete-resumption-order-btn').addEventListener('click', () => {
            deleteResumptionOrder(id);
        });
    });
}

function addNewResumptionOrder() {
    if (!currentContractId) return;
    
    const newOrderRef = database.ref(`contracts/${currentContractId}/resumptionOrders`).push();
    const today = new Date().toISOString().split('T')[0];
    
    const newOrder = {
        date: today,
        remarks: '',
        createdAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    newOrderRef.set(newOrder)
        .then(() => {
            // The realtime listener will update the display
        })
        .catch(error => {
            console.error('Error adding resumption order:', error);
            alert('Error adding resumption order: ' + error.message);
        });
}

function editResumptionOrder(id, order) {
    // Create a modal for editing
    const modalHTML = `
        <div id="editResumptionOrderModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <span class="close">&times;</span>
                <h3>Edit Resumption Order</h3>
                
                <div class="form-group">
                    <label for="roDate">Date:</label>
                    <input type="date" id="roDate" value="${order.date || ''}">
                </div>
                
                <div class="form-group">
                    <label for="roRemarks">Remarks:</label>
                    <textarea id="roRemarks" rows="3">${order.remarks || ''}</textarea>
                </div>
                
                <div class="form-actions">
                    <button class="cancel-btn" id="cancelEditRO">Cancel</button>
                    <button class="submit-btn" id="saveEditRO">Save</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    const modal = document.getElementById('editResumptionOrderModal');
    modal.style.display = 'block';
    
    // Close modal
    modal.querySelector('.close').addEventListener('click', () => {
        modal.remove();
    });
    
    document.getElementById('cancelEditRO').addEventListener('click', () => {
        modal.remove();
    });
    
    // Save changes
    document.getElementById('saveEditRO').addEventListener('click', async () => {
        const date = document.getElementById('roDate').value;
        const remarks = document.getElementById('roRemarks').value;
        
        const updateData = {
            date: date,
            remarks: remarks,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        try {
            // Update in database
            await database.ref(`contracts/${currentContractId}/resumptionOrders/${id}`).update(updateData);
            
            modal.remove();
        } catch (error) {
            console.error('Error updating resumption order:', error);
            alert('Error updating resumption order: ' + error.message);
        }
    });
    
    // Close when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function deleteResumptionOrder(id) {
    if (!confirm('Are you sure you want to delete this resumption order?')) return;
    
    database.ref(`contracts/${currentContractId}/resumptionOrders/${id}`).remove()
        .then(() => {
            // The realtime listener will update the display
        })
        .catch(error => {
            console.error('Error deleting resumption order:', error);
            alert('Error deleting resumption order: ' + error.message);
        });
}

// Add event listeners for the add buttons
document.getElementById('addTimeExtensionBtn')?.addEventListener('click', addNewTimeExtensionReport);
document.getElementById('addResumptionOrderBtn')?.addEventListener('click', addNewResumptionOrder);



// SWA Functions
function loadSWAs() {
    if (!currentContractId) return;
    
    const swaRef = database.ref(`contracts/${currentContractId}/swas`);
    
    swaRef.on('value', (snapshot) => {
        const data = snapshot.val();
        renderSWAs(data || {});
    });
}

function renderSWAs(swas) {
    const container = document.getElementById('swaList');
    container.innerHTML = '';
    
    if (!swas || Object.keys(swas).length === 0) {
        container.innerHTML = '<div class="no-swa-message">No billing statements found. Add your first billing!</div>';
        return;
    }
    
    // Convert object to array and sort by creation date (newest first)
    const swaArray = Object.entries(swas).map(([key, value]) => {
        return { ...value, id: key };
    }).sort((a, b) => {
        return (b.createdAt || 0) - (a.createdAt || 0);
    });
    
    swaArray.forEach((swa, index) => {
        const swaElement = document.createElement('div');
        swaElement.className = 'swa-item';
        swaElement.dataset.id = swa.id;
        
        const billingNumber = getBillingNumberText(index + 1);
        const billingType = swa.billingType || 'Regular';
        
        swaElement.innerHTML = `
          <div class="swa-header">
              <div class="swa-type">${billingType}</div>
          </div>
          <div class="swa-details">
              <div class="detail-row">
                  <span class="detail-label">Date:</span>
                  <span class="swa-date">${formatDate(swa.date) || formatDate(swa.createdAt) || 'N/A'}</span>
              </div>
              <div class="detail-row">
                  <span class="detail-label">Amount:</span>
                  <span class="swa-amount">${swa.amount ? '' + parseFloat(swa.amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : 'N/A'}</span>
              </div>
          </div>
          <div class="swa-actions">
              <button class="edit-btn edit-swa-btn">
                  <i class="fas fa-edit"></i> Edit
              </button>
              <button class="delete-btn delete-swa-btn">
                  <i class="fas fa-trash"></i> Delete
              </button>
          </div>
        `;
        
        container.appendChild(swaElement);
        
        swaElement.querySelector('.edit-swa-btn').addEventListener('click', () => {
            editSWA(swa.id, swa, index + 1);
        });
        
        swaElement.querySelector('.delete-swa-btn').addEventListener('click', () => {
            deleteSWA(swa.id);
        });
    });
}

function getBillingNumberText(number) {
    if (number % 100 >= 11 && number % 100 <= 13) {
        return number + 'th';
    }
    switch (number % 10) {
        case 1: return number + 'st';
        case 2: return number + 'nd';
        case 3: return number + 'rd';
        default: return number + 'th';
    }
}

function editSWA(id, swa, billingNumber) {
    const modalHTML = `
        <div id="editSWAModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <span class="close">&times;</span>
                <h3>Edit ${getBillingNumberText(billingNumber)} Billing</h3>
                
                <div class="form-group">
                    <label for="swaDate">Date:</label>
                    <input type="date" id="swaDate" value="${swa.date ? swa.date.split('T')[0] : ''}">
                </div>
                
                <div class="form-group">
                    <label for="swaBillingType">Billing Type:</label>
                    <select id="swaBillingType" class="form-control">
                        <option value="First Billing" ${swa.billingType === 'First Billing' ? 'selected' : ''}>First Billing</option>
                        <option value="Second Billing" ${swa.billingType === 'Second Billing' ? 'selected' : ''}>Second Billing</option>
                        <option value="Third Billing" ${swa.billingType === 'Third Billing' ? 'selected' : ''}>Third Billing</option>
                        <option value="Fourth Billing" ${swa.billingType === 'Fourth Billing' ? 'selected' : ''}>Fourth Billing</option>
                        <option value="Final" ${swa.billingType === 'Final Billing' ? 'selected' : ''}>Final Billing</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="swaAmount">Amount ():</label>
                    <input type="number" id="swaAmount" step="0.01" min="0" value="${swa.amount || ''}">
                </div>
                
                <div class="form-actions">
                    <button class="cancel-btn" id="cancelEditSWA">Cancel</button>
                    <button class="submit-btn" id="saveEditSWA">Save Changes</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    const modal = document.getElementById('editSWAModal');
    modal.style.display = 'block';
    
    modal.querySelector('.close').addEventListener('click', () => {
        modal.remove();
    });
    
    document.getElementById('cancelEditSWA').addEventListener('click', () => {
        modal.remove();
    });
    
    document.getElementById('saveEditSWA').addEventListener('click', async () => {
        const date = document.getElementById('swaDate').value;
        const billingType = document.getElementById('swaBillingType').value;
        const amount = parseFloat(document.getElementById('swaAmount').value) || 0;
        
        const updateData = {
            date: date || null,
            billingType: billingType,
            amount: amount,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        try {
            // First remove the old entry if billing type changed
            if (billingType !== swa.billingType) {
                await database.ref(`contracts/${currentContractId}/swas/${id}`).remove();
                // Create new entry with new billing type as key
                await database.ref(`contracts/${currentContractId}/swas/${billingType.replace(/\s+/g, '')}`).set(updateData);
            } else {
                // Just update existing entry
                await database.ref(`contracts/${currentContractId}/swas/${id}`).update(updateData);
            }
            
            modal.remove();
        } catch (error) {
            console.error('Error updating billing:', error);
            alert('Error updating billing: ' + error.message);
        }
    });
    
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function addNewSWA() {
    if (!currentContractId) return;
    
    const today = new Date().toISOString().split('T')[0];
    
    // Count existing SWAs to determine billing number
    database.ref(`contracts/${currentContractId}/swas`).once('value').then(snapshot => {
        const count = snapshot.numChildren();
        const billingNumber = count + 1;
        const billingType = 'Regular'; // Default type
        
        const newSWA = {
            date: today,
            billingType: 'Regular', // Display value
            amount: 0,
            billingNumber: billingNumber,
            createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        // Use billing type (without spaces) as the key
        database.ref(`contracts/${currentContractId}/swas/${billingType}`).set(newSWA)
            .then(() => {
                // The realtime listener will update the display
            })
            .catch(error => {
                console.error('Error adding billing:', error);
                alert('Error adding billing: ' + error.message);
            });
    });
}

function deleteSWA(id) {
    if (!currentContractId || !id) return;

    const confirmDelete = confirm("Are you sure you want to delete this billing?");
    if (!confirmDelete) return;

    database.ref(`contracts/${currentContractId}/swas/${id}`)
        .remove()
        .then(() => {
            console.log("Billing deleted successfully.");
        })
        .catch((error) => {
            console.error("Error deleting billing:", error);
            alert("Error deleting billing: " + error.message);
        });
}

// Add event listener for the add SWA button
document.getElementById('addSWABtn')?.addEventListener('click', addNewSWA);

// Add this to your existing JavaScript

// Show/hide scanned status when Design Mix is selected
document.querySelector('.qa-menu-link[data-content="designMix"]').addEventListener('click', function(e) {
    // Show the scanned status radio buttons
    const scannedStatus = this.parentElement.querySelector('.scanned-status');
    if (scannedStatus) {
        scannedStatus.style.display = 'block';
    }
    
    // Load the current scanned status from Firebase
    if (currentContractId) {
        contractsRef.child(currentContractId).child('designMix').once('value').then(snapshot => {
            const data = snapshot.val();
            if (data && data.scanned !== undefined) {
                document.querySelector(`input[name="designMixScanned"][value="${data.scanned ? 'yes' : 'no'}"]`).checked = true;
            }
        });
    }
});

function loadDesignMixScannedStatus() {
    if (!currentContractId) return;
    
    contractsRef.child(currentContractId).child('designMix').once('value').then(snapshot => {
        const data = snapshot.val();
        if (data) {
            // Set the radio button based on stored value
            document.querySelector(`input[name="designMixScanned"][value="${data.scanned || 'no'}"]`).checked = true;
            
            // Show notes if scanned
            if (data.scanned === 'yes') {
                document.getElementById('scannedNotes').style.display = 'block';
                document.getElementById('scannedNotes').innerHTML = `
                    <p><i class="fas fa-check-circle" style="color: #28a745;"></i> Design Mix files have been scanned and verified.</p>
                    ${data.scannedDate ? `<p>Scanned on: ${formatDate(data.scannedDate)}</p>` : ''}
                `;
            } else {
                document.getElementById('scannedNotes').style.display = 'none';
            }
        }
    });
}

// Add event listeners for the radio buttons
document.querySelectorAll('input[name="designMixScanned"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
        if (!currentContractId) return;
        
        const isScanned = e.target.value === 'yes';
        const updateData = {
            scanned: e.target.value,
            scannedDate: isScanned ? new Date().toISOString() : null,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        contractsRef.child(currentContractId).child('designMix').update(updateData)
            .then(() => {
                if (isScanned) {
                    document.getElementById('scannedNotes').style.display = 'block';
                    document.getElementById('scannedNotes').innerHTML = `
                        <p><i class="fas fa-check-circle" style="color: #28a745;"></i> Design Mix files have been scanned and verified.</p>
                        <p>Scanned on: ${new Date().toLocaleDateString()}</p>
                    `;
                } else {
                    document.getElementById('scannedNotes').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error updating design mix scanned status:', error);
            });
    });
});

function loadVariationOrders() {
    if (!currentContractId) return;
    
    contractsRef.child(currentContractId).child('variationOrders').once('value').then(snapshot => {
        const data = snapshot.val() || {};
        
        // Update checkboxes and dates
        for (let i = 1; i <= 4; i++) {
            const voKey = `vo${i}`;
            const checkbox = document.getElementById(`vo${i}`);
            const dateSpan = document.getElementById(`vo${i}Date`);
            const editBtn = document.querySelector(`.edit-vo-date-btn[data-vo="vo${i}"]`);
            
            if (data[voKey] && data[voKey].checked) {
                checkbox.checked = true;
                dateSpan.textContent = data[voKey].date || '';
                editBtn.style.display = 'inline-block';
            } else {
                checkbox.checked = false;
                dateSpan.textContent = '';
                editBtn.style.display = 'none';
            }
        }
    });
}

// Add this date formatting helper function
function formatDate(dateString, format = 'MM/DD/YYYY') {
    if (!dateString) return '';
    
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return '';
    
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    const year = date.getFullYear();
    
    return format
        .replace('MM', month)
        .replace('DD', day)
        .replace('YYYY', year);
}

function setupVariationOrderCheckboxes() {
    for (let i = 1; i <= 4; i++) {
        const checkbox = document.getElementById(`vo${i}`);
        if (checkbox) {
            checkbox.addEventListener('change', function() {
                if (!currentContractId) return;
                
                const voKey = `vo${i}`;
                const isChecked = this.checked;
                const dateSpan = document.getElementById(`${voKey}Date`);
                const editBtn = document.querySelector(`.edit-vo-date-btn[data-vo="${voKey}"]`);
                
                let updateData = {};
                
                if (isChecked) {
                    const today = new Date();
                    const month = (today.getMonth() + 1).toString().padStart(2, '0');
                    const day = today.getDate().toString().padStart(2, '0');
                    const year = today.getFullYear();
                    const formattedDate = `${month}-${day}-${year}`;
                    
                    updateData = {
                        [voKey]: {
                            checked: true,
                            date: formattedDate,
                            updatedAt: firebase.database.ServerValue.TIMESTAMP
                        }
                    };
                    
                    dateSpan.textContent = formattedDate;
                    editBtn.style.display = 'inline-block';
                } else {
                    updateData = { [voKey]: null };
                    dateSpan.textContent = '';
                    editBtn.style.display = 'none';
                }
                
                contractsRef.child(currentContractId).child('variationOrders').update(updateData)
                    .catch(error => {
                        console.error('Error updating variation order:', error);
                        // Revert checkbox if there was an error
                        this.checked = !isChecked;
                    });
            });
        }
    }
    
    // Add event listeners for edit buttons
    document.querySelectorAll('.edit-vo-date-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const voKey = this.getAttribute('data-vo');
            editVODate(voKey);
        });
    });
}

function editVODate(voKey) {
    if (!currentContractId) return;
    
    // Get current date
    contractsRef.child(currentContractId).child('variationOrders').child(voKey).once('value').then(snapshot => {
        const voData = snapshot.val();
        if (!voData) return;
        
        // Create modal
        const modalHTML = `
            <div id="editVODateModal" class="modal">
                <div class="modal-content" style="max-width: 400px;">
                    <span class="close">&times;</span>
                    <h3>Edit ${voKey.toUpperCase()} Date</h3>
                    
                    <div class="form-group">
                        <label for="voDateInput">Date (MM-DD-YYYY):</label>
                        <input type="text" id="voDateInput" placeholder="MM-DD-YYYY" value="${voData.date || ''}">
                    </div>
                    
                    <div class="form-actions">
                        <button class="cancel-btn" id="cancelEditVO">Cancel</button>
                        <button class="submit-btn" id="saveEditVO">Save</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modal = document.getElementById('editVODateModal');
        modal.style.display = 'block';
        
        // Close modal
        modal.querySelector('.close').addEventListener('click', () => {
            modal.remove();
        });
        
        document.getElementById('cancelEditVO').addEventListener('click', () => {
            modal.remove();
        });
        
        // Save changes
        document.getElementById('saveEditVO').addEventListener('click', () => {
            const dateInput = document.getElementById('voDateInput').value;
            
            // Validate date format (MM-DD-YYYY)
            if (!/^\d{2}-\d{2}-\d{4}$/.test(dateInput)) {
                alert('Please enter date in MM-DD-YYYY format');
                return;
            }
            
            const [month, day, year] = dateInput.split('-');
            const dateObj = new Date(`${year}-${month}-${day}`);
            
            if (isNaN(dateObj.getTime())) {
                alert('Invalid date');
                return;
            }
            
            contractsRef.child(currentContractId).child('variationOrders').child(voKey).update({
                checked: true,
                date: dateInput,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            })
            .then(() => {
                // Update the display
                document.getElementById(`${voKey}Date`).textContent = dateInput;
                modal.remove();
            })
            .catch(error => {
                console.error('Error updating VO date:', error);
                alert('Error updating date: ' + error.message);
            });
        });
        
        // Close when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    });
}

function setupQAMenuListeners() {
    document.querySelectorAll('.qa-menu-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const type = this.getAttribute('data-content');
            const name = this.textContent;
            switchDocumentType(type, name);
        });
    });
}

// Call this when the page loads
document.addEventListener('DOMContentLoaded', () => {
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            // Check if user is admin
            database.ref('admins').once('value').then(snapshot => {
                const admins = snapshot.val();
                const isAdmin = admins && admins.includes(user.uid);
                
                // Store admin status in the user object
                user.isAdmin = isAdmin;
                
                // Now load folders
                highlightCurrentPage();
                loadFolders();
                setupQAMenuListeners();
            });
        } else {
            window.location.href = 'index.html';
        }
    });
});


// Initialize Design Mix listeners
function initializeDesignMix() {
    const yesRadio = document.querySelector('input[name="designMixScanned"][value="yes"]');
    const noRadio = document.querySelector('input[name="designMixScanned"][value="no"]');
    
    // Load saved state
    loadDesignMixData();
    
    // Add event listeners
    yesRadio.addEventListener('change', () => {
        if (yesRadio.checked) {
            saveDesignMixStatus(true);
        }
    });
    
    noRadio.addEventListener('change', () => {
        if (noRadio.checked) {
            saveDesignMixStatus(false);
        }
    });
    
    // Edit date button
    document.getElementById('editDesignMixDateBtn').addEventListener('click', editDesignMixDate);
}


// Load Design Mix data from database
function loadDesignMixData() {
    if (!currentContractId) return;
    
    contractsRef.child(currentContractId).child('designMix').once('value').then(snapshot => {
        const data = snapshot.val() || {};
        const yesRadio = document.querySelector('input[name="designMixScanned"][value="yes"]');
        const noRadio = document.querySelector('input[name="designMixScanned"][value="no"]');
        const detailsDiv = document.getElementById('scannedDetails');
        const dateDisplay = document.getElementById('designMixDateDisplay');
        
        if (data.scanned === true) {
            yesRadio.checked = true;
            detailsDiv.style.display = 'block';
            dateDisplay.textContent = data.date || 'No date set';
        } else {
            noRadio.checked = true;
            detailsDiv.style.display = 'none';
        }
    });
}


// Save Design Mix status to database
function saveDesignMixStatus(isScanned) {
    if (!currentContractId) return;
    
    const detailsDiv = document.getElementById('scannedDetails');
    const dateDisplay = document.getElementById('designMixDateDisplay');
    
    let updateData = {
        scanned: isScanned,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    if (isScanned) {
        const today = new Date();
        const month = (today.getMonth() + 1).toString().padStart(2, '0');
        const day = today.getDate().toString().padStart(2, '0');
        const year = today.getFullYear();
        const formattedDate = `${month}-${day}-${year}`;
        
        updateData.date = formattedDate;
        detailsDiv.style.display = 'block';
        dateDisplay.textContent = formattedDate;
    } else {
        detailsDiv.style.display = 'none';
    }
    
    contractsRef.child(currentContractId).child('designMix').update(updateData)
        .catch(error => {
            console.error('Error saving design mix status:', error);
        });
}

// Edit Design Mix date
function editDesignMixDate() {
    if (!currentContractId) return;
    
    // Get current date
    contractsRef.child(currentContractId).child('designMix').once('value').then(snapshot => {
        const designMixData = snapshot.val() || {};
        
        // Create modal
        const modalHTML = `
            <div id="editDesignMixDateModal" class="modal">
                <div class="modal-content" style="max-width: 400px;">
                    <span class="close">&times;</span>
                    <h3>Edit Design Mix Scan Date</h3>
                    
                    <div class="form-group">
                        <label for="designMixDateInput">Date (MM-DD-YYYY):</label>
                        <input type="text" id="designMixDateInput" placeholder="MM-DD-YYYY" value="${designMixData.date || ''}">
                    </div>
                    
                    <div class="form-actions">
                        <button class="cancel-btn" id="cancelEditDesignMixDate">Cancel</button>
                        <button class="submit-btn" id="saveEditDesignMixDate">Save</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modal = document.getElementById('editDesignMixDateModal');
        modal.style.display = 'block';
        
        // Close modal
        modal.querySelector('.close').addEventListener('click', () => {
            modal.remove();
        });
        
        document.getElementById('cancelEditDesignMixDate').addEventListener('click', () => {
            modal.remove();
        });
        
        // Save changes
        document.getElementById('saveEditDesignMixDate').addEventListener('click', () => {
            const dateInput = document.getElementById('designMixDateInput').value;
            
            // Validate date format (MM-DD-YYYY)
            if (!/^\d{2}-\d{2}-\d{4}$/.test(dateInput)) {
                alert('Please enter date in MM-DD-YYYY format');
                return;
            }
            
            const [month, day, year] = dateInput.split('-');
            const dateObj = new Date(`${year}-${month}-${day}`);
            
            if (isNaN(dateObj.getTime())) {
                alert('Invalid date');
                return;
            }
            
            contractsRef.child(currentContractId).child('designMix').update({
                scanned: true,
                date: dateInput,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            })
            .then(() => {
                // Update the display
                document.getElementById('designMixDateDisplay').textContent = dateInput;
                modal.remove();
            })
            .catch(error => {
                console.error('Error updating design mix date:', error);
                alert('Error updating date: ' + error.message);
            });
        });
        
        // Close when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    });
}

function openACPModal() {
    // Only proceed if we're on the correct document type
    if (currentDocumentCategory !== 'asphaltConcretePavement') return;
    
    if (!currentContractId) {
        alert('Please select a contract first');
        return;
    }
    
    // Reset the modal first
    document.getElementById('acpntlDataDisplay').style.display = 'none';
    document.getElementById('acpntlForm').style.display = 'none';
    
    // Load existing data if available
    contractsRef.child(currentContractId).child('acpntl').once('value').then(snapshot => {
        const data = snapshot.val();
        
        if (data) {
            // Show the data display and hide the form
            document.getElementById('acpntlDataDisplay').style.display = 'block';
            populateAcpntlDisplay(data);
        } else {
            // No data exists, show the form for new entry
            document.getElementById('acpntlForm').style.display = 'block';
            document.getElementById('acpntlForm').reset();
            document.getElementById('acpntlReasonGroup').style.display = 'none';
        }
        
        // Show the modal
        document.getElementById('acpntlModal').style.display = 'block';
    });
}

acpntlForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!currentContractId) return;
    
    const acpData = {
        status: document.getElementById('acpntlStatus').value,
        station: document.getElementById('acpntlStation').value,
        volume: parseFloat(document.getElementById('acpntlVolume').value),
        date: document.getElementById('acpntlDate').value,
        jobMix: document.querySelector('input[name="acpntlJobMix"]:checked').value,
        approval: document.querySelector('input[name="acpntlApproval"]:checked').value,
        reason: document.querySelector('input[name="acpntlApproval"]:checked').value === 'disapproved' 
               ? document.getElementById('acpntlReason').value 
               : '',
        updatedAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    // Save to Firebase
    contractsRef.child(currentContractId).child('acpntl').set(acpData)
        .then(() => {
            alert('Data saved successfully!');
            document.getElementById('acpntlModal').style.display = 'none';
            populateAcpntlDisplay(acpData);
        })
        .catch(error => {
            console.error('Error saving ACP data:', error);
            alert('Error saving data: ' + error.message);
        });
});

function populatePersonnelFormFields(personnelData) {
    // Safely set value if element exists
    function setValueIfExists(id, value) {
        const element = document.getElementById(id);
        if (element) element.value = value || '';
    }

    // Set values for each field
    setValueIfExists('personnelNameField', personnelData.name);
    setValueIfExists('personnelPositionField', personnelData.position);
    setValueIfExists('personnelContactField', personnelData.contact);
    // Add more fields as needed
}

function loadTrialMix() {
    if (!currentContractId) return;
    
    const trialMixRef = database.ref(`contracts/${currentContractId}/trialMix`);
    
    trialMixRef.on('value', (snapshot) => {
        const data = snapshot.val();
        trialMixData = data || {};
        renderTrialMix();
    });
}

function renderTrialMix() {
    const container = document.getElementById('trialMixList');
    container.innerHTML = '';
    
    if (!trialMixData || Object.keys(trialMixData).length === 0) {
        container.innerHTML = '<p>No trial mix records found. Add your first one!</p>';
        return;
    }
    
    Object.entries(trialMixData).forEach(([id, trial]) => {
        const trialElement = document.createElement('div');
        trialElement.className = 'trial-mix-item';
        trialElement.dataset.id = id;
        
        // Convert remarks to array of objects if needed
        let remarks = [];
        if (trial.remarks) {
            if (Array.isArray(trial.remarks)) {
                remarks = trial.remarks.map(r => typeof r === 'string' ? 
                    { text: r, date: new Date().toISOString() } : r);
            } else {
                remarks = [{ text: trial.remarks, date: trial.date || new Date().toISOString() }];
            }
        }
        
        const remarksHtml = remarks.length 
            ? remarks.map(remark => `
                <div class="remark-item">
                    <div class="remark-text">${remark.text}</div>
                    <div class="remark-date">${formatRemarkDate(remark.date)}</div>
                </div>
            `).join('')
            : '<div class="remark-item">No remarks</div>';
        
        trialElement.innerHTML = `
            <div class="trial-mix-header">
                <div class="trial-mix-date">Date: ${trial.date || 'No date'}</div>
                <div class="trial-mix-type">${trial.testType || 'No test type'}</div>
            </div>
            
            <div class="trial-mix-details">
                <div class="detail-row">
                    <span class="detail-label">Design Strength:</span>
                    <span>${trial.strength || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Remarks:</span>
                    <div class="remarks-container">${remarksHtml}</div>
                </div>
            </div>
            
            <div class="trial-mix-actions">
                <button class="edit-btn edit-trial-mix-btn">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="delete-btn delete-trial-mix-btn">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        `;
        
        container.appendChild(trialElement);
        
        // Add event listeners
        trialElement.querySelector('.edit-trial-mix-btn').addEventListener('click', () => {
            editTrialMix(id, trial);
        });
        
        trialElement.querySelector('.delete-trial-mix-btn').addEventListener('click', () => {
            deleteTrialMix(id);
        });
    });
}

function formatRemarkDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function addNewTrialMix() {
    if (!currentContractId) return;
    
    const newTrialRef = database.ref(`contracts/${currentContractId}/trialMix`).push();
    const today = new Date().toISOString().split('T')[0];
    
    const newTrial = {
        date: today,
        testType: 'Compressive Test',
        strength: '',
        remarks: [],
        createdAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    newTrialRef.set(newTrial)
        .then(() => {
            editTrialMix(newTrialRef.key, newTrial);
        })
        .catch(error => {
            console.error('Error adding trial mix:', error);
            alert('Error adding trial mix: ' + error.message);
        });
}

function editTrialMix(id, trial) {
    // Convert remarks to array of objects
    let currentRemarks = [];
    if (trial.remarks) {
        if (Array.isArray(trial.remarks)) {
            currentRemarks = trial.remarks.map(r => typeof r === 'string' ? 
                { text: r, date: new Date().toISOString() } : r);
        } else {
            currentRemarks = [{ text: trial.remarks, date: trial.date || new Date().toISOString() }];
        }
    } else {
        currentRemarks = [{ text: '', date: new Date().toISOString() }];
    }

    // Create modal HTML
    const modalHTML = `
        <div id="editTrialMixModal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <span class="close">&times;</span>
                <h3>Edit Trial Mix</h3>
                
                <div class="form-group">
                    <label for="tmDate">Date:</label>
                    <input type="date" id="tmDate" value="${trial.date || ''}">
                </div>
                
                <div class="form-group">
                    <label for="tmTestType">Test Type:</label>
                    <select id="tmTestType" class="form-control">
                        <option value="Compressive Test" ${trial.testType === 'Compressive Test' ? 'selected' : ''}>Compressive Test</option>
                        <option value="Flexural Test" ${trial.testType === 'Flexural Test' ? 'selected' : ''}>Flexural Test</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="tmStrength">Design Strength:</label>
                    <input type="text" id="tmStrength" value="${trial.strength || ''}">
                </div>
                
                <div class="form-group">
                    <label>Remarks:</label>
                    <div id="tmRemarksContainer">
                        ${currentRemarks.map((remark, index) => `
                            <div class="remark-input-group" data-index="${index}">
                                <input type="text" class="remark-input" value="${remark.text}">
                                <span class="remark-date">${formatRemarkDate(remark.date)}</span>
                                <button type="button" class="remove-remark-btn" ${currentRemarks.length <= 1 ? 'disabled' : ''}>
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <button type="button" class="add-remark-btn" id="addRemarkBtn">
                        <i class="fas fa-plus"></i> Add Remark
                    </button>
                </div>
                
                <div class="form-actions">
                    <button class="cancel-btn" id="cancelEditTM">Cancel</button>
                    <button class="submit-btn" id="saveEditTM">Save</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    const modal = document.getElementById('editTrialMixModal');
    modal.style.display = 'block';
    
    // Close modal
    modal.querySelector('.close').addEventListener('click', () => {
        modal.remove();
    });
    
    document.getElementById('cancelEditTM').addEventListener('click', () => {
        modal.remove();
    });
    
    // Add new remark
    document.getElementById('addRemarkBtn').addEventListener('click', () => {
        const container = document.getElementById('tmRemarksContainer');
        const newRemarkHtml = `
            <div class="remark-input-group" data-index="${container.children.length}">
                <input type="text" class="remark-input" value="">
                <span class="remark-date">Just now</span>
                <button type="button" class="remove-remark-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', newRemarkHtml);
        
        // Enable all remove buttons if there's more than one
        if (container.children.length > 1) {
            container.querySelectorAll('.remove-remark-btn').forEach(btn => {
                btn.disabled = false;
            });
        }
    });
    
    // Remove remark
    document.getElementById('tmRemarksContainer').addEventListener('click', (e) => {
        if (e.target.closest('.remove-remark-btn')) {
            const group = e.target.closest('.remark-input-group');
            group.remove();
            
            // Disable remove buttons if only one remains
            const container = document.getElementById('tmRemarksContainer');
            const remainingInputs = container.querySelectorAll('.remark-input-group');
            if (remainingInputs.length === 1) {
                remainingInputs[0].querySelector('.remove-remark-btn').disabled = true;
            }
        }
    });
    
    // Save changes
    document.getElementById('saveEditTM').addEventListener('click', async () => {
        const date = document.getElementById('tmDate').value;
        const testType = document.getElementById('tmTestType').value;
        const strength = document.getElementById('tmStrength').value;
        
        // Collect all remarks with their dates
        const remarks = [];
        document.querySelectorAll('.remark-input-group').forEach(group => {
            const input = group.querySelector('.remark-input');
            const dateText = group.querySelector('.remark-date').textContent;
            
            let date;
            if (dateText === 'Just now') {
                date = new Date().toISOString();
            } else {
                const originalRemark = currentRemarks.find(r => 
                    r.text === input.value.trim() || 
                    formatRemarkDate(r.date) === dateText
                );
                date = originalRemark ? originalRemark.date : new Date().toISOString();
            }
            
            if (input.value.trim()) {
                remarks.push({
                    text: input.value.trim(),
                    date: date
                });
            }
        });
        
        const updateData = {
            date: date,
            testType: testType,
            strength: strength,
            remarks: remarks.length ? remarks : null,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        try {
            await database.ref(`contracts/${currentContractId}/trialMix/${id}`).update(updateData);
            modal.remove();
        } catch (error) {
            console.error('Error updating trial mix:', error);
            alert('Error updating trial mix: ' + error.message);
        }
    });
    
    // Close when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function deleteTrialMix(id) {
    if (!confirm('Are you sure you want to delete this trial mix record?')) return;
    
    database.ref(`contracts/${currentContractId}/trialMix/${id}`).remove()
        .then(() => {
            // The realtime listener will update the display
        })
        .catch(error => {
            console.error('Error deleting trial mix:', error);
            alert('Error deleting trial mix: ' + error.message);
        });
}

// Add event listener for the add button
document.getElementById('addTrialMixBtn')?.addEventListener('click', addNewTrialMix);
    </script>





</html> 

